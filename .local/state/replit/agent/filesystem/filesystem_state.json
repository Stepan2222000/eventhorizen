{"file_contents":{"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","size_bytes":2765},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","size_bytes":7428},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","size_bytes":791},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","size_bytes":261},"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","size_bytes":772},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","size_bytes":4281},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","size_bytes":140},"client/src/pages/movement-history.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { useState } from \"react\";\nimport type { Movement } from \"@shared/schema\";\n\nexport default function MovementHistory() {\n  const [filter, setFilter] = useState(\"\");\n\n  const { data: movements, isLoading } = useQuery({\n    queryKey: [\"/api/movements\"],\n  });\n\n  const filteredMovements = (movements as Movement[] || []).filter(movement =>\n    movement.smart.toLowerCase().includes(filter.toLowerCase()) ||\n    movement.article.toLowerCase().includes(filter.toLowerCase()) ||\n    movement.reason.toLowerCase().includes(filter.toLowerCase()) ||\n    (movement.note && movement.note.toLowerCase().includes(filter.toLowerCase()))\n  );\n\n  const getReasonVariant = (reason: string) => {\n    switch (reason) {\n      case 'purchase': return 'default';\n      case 'sale': return 'secondary';\n      case 'return': return 'outline';\n      case 'adjust': return 'secondary';\n      case 'writeoff': return 'destructive';\n      default: return 'secondary';\n    }\n  };\n\n  const formatDateTime = (dateString: string) => {\n    return new Date(dateString).toLocaleString('ru-RU', {\n      year: 'numeric',\n      month: '2-digit',\n      day: '2-digit',\n      hour: '2-digit',\n      minute: '2-digit',\n      hour12: false,\n    });\n  };\n\n  return (\n    <div className=\"flex-1 overflow-y-auto\">\n      <header className=\"bg-card border-b border-border sticky top-0 z-10\">\n        <div className=\"px-8 py-4\">\n          <h2 className=\"text-2xl font-bold text-foreground\">История движений</h2>\n          <p className=\"text-sm text-muted-foreground mt-1\">Полный аудит всех движений товаров</p>\n        </div>\n      </header>\n\n      <div className=\"p-8\">\n        <Card>\n          <CardHeader>\n            <div className=\"flex items-center justify-between\">\n              <CardTitle>Все движения</CardTitle>\n              <div className=\"relative\">\n                <Input\n                  placeholder=\"Фильтр движений...\"\n                  className=\"w-64 pl-9 text-sm\"\n                  value={filter}\n                  onChange={(e) => setFilter(e.target.value)}\n                  data-testid=\"input-filter-movements\"\n                />\n                <i className=\"fas fa-filter absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground text-xs\"></i>\n              </div>\n            </div>\n          </CardHeader>\n          <CardContent>\n            <div className=\"rounded-md border\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead className=\"w-[140px]\">Дата/Время</TableHead>\n                    <TableHead className=\"w-[130px]\">SMART</TableHead>\n                    <TableHead className=\"w-[150px]\">Артикул</TableHead>\n                    <TableHead className=\"text-right w-[80px]\">Кол-во Δ</TableHead>\n                    <TableHead className=\"w-[100px]\">Причина</TableHead>\n                    <TableHead>Примечание</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {isLoading ? (\n                    [...Array(15)].map((_, i) => (\n                      <TableRow key={i}>\n                        <TableCell><Skeleton className=\"h-4 w-24\" /></TableCell>\n                        <TableCell><Skeleton className=\"h-4 w-20\" /></TableCell>\n                        <TableCell><Skeleton className=\"h-4 w-28\" /></TableCell>\n                        <TableCell><Skeleton className=\"h-4 w-12 ml-auto\" /></TableCell>\n                        <TableCell><Skeleton className=\"h-6 w-16\" /></TableCell>\n                        <TableCell><Skeleton className=\"h-4 w-32\" /></TableCell>\n                      </TableRow>\n                    ))\n                  ) : filteredMovements.length === 0 ? (\n                    <TableRow>\n                      <TableCell colSpan={6} className=\"text-center py-8 text-muted-foreground\">\n                        {filter ? \"Нет совпадений с фильтром\" : \"Нет записанных движений\"}\n                      </TableCell>\n                    </TableRow>\n                  ) : (\n                    filteredMovements.map((movement) => (\n                      <TableRow key={movement.id} className=\"hover:bg-muted/50\">\n                        <TableCell className=\"text-sm font-mono\">\n                          {formatDateTime(movement.createdAt.toString())}\n                        </TableCell>\n                        <TableCell className=\"font-mono font-semibold\">\n                          {movement.smart}\n                        </TableCell>\n                        <TableCell className=\"font-mono\">\n                          {movement.article}\n                        </TableCell>\n                        <TableCell className=\"text-right\">\n                          <span className={`font-mono font-semibold ${\n                            movement.qtyDelta >= 0 ? 'text-success' : 'text-destructive'\n                          }`}>\n                            {movement.qtyDelta >= 0 ? '+' : ''}{movement.qtyDelta}\n                          </span>\n                        </TableCell>\n                        <TableCell>\n                          <Badge variant={getReasonVariant(movement.reason)} className=\"capitalize\">\n                            {movement.reason}\n                          </Badge>\n                        </TableCell>\n                        <TableCell className=\"max-w-xs truncate text-sm text-muted-foreground\">\n                          {movement.note || \"—\"}\n                        </TableCell>\n                      </TableRow>\n                    ))\n                  )}\n                </TableBody>\n              </Table>\n            </div>\n            \n            {!isLoading && (\n              <div className=\"flex items-center justify-between px-2 py-4\">\n                <div className=\"text-sm text-muted-foreground\">\n                  Показано <span className=\"font-semibold text-foreground\">{filteredMovements.length}</span> движений\n                  {filter && <span> (отфильтровано из {(movements as Movement[] || []).length} всего)</span>}\n                </div>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","size_bytes":6725},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","size_bytes":3848},"client/src/App.tsx":{"content":"import { Switch, Route } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { Sidebar } from \"@/components/sidebar\";\nimport Dashboard from \"@/pages/dashboard\";\nimport ArticleSearch from \"@/pages/article-search\";\nimport AddMovement from \"@/pages/add-movement\";\nimport StockLevels from \"@/pages/stock-levels\";\nimport StockDetails from \"@/pages/stock-details\";\nimport MovementHistory from \"@/pages/movement-history\";\nimport SoldItems from \"@/pages/sold-items\";\nimport BulkImport from \"@/pages/bulk-import\";\nimport DbConnections from \"@/pages/db-connections\";\nimport NotFound from \"@/pages/not-found\";\n\nfunction Router() {\n  return (\n    <Switch>\n      <Route path=\"/\" component={Dashboard} />\n      <Route path=\"/search\" component={ArticleSearch} />\n      <Route path=\"/movement\" component={AddMovement} />\n      <Route path=\"/stock/:smart\" component={StockDetails} />\n      <Route path=\"/stock\" component={StockLevels} />\n      <Route path=\"/history\" component={MovementHistory} />\n      <Route path=\"/sold\" component={SoldItems} />\n      <Route path=\"/import\" component={BulkImport} />\n      <Route path=\"/db-connections\" component={DbConnections} />\n      <Route component={NotFound} />\n    </Switch>\n  );\n}\n\nfunction App() {\n  return (\n    <QueryClientProvider client={queryClient}>\n      <TooltipProvider>\n        <div className=\"flex h-screen overflow-hidden\">\n          <Sidebar />\n          <main className=\"flex-1 overflow-hidden\">\n            <Router />\n          </main>\n        </div>\n        <Toaster />\n      </TooltipProvider>\n    </QueryClientProvider>\n  );\n}\n\nexport default App;\n","size_bytes":1785},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    // Try to parse JSON error message\n    let errorMessage = text;\n    try {\n      const json = JSON.parse(text);\n      errorMessage = json.error || json.message || text;\n    } catch {\n      // If JSON parsing fails, keep the original text\n    }\n    throw new Error(errorMessage);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const res = await fetch(url, {\n    method,\n    headers: data ? { \"Content-Type\": \"application/json\" } : {},\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const res = await fetch(queryKey.join(\"/\") as string, {\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: Infinity,\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","size_bytes":1618},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","size_bytes":325},"client/src/components/sidebar.tsx":{"content":"import { Link, useLocation } from \"wouter\";\nimport { cn } from \"@/lib/utils\";\n\nconst navigation = [\n  { name: 'Главная', href: '/', icon: 'fas fa-chart-line' },\n  { name: 'Поиск артикулов', href: '/search', icon: 'fas fa-magnifying-glass' },\n  { name: 'Добавить движение', href: '/movement', icon: 'fas fa-plus-circle' },\n  { name: 'Остатки', href: '/stock', icon: 'fas fa-warehouse' },\n  { name: 'История движений', href: '/history', icon: 'fas fa-clock-rotate-left' },\n  { name: 'Проданные товары', href: '/sold', icon: 'fas fa-shopping-cart' },\n  { name: 'Массовая загрузка', href: '/import', icon: 'fas fa-file-import' },\n  { name: 'Подключения БД', href: '/db-connections', icon: 'fas fa-database' },\n];\n\nexport function Sidebar() {\n  const [location] = useLocation();\n\n  return (\n    <aside className=\"w-64 bg-card border-r border-border flex flex-col\">\n      <div className=\"p-6 border-b border-border\">\n        <div className=\"flex items-center gap-3\">\n          <div className=\"w-10 h-10 bg-primary rounded-lg flex items-center justify-center\">\n            <i className=\"fas fa-boxes-stacked text-white text-lg\"></i>\n          </div>\n          <div>\n            <h1 className=\"text-lg font-bold text-foreground\">SMART Инвентаризация</h1>\n            <p className=\"text-xs text-muted-foreground\">Система учёта</p>\n          </div>\n        </div>\n      </div>\n\n      <nav className=\"flex-1 p-4 space-y-1\">\n        {navigation.map((item) => (\n          <Link \n            key={item.href} \n            href={item.href}\n            className={cn(\n              \"flex items-center gap-3 px-4 py-3 rounded-lg text-sm transition-all duration-200 hover:bg-accent\",\n              location === item.href \n                ? \"bg-primary text-primary-foreground\" \n                : \"text-muted-foreground hover:text-foreground\"\n            )}\n          >\n            <i className={`${item.icon} w-5`}></i>\n            <span>{item.name}</span>\n          </Link>\n        ))}\n      </nav>\n\n      <div className=\"p-4 border-t border-border\">\n        <div className=\"flex items-center gap-3 p-3 rounded-lg bg-muted\">\n          <div className=\"flex gap-2\">\n            <div className=\"w-2 h-2 rounded-full bg-success animate-pulse\"></div>\n            <div className=\"w-2 h-2 rounded-full bg-primary animate-pulse\" style={{animationDelay: '0.2s'}}></div>\n          </div>\n          <div className=\"flex-1 text-xs\">\n            <div className=\"text-muted-foreground\">Статус БД</div>\n            <div className=\"font-medium font-mono text-foreground\">Подключено</div>\n          </div>\n        </div>\n      </div>\n    </aside>\n  );\n}\n","size_bytes":2766},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","size_bytes":1209},"client/src/components/disambiguation-modal.tsx":{"content":"import { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport type { ArticleSearchResult } from \"@shared/schema\";\n\ninterface DisambiguationModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  onSelect: (result: ArticleSearchResult) => void;\n  matches: ArticleSearchResult[];\n  searchQuery: string;\n}\n\nexport function DisambiguationModal({ \n  isOpen, \n  onClose, \n  onSelect, \n  matches, \n  searchQuery \n}: DisambiguationModalProps) {\n  return (\n    <Dialog open={isOpen} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-2xl max-h-[80vh]\">\n        <DialogHeader>\n          <DialogTitle className=\"flex items-center justify-between\">\n            <div>\n              <h3 className=\"text-lg font-semibold text-foreground\">Выберите SMART код</h3>\n              <p className=\"text-sm text-muted-foreground mt-1\">\n                Найдено несколько совпадений для артикула: <span className=\"font-mono font-semibold\">{searchQuery}</span>\n              </p>\n            </div>\n          </DialogTitle>\n        </DialogHeader>\n        \n        <div className=\"overflow-y-auto max-h-[50vh] space-y-2 pr-2\">\n          {matches.map((match) => (\n            <button\n              key={match.smart}\n              onClick={() => onSelect(match)}\n              className=\"w-full text-left p-3 rounded-lg border-2 border-border bg-card hover:border-primary hover:bg-primary/5 transition-all\"\n              data-testid={`select-smart-${match.smart}`}\n            >\n              <div className=\"flex items-start justify-between mb-1\">\n                <div className=\"font-mono font-semibold text-base text-foreground\">{match.smart}</div>\n                {Array.isArray(match.brand) && match.brand.length > 0 && (\n                  <span className=\"inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium bg-muted text-muted-foreground\">\n                    {match.brand.join(', ')}\n                  </span>\n                )}\n              </div>\n              {Array.isArray(match.articles) && match.articles.length > 0 && (\n                <div className=\"text-xs text-muted-foreground mb-1\">\n                  <span className=\"font-semibold\">Артикулы: </span>\n                  <span className=\"font-mono\">{match.articles.join(', ')}</span>\n                </div>\n              )}\n              {Array.isArray(match.description) && match.description.length > 0 && (\n                <div className=\"text-xs text-foreground mb-1\">\n                  <span className=\"font-semibold\">Описание: </span>\n                  {match.description.join(', ')}\n                </div>\n              )}\n              <div className=\"flex gap-4 text-xs text-muted-foreground\">\n                <div>\n                  <span className=\"font-semibold\">Остаток:</span>\n                  <span className=\"font-mono ml-1\">{match.currentStock}</span>\n                </div>\n              </div>\n            </button>\n          ))}\n        </div>\n        \n        <div className=\"border-t border-border pt-4\">\n          <Button variant=\"outline\" onClick={onClose} className=\"w-full\" data-testid=\"button-cancel-disambiguation\">\n            Отмена\n          </Button>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","size_bytes":3376},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","size_bytes":3895},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n          await import(\"@replit/vite-plugin-dev-banner\").then((m) =>\n            m.devBanner(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","size_bytes":1080},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","size_bytes":80},"client/src/components/ui/sidebar.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { VariantProps, cva } from \"class-variance-authority\"\nimport { PanelLeft } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nconst SidebarProvider = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    defaultOpen?: boolean\n    open?: boolean\n    onOpenChange?: (open: boolean) => void\n  }\n>(\n  (\n    {\n      defaultOpen = true,\n      open: openProp,\n      onOpenChange: setOpenProp,\n      className,\n      style,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const isMobile = useIsMobile()\n    const [openMobile, setOpenMobile] = React.useState(false)\n\n    // This is the internal state of the sidebar.\n    // We use openProp and setOpenProp for control from outside the component.\n    const [_open, _setOpen] = React.useState(defaultOpen)\n    const open = openProp ?? _open\n    const setOpen = React.useCallback(\n      (value: boolean | ((value: boolean) => boolean)) => {\n        const openState = typeof value === \"function\" ? value(open) : value\n        if (setOpenProp) {\n          setOpenProp(openState)\n        } else {\n          _setOpen(openState)\n        }\n\n        // This sets the cookie to keep the sidebar state.\n        document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n      },\n      [setOpenProp, open]\n    )\n\n    // Helper to toggle the sidebar.\n    const toggleSidebar = React.useCallback(() => {\n      return isMobile\n        ? setOpenMobile((open) => !open)\n        : setOpen((open) => !open)\n    }, [isMobile, setOpen, setOpenMobile])\n\n    // Adds a keyboard shortcut to toggle the sidebar.\n    React.useEffect(() => {\n      const handleKeyDown = (event: KeyboardEvent) => {\n        if (\n          event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n          (event.metaKey || event.ctrlKey)\n        ) {\n          event.preventDefault()\n          toggleSidebar()\n        }\n      }\n\n      window.addEventListener(\"keydown\", handleKeyDown)\n      return () => window.removeEventListener(\"keydown\", handleKeyDown)\n    }, [toggleSidebar])\n\n    // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n    // This makes it easier to style the sidebar with Tailwind classes.\n    const state = open ? \"expanded\" : \"collapsed\"\n\n    const contextValue = React.useMemo<SidebarContextProps>(\n      () => ({\n        state,\n        open,\n        setOpen,\n        isMobile,\n        openMobile,\n        setOpenMobile,\n        toggleSidebar,\n      }),\n      [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n    )\n\n    return (\n      <SidebarContext.Provider value={contextValue}>\n        <TooltipProvider delayDuration={0}>\n          <div\n            style={\n              {\n                \"--sidebar-width\": SIDEBAR_WIDTH,\n                \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n                ...style,\n              } as React.CSSProperties\n            }\n            className={cn(\n              \"group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar\",\n              className\n            )}\n            ref={ref}\n            {...props}\n          >\n            {children}\n          </div>\n        </TooltipProvider>\n      </SidebarContext.Provider>\n    )\n  }\n)\nSidebarProvider.displayName = \"SidebarProvider\"\n\nconst Sidebar = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    side?: \"left\" | \"right\"\n    variant?: \"sidebar\" | \"floating\" | \"inset\"\n    collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n  }\n>(\n  (\n    {\n      side = \"left\",\n      variant = \"sidebar\",\n      collapsible = \"offcanvas\",\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n    if (collapsible === \"none\") {\n      return (\n        <div\n          className={cn(\n            \"flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground\",\n            className\n          )}\n          ref={ref}\n          {...props}\n        >\n          {children}\n        </div>\n      )\n    }\n\n    if (isMobile) {\n      return (\n        <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n          <SheetContent\n            data-sidebar=\"sidebar\"\n            data-mobile=\"true\"\n            className=\"w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden\"\n            style={\n              {\n                \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n              } as React.CSSProperties\n            }\n            side={side}\n          >\n            <SheetHeader className=\"sr-only\">\n              <SheetTitle>Sidebar</SheetTitle>\n              <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n            </SheetHeader>\n            <div className=\"flex h-full w-full flex-col\">{children}</div>\n          </SheetContent>\n        </Sheet>\n      )\n    }\n\n    return (\n      <div\n        ref={ref}\n        className=\"group peer hidden text-sidebar-foreground md:block\"\n        data-state={state}\n        data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n        data-variant={variant}\n        data-side={side}\n      >\n        {/* This is what handles the sidebar gap on desktop */}\n        <div\n          className={cn(\n            \"relative w-[--sidebar-width] bg-transparent transition-[width] duration-200 ease-linear\",\n            \"group-data-[collapsible=offcanvas]:w-0\",\n            \"group-data-[side=right]:rotate-180\",\n            variant === \"floating\" || variant === \"inset\"\n              ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]\"\n              : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon]\"\n          )}\n        />\n        <div\n          className={cn(\n            \"fixed inset-y-0 z-10 hidden h-svh w-[--sidebar-width] transition-[left,right,width] duration-200 ease-linear md:flex\",\n            side === \"left\"\n              ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n              : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n            // Adjust the padding for floating and inset variants.\n            variant === \"floating\" || variant === \"inset\"\n              ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]\"\n              : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n            className\n          )}\n          {...props}\n        >\n          <div\n            data-sidebar=\"sidebar\"\n            className=\"flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow\"\n          >\n            {children}\n          </div>\n        </div>\n      </div>\n    )\n  }\n)\nSidebar.displayName = \"Sidebar\"\n\nconst SidebarTrigger = React.forwardRef<\n  React.ElementRef<typeof Button>,\n  React.ComponentProps<typeof Button>\n>(({ className, onClick, ...props }, ref) => {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      ref={ref}\n      data-sidebar=\"trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeft />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n})\nSidebarTrigger.displayName = \"SidebarTrigger\"\n\nconst SidebarRail = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\">\n>(({ className, ...props }, ref) => {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <button\n      ref={ref}\n      data-sidebar=\"rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex\",\n        \"[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarRail.displayName = \"SidebarRail\"\n\nconst SidebarInset = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"main\">\n>(({ className, ...props }, ref) => {\n  return (\n    <main\n      ref={ref}\n      className={cn(\n        \"relative flex w-full flex-1 flex-col bg-background\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarInset.displayName = \"SidebarInset\"\n\nconst SidebarInput = React.forwardRef<\n  React.ElementRef<typeof Input>,\n  React.ComponentProps<typeof Input>\n>(({ className, ...props }, ref) => {\n  return (\n    <Input\n      ref={ref}\n      data-sidebar=\"input\"\n      className={cn(\n        \"h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarInput.displayName = \"SidebarInput\"\n\nconst SidebarHeader = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarHeader.displayName = \"SidebarHeader\"\n\nconst SidebarFooter = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarFooter.displayName = \"SidebarFooter\"\n\nconst SidebarSeparator = React.forwardRef<\n  React.ElementRef<typeof Separator>,\n  React.ComponentProps<typeof Separator>\n>(({ className, ...props }, ref) => {\n  return (\n    <Separator\n      ref={ref}\n      data-sidebar=\"separator\"\n      className={cn(\"mx-2 w-auto bg-sidebar-border\", className)}\n      {...props}\n    />\n  )\n})\nSidebarSeparator.displayName = \"SidebarSeparator\"\n\nconst SidebarContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarContent.displayName = \"SidebarContent\"\n\nconst SidebarGroup = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarGroup.displayName = \"SidebarGroup\"\n\nconst SidebarGroupLabel = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & { asChild?: boolean }\n>(({ className, asChild = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarGroupLabel.displayName = \"SidebarGroupLabel\"\n\nconst SidebarGroupAction = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & { asChild?: boolean }\n>(({ className, asChild = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 after:md:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarGroupAction.displayName = \"SidebarGroupAction\"\n\nconst SidebarGroupContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    data-sidebar=\"group-content\"\n    className={cn(\"w-full text-sm\", className)}\n    {...props}\n  />\n))\nSidebarGroupContent.displayName = \"SidebarGroupContent\"\n\nconst SidebarMenu = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    data-sidebar=\"menu\"\n    className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n    {...props}\n  />\n))\nSidebarMenu.displayName = \"SidebarMenu\"\n\nconst SidebarMenuItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    data-sidebar=\"menu-item\"\n    className={cn(\"group/menu-item relative\", className)}\n    {...props}\n  />\n))\nSidebarMenuItem.displayName = \"SidebarMenuItem\"\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:!p-0\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst SidebarMenuButton = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & {\n    asChild?: boolean\n    isActive?: boolean\n    tooltip?: string | React.ComponentProps<typeof TooltipContent>\n  } & VariantProps<typeof sidebarMenuButtonVariants>\n>(\n  (\n    {\n      asChild = false,\n      isActive = false,\n      variant = \"default\",\n      size = \"default\",\n      tooltip,\n      className,\n      ...props\n    },\n    ref\n  ) => {\n    const Comp = asChild ? Slot : \"button\"\n    const { isMobile, state } = useSidebar()\n\n    const button = (\n      <Comp\n        ref={ref}\n        data-sidebar=\"menu-button\"\n        data-size={size}\n        data-active={isActive}\n        className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n        {...props}\n      />\n    )\n\n    if (!tooltip) {\n      return button\n    }\n\n    if (typeof tooltip === \"string\") {\n      tooltip = {\n        children: tooltip,\n      }\n    }\n\n    return (\n      <Tooltip>\n        <TooltipTrigger asChild>{button}</TooltipTrigger>\n        <TooltipContent\n          side=\"right\"\n          align=\"center\"\n          hidden={state !== \"collapsed\" || isMobile}\n          {...tooltip}\n        />\n      </Tooltip>\n    )\n  }\n)\nSidebarMenuButton.displayName = \"SidebarMenuButton\"\n\nconst SidebarMenuAction = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & {\n    asChild?: boolean\n    showOnHover?: boolean\n  }\n>(({ className, asChild = false, showOnHover = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 after:md:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarMenuAction.displayName = \"SidebarMenuAction\"\n\nconst SidebarMenuBadge = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    data-sidebar=\"menu-badge\"\n    className={cn(\n      \"pointer-events-none absolute right-1 flex h-5 min-w-5 select-none items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground\",\n      \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n      \"peer-data-[size=sm]/menu-button:top-1\",\n      \"peer-data-[size=default]/menu-button:top-1.5\",\n      \"peer-data-[size=lg]/menu-button:top-2.5\",\n      \"group-data-[collapsible=icon]:hidden\",\n      className\n    )}\n    {...props}\n  />\n))\nSidebarMenuBadge.displayName = \"SidebarMenuBadge\"\n\nconst SidebarMenuSkeleton = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    showIcon?: boolean\n  }\n>(({ className, showIcon = false, ...props }, ref) => {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[--skeleton-width] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n})\nSidebarMenuSkeleton.displayName = \"SidebarMenuSkeleton\"\n\nconst SidebarMenuSub = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    data-sidebar=\"menu-sub\"\n    className={cn(\n      \"mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5\",\n      \"group-data-[collapsible=icon]:hidden\",\n      className\n    )}\n    {...props}\n  />\n))\nSidebarMenuSub.displayName = \"SidebarMenuSub\"\n\nconst SidebarMenuSubItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ ...props }, ref) => <li ref={ref} {...props} />)\nSidebarMenuSubItem.displayName = \"SidebarMenuSubItem\"\n\nconst SidebarMenuSubButton = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentProps<\"a\"> & {\n    asChild?: boolean\n    size?: \"sm\" | \"md\"\n    isActive?: boolean\n  }\n>(({ asChild = false, size = \"md\", isActive, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarMenuSubButton.displayName = \"SidebarMenuSubButton\"\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","size_bytes":23567},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","size_bytes":3021},"shared/schema.ts":{"content":"import { sql } from \"drizzle-orm\";\nimport { pgTable, pgSchema, text, varchar, integer, timestamp, jsonb, boolean, numeric, serial } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\n\n// Parts Admin Database (Read-Only) - SMART reference (public schema)\nexport const smart = pgTable(\"smart\", {\n  smart: varchar(\"smart\").primaryKey(),\n  articles: jsonb(\"articles\").$type<string[]>().notNull(),\n  name: text(\"name\"),\n  brand: text(\"brand\"),\n  description: text(\"description\"),\n});\n\n// Inventory schema for movement tracking\nexport const inventorySchema = pgSchema(\"inventory\");\n\n// Inventory Database (Read-Write) - Tracking\nexport const reasons = inventorySchema.table(\"reasons\", {\n  code: varchar(\"code\").primaryKey(),\n  title: text(\"title\").notNull(),\n});\n\nexport const shippingMethods = inventorySchema.table(\"shipping_methods\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const movements = inventorySchema.table(\"movements\", {\n  id: integer(\"id\").primaryKey().generatedAlwaysAsIdentity(),\n  smart: varchar(\"smart\").notNull(),\n  article: text(\"article\").notNull(),\n  qtyDelta: integer(\"qty_delta\").notNull(),\n  reason: varchar(\"reason\").notNull(),\n  note: text(\"note\"),\n  \n  // Financial fields\n  purchasePrice: numeric(\"purchase_price\", { precision: 10, scale: 2 }),\n  salePrice: numeric(\"sale_price\", { precision: 10, scale: 2 }),\n  deliveryPrice: numeric(\"delivery_price\", { precision: 10, scale: 2 }),\n  \n  // Warehouse tracking\n  boxNumber: varchar(\"box_number\", { length: 50 }),\n  \n  // Shipping tracking (only for sales)\n  trackNumber: text(\"track_number\"),\n  shippingMethodId: integer(\"shipping_method_id\"),\n  saleStatus: varchar(\"sale_status\", { length: 50 }), // 'awaiting_shipment', 'shipped'\n  \n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\n// Types\nexport type Smart = typeof smart.$inferSelect;\nexport type InsertSmart = typeof smart.$inferInsert;\n\nexport type Reason = typeof reasons.$inferSelect;\nexport type InsertReason = typeof reasons.$inferInsert;\n\nexport type ShippingMethod = typeof shippingMethods.$inferSelect;\nexport type InsertShippingMethod = typeof shippingMethods.$inferInsert;\n\nexport type Movement = typeof movements.$inferSelect;\nexport type InsertMovement = typeof movements.$inferInsert;\n\n// Zod schemas\nexport const insertMovementSchema = z.object({\n  smart: z.string().min(1, \"SMART код обязателен\"),\n  article: z.string().min(1, \"Артикул обязателен\"),\n  qtyDelta: z.number().int().refine((val) => val !== 0, {\n    message: \"Количество не может быть равно 0\",\n  }),\n  reason: z.enum(['purchase', 'sale', 'return', 'writeoff']),\n  note: z.string().optional().nullable(),\n  purchasePrice: z.string().optional().nullable(),\n  salePrice: z.string().optional().nullable(),\n  deliveryPrice: z.string().optional().nullable(),\n  boxNumber: z.string().optional().nullable(),\n  trackNumber: z.string().optional().nullable(),\n  shippingMethodId: z.number().optional().nullable(),\n  saleStatus: z.enum(['awaiting_shipment', 'shipped']).optional().nullable(),\n});\n\nexport const insertReasonSchema = createInsertSchema(reasons);\n\nexport const insertShippingMethodSchema = z.object({\n  name: z.string().min(1, \"Название обязательно\"),\n});\n\n// Stock level type for VIEW (grouped by SMART code only)\nexport type StockLevel = {\n  smart: string;\n  totalQty: number;\n  brand?: string;\n  description?: string;\n  name?: string;\n};\n\n// Search result types\nexport type ArticleSearchResult = {\n  smart: string;\n  articles: string[];\n  brand?: string[];\n  description?: string[];\n  name?: string;\n  currentStock: number;\n};\n\nexport type BulkImportRow = {\n  article: string;\n  qtyDelta: number;\n  reason: string;\n  note?: string;\n  smart?: string;\n};\n\nexport type BulkImportResult = {\n  totalRows: number;\n  imported: number;\n  errors: Array<{\n    row: number;\n    error: string;\n    data: BulkImportRow;\n  }>;\n};\n\n// Database connections table for managing external DB connections\nexport const dbConnections = inventorySchema.table(\"db_connections\", {\n  id: integer(\"id\").primaryKey().generatedAlwaysAsIdentity(),\n  name: varchar(\"name\", { length: 255 }).notNull(),\n  host: varchar(\"host\", { length: 255 }).notNull(),\n  port: integer(\"port\").default(5432).notNull(),\n  database: varchar(\"database\", { length: 255 }).notNull(),\n  username: varchar(\"username\", { length: 255 }).notNull(),\n  password: text(\"password\").notNull(),\n  ssl: varchar(\"ssl\", { length: 50 }),\n  role: varchar(\"role\", { length: 20 }), // 'smart' | 'inventory' | null\n  tableName: varchar(\"table_name\", { length: 255 }),\n  fieldMapping: jsonb(\"field_mapping\"), // JSON object mapping external fields to system fields\n  isActive: boolean(\"is_active\").default(false).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\nexport type DbConnection = typeof dbConnections.$inferSelect;\n\nexport const insertDbConnectionSchema = z.object({\n  name: z.string().min(1, \"Название обязательно\"),\n  host: z.string().min(1, \"Хост обязателен\"),\n  port: z.number().int().positive().default(5432),\n  database: z.string().min(1, \"База данных обязательна\"),\n  username: z.string().min(1, \"Имя пользователя обязательно\"),\n  password: z.string().min(1, \"Пароль обязателен\"),\n  ssl: z.string().optional().nullable(),\n  role: z.enum(['smart', 'inventory']).optional().nullable(),\n  tableName: z.string().optional().nullable(),\n  fieldMapping: z.any().optional().nullable(), // JSON object\n});\n\nexport type InsertDbConnection = z.infer<typeof insertDbConnectionSchema>;\n\nexport type SafeDbConnection = Omit<DbConnection, 'password'>;\n\nexport type DbConnectionTest = {\n  success: boolean;\n  message: string;\n  version?: string;\n};\n\nexport type DbTable = {\n  schema: string;\n  name: string;\n  type: string;\n};\n\nexport type DbTablesResult = {\n  tables: DbTable[];\n  connectionName: string;\n};\n\nexport type ConnectionRole = 'smart' | 'inventory' | null;\n\nexport type SmartFieldMapping = {\n  smart: string;      // field name for SMART code\n  articles: string;   // field name for articles array\n  name?: string;      // optional: field name for product name\n  brand?: string;     // optional: field name for brand\n  description?: string; // optional: field name for description\n};\n\nexport type InventoryFieldMapping = {\n  id: string;         // field name for primary key\n  smart: string;      // field name for SMART code\n  article: string;    // field name for article\n  qtyDelta: string;   // field name for quantity delta\n  reason: string;     // field name for reason\n  note?: string;      // optional: field name for note\n  createdAt: string;  // field name for created timestamp\n};\n\nexport type FieldMapping = SmartFieldMapping | InventoryFieldMapping | null;\n\nexport type ConfigureConnectionPayload = {\n  connectionId: number;\n  role: ConnectionRole;\n  tableName: string;\n  fieldMapping: FieldMapping;\n};\n\nexport type ConfigureConnectionResponse = {\n  success: boolean;\n  connection: SafeDbConnection;\n};\n\nexport type DbColumnsResult = {\n  columns: string[];\n};\n","size_bytes":7349},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","size_bytes":2154},"server/storage.ts":{"content":"import { eq, sql, and, ilike } from \"drizzle-orm\";\nimport { partsDb, inventoryDb } from \"./db\";\nimport { smart, reasons, movements, dbConnections, shippingMethods } from \"@shared/schema\";\nimport type { \n  Smart, \n  Reason, \n  Movement, \n  InsertMovement, \n  StockLevel, \n  ArticleSearchResult,\n  BulkImportRow,\n  BulkImportResult,\n  SafeDbConnection,\n  InsertDbConnection,\n  DbConnectionTest,\n  DbTablesResult,\n  ConfigureConnectionPayload,\n  ConnectionRole,\n  ShippingMethod,\n  InsertShippingMethod\n} from \"@shared/schema\";\nimport { normalizeArticle } from \"@shared/normalization\";\nimport { Pool } from \"pg\";\n\nexport class InsufficientStockError extends Error {\n  constructor(\n    public article: string,\n    public smart: string,\n    public currentStock: number,\n    public requestedQty: number\n  ) {\n    super(`Недостаточно товара на складе. Артикул: ${article}, SMART: ${smart}. Текущий остаток: ${currentStock}, запрошено: ${requestedQty}`);\n    this.name = 'InsufficientStockError';\n  }\n}\n\nexport interface IStorage {\n  // SMART reference operations\n  searchSmart(normalizedArticle: string): Promise<Smart[]>;\n  getSmartByCode(smart: string): Promise<Smart | undefined>;\n  \n  // Movement operations\n  createMovement(movement: InsertMovement): Promise<Movement>;\n  getMovements(limit?: number, offset?: number): Promise<Movement[]>;\n  getMovementById(id: number): Promise<Movement | undefined>;\n  getMovementsBySmartAndArticle(smart: string, article: string): Promise<Movement[]>;\n  getPurchasesBySmart(smart: string): Promise<Movement[]>;\n  updateMovement(id: number, updates: Partial<Pick<Movement, 'purchasePrice' | 'note'>>): Promise<Movement>;\n  updateMovementSaleStatus(id: number, status: 'awaiting_shipment' | 'shipped'): Promise<Movement>;\n  \n  // Stock operations\n  getStockLevels(limit?: number, offset?: number): Promise<StockLevel[]>;\n  getStockBySmartAndArticle(smart: string, article: string): Promise<StockLevel | undefined>;\n  getTotalStockBySmart(smart: string): Promise<number>;\n  getTotalStockBySmartBatch(smartCodes: string[]): Promise<Map<string, number>>;\n  \n  // Reasons\n  getReasons(): Promise<Reason[]>;\n  \n  // Shipping methods\n  getShippingMethods(): Promise<ShippingMethod[]>;\n  createShippingMethod(method: InsertShippingMethod): Promise<ShippingMethod>;\n  deleteShippingMethod(id: number): Promise<void>;\n  \n  // Bulk import\n  processBulkImport(rows: BulkImportRow[]): Promise<BulkImportResult>;\n  \n  // Database connections (password never returned)\n  getDbConnections(): Promise<SafeDbConnection[]>;\n  createDbConnection(connection: InsertDbConnection): Promise<SafeDbConnection>;\n  deleteDbConnection(id: number): Promise<void>;\n  testDbConnection(connection: InsertDbConnection): Promise<DbConnectionTest>;\n  getDbTables(connectionId: number): Promise<DbTablesResult>;\n  configureConnection(payload: ConfigureConnectionPayload): Promise<SafeDbConnection>;\n  getActiveConnection(role: ConnectionRole): Promise<SafeDbConnection | null>;\n  getTableColumns(connectionId: number, tableName: string): Promise<Array<{name: string, type: string}>>;\n  createDefaultConnections(): Promise<void>;\n}\n\nexport class DatabaseStorage implements IStorage {\n  // Helper method to create external DB pool\n  private createExternalPool(conn: any): Pool {\n    return new Pool({\n      host: conn.host,\n      port: conn.port,\n      database: conn.database,\n      user: conn.username,\n      password: conn.password,\n      ssl: conn.ssl ? { rejectUnauthorized: false } : undefined,\n    });\n  }\n\n  async searchSmart(normalizedArticle: string): Promise<Smart[]> {\n    let pool: Pool | null = null;\n    try {\n      // Get active SMART connection\n      const activeConn = await this.getActiveConnection('smart');\n      \n      if (!activeConn) {\n        console.log('No active SMART connection found');\n        return [];\n      }\n      \n      // Get full connection details (including password)\n      const fullConnections = await inventoryDb\n        .select()\n        .from(dbConnections)\n        .where(eq(dbConnections.id, activeConn.id))\n        .limit(1);\n      \n      if (!fullConnections.length) {\n        return [];\n      }\n      \n      const conn = fullConnections[0];\n      const fieldMapping = (conn.fieldMapping as any) || {};\n      \n      // Connect to external DB\n      pool = this.createExternalPool(conn);\n      \n      // Get field names from mapping or use defaults\n      const smartField = fieldMapping.smart || 'smart';\n      const articlesField = fieldMapping.articles || 'articles';\n      const nameField = fieldMapping.name || 'name';\n      const brandField = fieldMapping.brand || 'brand';\n      const descField = fieldMapping.description || 'description';\n      \n      // Parse table name (schema.table or just table)\n      const tableName = conn.tableName || 'public.smart';\n      \n      // Build and execute search query with normalization\n      // Note: Using template literals for identifiers (validated from DB schema)\n      // Supports searching by SMART code OR by article number\n      const query = `\n        SELECT \n          \"${smartField}\" as smart,\n          \"${articlesField}\" as articles,\n          \"${nameField}\" as name,\n          \"${brandField}\" as brand,\n          \"${descField}\" as description\n        FROM ${tableName}\n        WHERE \n          -- Search by SMART code\n          TRANSLATE(\n            UPPER(REGEXP_REPLACE(\"${smartField}\", '[\\\\s\\\\-_./]', '', 'g')),\n            'АВЕКМНОРСТУХЁ',\n            'ABEKMHOPCTYXE'\n          ) LIKE '%' || $1 || '%'\n          OR\n          -- Search by article variants\n          EXISTS (\n            SELECT 1 FROM unnest(\"${articlesField}\") as article\n            WHERE TRANSLATE(\n              UPPER(REGEXP_REPLACE(article, '[\\\\s\\\\-_./]', '', 'g')),\n              'АВЕКМНОРСТУХЁ',\n              'ABEKMHOPCTYXE'\n            ) LIKE '%' || $1 || '%'\n          )\n      `;\n      \n      const result = await pool.query(query, [normalizedArticle]);\n      \n      return result.rows.map((row: any) => ({\n        smart: row.smart,\n        articles: row.articles,\n        name: row.name,\n        brand: row.brand,\n        description: row.description,\n      }));\n    } catch (error) {\n      console.error('Error searching SMART:', error);\n      throw new Error('Failed to search SMART database');\n    } finally {\n      if (pool) {\n        await pool.end();\n      }\n    }\n  }\n\n  async getSmartByCode(smartCode: string): Promise<Smart | undefined> {\n    let pool: Pool | null = null;\n    try {\n      // Get active SMART connection\n      const activeConn = await this.getActiveConnection('smart');\n      \n      if (!activeConn) {\n        console.log('No active SMART connection found');\n        return undefined;\n      }\n      \n      // Get full connection details (including password)\n      const fullConnections = await inventoryDb\n        .select()\n        .from(dbConnections)\n        .where(eq(dbConnections.id, activeConn.id))\n        .limit(1);\n      \n      if (!fullConnections.length) {\n        return undefined;\n      }\n      \n      const conn = fullConnections[0];\n      const fieldMapping = (conn.fieldMapping as any) || {};\n      \n      // Connect to external DB\n      pool = this.createExternalPool(conn);\n      \n      // Get field names from mapping or use defaults\n      const smartField = fieldMapping.smart || 'smart';\n      const articlesField = fieldMapping.articles || 'articles';\n      const nameField = fieldMapping.name || 'name';\n      const brandField = fieldMapping.brand || 'brand';\n      const descField = fieldMapping.description || 'description';\n      \n      // Parse table name (schema.table or just table)\n      const tableName = conn.tableName || 'public.smart';\n      \n      // Build and execute query\n      const query = `\n        SELECT \n          \"${smartField}\" as smart,\n          \"${articlesField}\" as articles,\n          \"${nameField}\" as name,\n          \"${brandField}\" as brand,\n          \"${descField}\" as description\n        FROM ${tableName}\n        WHERE \"${smartField}\" = $1\n        LIMIT 1\n      `;\n      \n      const result = await pool.query(query, [smartCode]);\n      \n      if (result.rows.length === 0) return undefined;\n      \n      return {\n        smart: result.rows[0].smart,\n        articles: result.rows[0].articles,\n        name: result.rows[0].name,\n        brand: result.rows[0].brand,\n        description: result.rows[0].description,\n      };\n    } catch (error) {\n      console.error('Error getting SMART by code:', error);\n      throw new Error('Failed to get SMART code');\n    } finally {\n      if (pool) {\n        await pool.end();\n      }\n    }\n  }\n\n  private async getCurrentStock(pool: Pool, smart: string, article: string): Promise<number> {\n    // Stock is now grouped by SMART code only, not by article\n    // Check total stock for the SMART code regardless of article\n    const result = await pool.query(\n      `SELECT COALESCE(SUM(qty_delta), 0)::int as total_qty\n       FROM inventory.movements\n       WHERE smart = $1`,\n      [smart]\n    );\n    return result.rows[0]?.total_qty || 0;\n  }\n\n  async createMovement(movement: InsertMovement): Promise<Movement> {\n    // Retry logic for serialization failures\n    const maxRetries = 3;\n    let lastError: any;\n    \n    for (let attempt = 0; attempt < maxRetries; attempt++) {\n      try {\n        return await this.createMovementAttempt(movement);\n      } catch (error: any) {\n        // Check if this is a serialization error\n        const isSerializationError = \n          error?.code === '40001' || \n          error?.message?.includes('could not serialize access');\n        \n        if (isSerializationError && attempt < maxRetries - 1) {\n          // Wait before retry with exponential backoff\n          const delayMs = Math.min(100 * Math.pow(2, attempt), 1000);\n          await new Promise(resolve => setTimeout(resolve, delayMs));\n          lastError = error;\n          continue;\n        }\n        \n        // Not a serialization error or retries exhausted\n        throw error;\n      }\n    }\n    \n    // All retries exhausted\n    throw new Error(`Failed to create movement after ${maxRetries} attempts due to concurrent access: ${lastError?.message}`);\n  }\n\n  private async createMovementAttempt(movement: InsertMovement): Promise<Movement> {\n    let pool: Pool | null = null;\n    try {\n      // Verify SMART code exists\n      const smartRecord = await this.getSmartByCode(movement.smart);\n      if (!smartRecord) {\n        throw new Error(`SMART code ${movement.smart} not found in reference database`);\n      }\n\n      // Get active inventory connection\n      const activeConn = await this.getActiveConnection('inventory');\n      \n      if (!activeConn) {\n        throw new Error('No active inventory connection configured');\n      }\n      \n      // Get full connection details (including password)\n      const fullConnections = await inventoryDb\n        .select()\n        .from(dbConnections)\n        .where(eq(dbConnections.id, activeConn.id))\n        .limit(1);\n      \n      if (!fullConnections.length) {\n        throw new Error('Inventory connection not found');\n      }\n      \n      const conn = fullConnections[0];\n      \n      // Connect to external DB\n      pool = this.createExternalPool(conn);\n      \n      // Start transaction with SERIALIZABLE isolation for stock validation\n      // This prevents race conditions where two concurrent transactions both read\n      // the same stock level and both insert, potentially creating negative stock\n      await pool.query('BEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE');\n      \n      try {\n        // Check for duplicate return within transaction to prevent race conditions\n        if (movement.reason === 'return' && movement.note && movement.note.includes('Возврат продажи #')) {\n          const match = movement.note.match(/Возврат продажи #(\\d+)/);\n          if (match) {\n            const saleId = match[1];\n            const duplicateCheck = await pool.query(\n              `SELECT id FROM inventory.movements WHERE reason = 'return' AND note = $1 LIMIT 1`,\n              [`Возврат продажи #${saleId}`]\n            );\n            if (duplicateCheck.rows.length > 0) {\n              throw new Error('Товар уже возвращен на склад');\n            }\n          }\n        }\n        \n        // Get current stock for this article+smart combination\n        const currentStock = await this.getCurrentStock(pool, movement.smart, movement.article);\n        \n        // Validate stock based on operation type\n        const isDecrease = movement.reason === 'sale' || movement.reason === 'writeoff';\n        const isNegativeAdjust = movement.reason === 'adjust' && movement.qtyDelta < 0;\n        \n        if (isDecrease || isNegativeAdjust) {\n          const requestedQty = Math.abs(movement.qtyDelta);\n          \n          if (currentStock < requestedQty) {\n            throw new InsufficientStockError(\n              movement.article,\n              movement.smart,\n              currentStock,\n              requestedQty\n            );\n          }\n        }\n        \n        // Insert movement into external DB with new fields\n        const result = await pool.query(\n          `INSERT INTO inventory.movements (\n            smart, article, qty_delta, reason, note,\n            purchase_price, sale_price, delivery_price,\n            box_number, track_number, shipping_method_id, sale_status,\n            created_at\n          )\n           VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, NOW())\n           RETURNING *`,\n          [\n            movement.smart, \n            movement.article, \n            movement.qtyDelta, \n            movement.reason, \n            movement.note,\n            movement.purchasePrice || null,\n            movement.salePrice || null,\n            movement.deliveryPrice || null,\n            movement.boxNumber || null,\n            movement.trackNumber || null,\n            movement.shippingMethodId || null,\n            movement.saleStatus || null\n          ]\n        );\n        \n        // Commit transaction\n        await pool.query('COMMIT');\n        \n        // Map snake_case to camelCase\n        const row = result.rows[0];\n        return {\n          id: row.id,\n          smart: row.smart,\n          article: row.article,\n          qtyDelta: row.qty_delta,\n          reason: row.reason,\n          note: row.note,\n          purchasePrice: row.purchase_price,\n          salePrice: row.sale_price,\n          deliveryPrice: row.delivery_price,\n          boxNumber: row.box_number,\n          trackNumber: row.track_number,\n          shippingMethodId: row.shipping_method_id,\n          saleStatus: row.sale_status,\n          createdAt: row.created_at,\n        };\n      } catch (txError) {\n        // Rollback transaction on error\n        await pool.query('ROLLBACK');\n        throw txError;\n      }\n    } catch (error) {\n      console.error('Error creating movement:', error);\n      throw error;\n    } finally {\n      if (pool) {\n        await pool.end();\n      }\n    }\n  }\n\n  async getMovements(limit = 50, offset = 0): Promise<Movement[]> {\n    let pool: Pool | null = null;\n    try {\n      // Get active inventory connection\n      const activeConn = await this.getActiveConnection('inventory');\n      \n      if (!activeConn) {\n        console.log('No active inventory connection found');\n        return [];\n      }\n      \n      // Get full connection details (including password)\n      const fullConnections = await inventoryDb\n        .select()\n        .from(dbConnections)\n        .where(eq(dbConnections.id, activeConn.id))\n        .limit(1);\n      \n      if (!fullConnections.length) {\n        return [];\n      }\n      \n      const conn = fullConnections[0];\n      \n      // Connect to external DB\n      pool = this.createExternalPool(conn);\n      \n      // Query movements from external DB\n      const result = await pool.query(\n        `SELECT * FROM inventory.movements \n         ORDER BY created_at DESC \n         LIMIT $1 OFFSET $2`,\n        [limit, offset]\n      );\n      \n      // Map snake_case to camelCase\n      return result.rows.map(row => ({\n        id: row.id,\n        smart: row.smart,\n        article: row.article,\n        qtyDelta: row.qty_delta,\n        reason: row.reason,\n        note: row.note,\n        purchasePrice: row.purchase_price,\n        salePrice: row.sale_price,\n        deliveryPrice: row.delivery_price,\n        boxNumber: row.box_number,\n        trackNumber: row.track_number,\n        shippingMethodId: row.shipping_method_id,\n        saleStatus: row.sale_status,\n        createdAt: row.created_at,\n      }));\n    } catch (error) {\n      console.error('Error getting movements:', error);\n      throw new Error('Failed to get movements');\n    } finally {\n      if (pool) {\n        await pool.end();\n      }\n    }\n  }\n\n  async getMovementById(id: number): Promise<Movement | undefined> {\n    let pool: Pool | null = null;\n    try {\n      // Get active inventory connection\n      const activeConn = await this.getActiveConnection('inventory');\n      \n      if (!activeConn) {\n        return undefined;\n      }\n      \n      // Get full connection details (including password)\n      const fullConnections = await inventoryDb\n        .select()\n        .from(dbConnections)\n        .where(eq(dbConnections.id, activeConn.id))\n        .limit(1);\n      \n      if (!fullConnections.length) {\n        return undefined;\n      }\n      \n      const conn = fullConnections[0];\n      \n      // Connect to external DB\n      pool = this.createExternalPool(conn);\n      \n      // Query movement by ID from external DB\n      const result = await pool.query(\n        `SELECT * FROM inventory.movements WHERE id = $1`,\n        [id]\n      );\n      \n      if (result.rows.length === 0) {\n        return undefined;\n      }\n      \n      const row = result.rows[0];\n      return {\n        id: row.id,\n        smart: row.smart,\n        article: row.article,\n        qtyDelta: row.qty_delta,\n        reason: row.reason,\n        note: row.note,\n        purchasePrice: row.purchase_price,\n        salePrice: row.sale_price,\n        deliveryPrice: row.delivery_price,\n        boxNumber: row.box_number,\n        trackNumber: row.track_number,\n        shippingMethodId: row.shipping_method_id,\n        saleStatus: row.sale_status,\n        createdAt: row.created_at,\n      };\n    } catch (error) {\n      console.error('Error getting movement by ID:', error);\n      throw new Error('Failed to get movement');\n    } finally {\n      if (pool) {\n        await pool.end();\n      }\n    }\n  }\n\n  async getMovementsBySmartAndArticle(smartCode: string, article: string): Promise<Movement[]> {\n    let pool: Pool | null = null;\n    try {\n      // Get active inventory connection\n      const activeConn = await this.getActiveConnection('inventory');\n      \n      if (!activeConn) {\n        return [];\n      }\n      \n      // Get full connection details\n      const fullConnections = await inventoryDb\n        .select()\n        .from(dbConnections)\n        .where(eq(dbConnections.id, activeConn.id))\n        .limit(1);\n      \n      if (!fullConnections.length) {\n        return [];\n      }\n      \n      const conn = fullConnections[0];\n      pool = this.createExternalPool(conn);\n      \n      const result = await pool.query(\n        `SELECT * FROM inventory.movements \n         WHERE smart = $1 AND article = $2\n         ORDER BY created_at DESC`,\n        [smartCode, article]\n      );\n      \n      // Map snake_case to camelCase\n      return result.rows.map(row => ({\n        id: row.id,\n        smart: row.smart,\n        article: row.article,\n        qtyDelta: row.qty_delta,\n        reason: row.reason,\n        note: row.note,\n        purchasePrice: row.purchase_price,\n        salePrice: row.sale_price,\n        deliveryPrice: row.delivery_price,\n        boxNumber: row.box_number,\n        trackNumber: row.track_number,\n        shippingMethodId: row.shipping_method_id,\n        saleStatus: row.sale_status,\n        createdAt: row.created_at,\n      }));\n    } catch (error) {\n      console.error('Error getting movements by SMART and article:', error);\n      throw new Error('Failed to get movements');\n    } finally {\n      if (pool) {\n        await pool.end();\n      }\n    }\n  }\n\n  async getStockLevels(limit = 50, offset = 0): Promise<StockLevel[]> {\n    let pool: Pool | null = null;\n    try {\n      // Get active inventory connection\n      const activeConn = await this.getActiveConnection('inventory');\n      \n      if (!activeConn) {\n        return [];\n      }\n      \n      // Get full connection details\n      const fullConnections = await inventoryDb\n        .select()\n        .from(dbConnections)\n        .where(eq(dbConnections.id, activeConn.id))\n        .limit(1);\n      \n      if (!fullConnections.length) {\n        return [];\n      }\n      \n      const conn = fullConnections[0];\n      pool = this.createExternalPool(conn);\n      \n      // Get stock aggregates from inventory view (grouped by SMART only)\n      const result = await pool.query(\n        `SELECT smart, total_qty\n         FROM inventory.stock\n         ORDER BY smart\n         LIMIT $1 OFFSET $2`,\n        [limit, offset]\n      );\n      \n      // Enrich with SMART reference data from active connection\n      const enriched = await Promise.all(\n        result.rows.map(async (row) => {\n          const smartData = await this.getSmartByCode(row.smart);\n          return {\n            smart: row.smart,\n            totalQty: row.total_qty,\n            brand: smartData?.brand || undefined,\n            description: smartData?.description || undefined,\n            name: smartData?.name || undefined,\n          };\n        })\n      );\n      \n      return enriched;\n    } catch (error) {\n      console.error('Error getting stock levels:', error);\n      throw new Error('Failed to get stock levels');\n    } finally {\n      if (pool) {\n        await pool.end();\n      }\n    }\n  }\n\n  async getStockBySmartAndArticle(smartCode: string, article: string): Promise<StockLevel | undefined> {\n    // Since stock is now grouped by SMART only, just get stock by SMART code\n    // (article parameter is kept for backwards compatibility but not used)\n    return this.getTotalStockBySmart(smartCode).then(totalQty => {\n      if (totalQty === 0) return undefined;\n      return this.getSmartByCode(smartCode).then(smartData => ({\n        smart: smartCode,\n        totalQty,\n        brand: smartData?.brand || undefined,\n        description: smartData?.description || undefined,\n        name: smartData?.name || undefined,\n      }));\n    });\n  }\n\n  async getTotalStockBySmart(smartCode: string): Promise<number> {\n    let pool: Pool | null = null;\n    try {\n      // Get active inventory connection\n      const activeConn = await this.getActiveConnection('inventory');\n      \n      if (!activeConn) {\n        return 0;\n      }\n      \n      // Get full connection details\n      const fullConnections = await inventoryDb\n        .select()\n        .from(dbConnections)\n        .where(eq(dbConnections.id, activeConn.id))\n        .limit(1);\n      \n      if (!fullConnections.length) {\n        return 0;\n      }\n      \n      const conn = fullConnections[0];\n      pool = this.createExternalPool(conn);\n      \n      // View already groups by SMART, so just get the total_qty directly\n      const result = await pool.query(\n        `SELECT total_qty\n         FROM inventory.stock\n         WHERE smart = $1`,\n        [smartCode]\n      );\n      \n      return result.rows[0]?.total_qty || 0;\n    } catch (error) {\n      console.error('Error getting total stock by SMART:', error);\n      throw new Error('Failed to get total stock');\n    } finally {\n      if (pool) {\n        await pool.end();\n      }\n    }\n  }\n\n  async getTotalStockBySmartBatch(smartCodes: string[]): Promise<Map<string, number>> {\n    let pool: Pool | null = null;\n    const stockMap = new Map<string, number>();\n    \n    try {\n      // Return empty map if no codes provided\n      if (!smartCodes || smartCodes.length === 0) {\n        return stockMap;\n      }\n\n      // Get active inventory connection\n      const activeConn = await this.getActiveConnection('inventory');\n      \n      if (!activeConn) {\n        return stockMap;\n      }\n      \n      // Get full connection details\n      const fullConnections = await inventoryDb\n        .select()\n        .from(dbConnections)\n        .where(eq(dbConnections.id, activeConn.id))\n        .limit(1);\n      \n      if (!fullConnections.length) {\n        return stockMap;\n      }\n      \n      const conn = fullConnections[0];\n      pool = this.createExternalPool(conn);\n      \n      // Get stock for all SMART codes in one query\n      const result = await pool.query(\n        `SELECT smart, total_qty\n         FROM inventory.stock\n         WHERE smart = ANY($1)`,\n        [smartCodes]\n      );\n      \n      // Build map from results\n      for (const row of result.rows) {\n        stockMap.set(row.smart, row.total_qty || 0);\n      }\n      \n      // Fill in 0 for codes not found in stock\n      for (const code of smartCodes) {\n        if (!stockMap.has(code)) {\n          stockMap.set(code, 0);\n        }\n      }\n      \n      return stockMap;\n    } catch (error) {\n      console.error('Error getting total stock by SMART batch:', error);\n      // Return partial results or empty map instead of throwing\n      return stockMap;\n    } finally {\n      if (pool) {\n        await pool.end();\n      }\n    }\n  }\n\n  async getReasons(): Promise<Reason[]> {\n    let pool: Pool | null = null;\n    try {\n      // Get active inventory connection\n      const activeConn = await this.getActiveConnection('inventory');\n      \n      if (!activeConn) {\n        return [];\n      }\n      \n      // Get full connection details\n      const fullConnections = await inventoryDb\n        .select()\n        .from(dbConnections)\n        .where(eq(dbConnections.id, activeConn.id))\n        .limit(1);\n      \n      if (!fullConnections.length) {\n        return [];\n      }\n      \n      const conn = fullConnections[0];\n      pool = this.createExternalPool(conn);\n      \n      const result = await pool.query(\n        `SELECT code, title FROM inventory.reasons ORDER BY code`\n      );\n      \n      return result.rows;\n    } catch (error) {\n      console.error('Error getting reasons:', error);\n      throw new Error('Failed to get reasons');\n    } finally {\n      if (pool) {\n        await pool.end();\n      }\n    }\n  }\n\n  async getShippingMethods(): Promise<ShippingMethod[]> {\n    let pool: Pool | null = null;\n    try {\n      const activeConn = await this.getActiveConnection('inventory');\n      \n      if (!activeConn) {\n        return [];\n      }\n      \n      const fullConnections = await inventoryDb\n        .select()\n        .from(dbConnections)\n        .where(eq(dbConnections.id, activeConn.id))\n        .limit(1);\n      \n      if (!fullConnections.length) {\n        return [];\n      }\n      \n      const conn = fullConnections[0];\n      pool = this.createExternalPool(conn);\n      \n      const result = await pool.query(\n        `SELECT id, name, created_at FROM inventory.shipping_methods ORDER BY name`\n      );\n      \n      return result.rows.map(row => ({\n        id: row.id,\n        name: row.name,\n        createdAt: row.created_at,\n      }));\n    } catch (error) {\n      console.error('Error getting shipping methods:', error);\n      throw new Error('Failed to get shipping methods');\n    } finally {\n      if (pool) {\n        await pool.end();\n      }\n    }\n  }\n\n  async createShippingMethod(method: InsertShippingMethod): Promise<ShippingMethod> {\n    let pool: Pool | null = null;\n    try {\n      const activeConn = await this.getActiveConnection('inventory');\n      \n      if (!activeConn) {\n        throw new Error('No active inventory connection configured');\n      }\n      \n      const fullConnections = await inventoryDb\n        .select()\n        .from(dbConnections)\n        .where(eq(dbConnections.id, activeConn.id))\n        .limit(1);\n      \n      if (!fullConnections.length) {\n        throw new Error('Inventory connection not found');\n      }\n      \n      const conn = fullConnections[0];\n      pool = this.createExternalPool(conn);\n      \n      const result = await pool.query(\n        `INSERT INTO inventory.shipping_methods (name) \n         VALUES ($1) \n         RETURNING *`,\n        [method.name]\n      );\n      \n      const row = result.rows[0];\n      return {\n        id: row.id,\n        name: row.name,\n        createdAt: row.created_at,\n      };\n    } catch (error) {\n      console.error('Error creating shipping method:', error);\n      throw error;\n    } finally {\n      if (pool) {\n        await pool.end();\n      }\n    }\n  }\n\n  async deleteShippingMethod(id: number): Promise<void> {\n    let pool: Pool | null = null;\n    try {\n      const activeConn = await this.getActiveConnection('inventory');\n      \n      if (!activeConn) {\n        throw new Error('No active inventory connection configured');\n      }\n      \n      const fullConnections = await inventoryDb\n        .select()\n        .from(dbConnections)\n        .where(eq(dbConnections.id, activeConn.id))\n        .limit(1);\n      \n      if (!fullConnections.length) {\n        throw new Error('Inventory connection not found');\n      }\n      \n      const conn = fullConnections[0];\n      pool = this.createExternalPool(conn);\n      \n      await pool.query(\n        `DELETE FROM inventory.shipping_methods WHERE id = $1`,\n        [id]\n      );\n    } catch (error) {\n      console.error('Error deleting shipping method:', error);\n      throw error;\n    } finally {\n      if (pool) {\n        await pool.end();\n      }\n    }\n  }\n\n  async getPurchasesBySmart(smartCode: string): Promise<Movement[]> {\n    let pool: Pool | null = null;\n    try {\n      const activeConn = await this.getActiveConnection('inventory');\n      \n      if (!activeConn) {\n        return [];\n      }\n      \n      const fullConnections = await inventoryDb\n        .select()\n        .from(dbConnections)\n        .where(eq(dbConnections.id, activeConn.id))\n        .limit(1);\n      \n      if (!fullConnections.length) {\n        return [];\n      }\n      \n      const conn = fullConnections[0];\n      pool = this.createExternalPool(conn);\n      \n      const result = await pool.query(\n        `SELECT * FROM inventory.movements \n         WHERE smart = $1 AND reason = 'purchase'\n         ORDER BY created_at DESC`,\n        [smartCode]\n      );\n      \n      return result.rows.map((row: any) => ({\n        id: row.id,\n        smart: row.smart,\n        article: row.article,\n        qtyDelta: row.qty_delta,\n        reason: row.reason,\n        note: row.note,\n        purchasePrice: row.purchase_price,\n        salePrice: row.sale_price,\n        deliveryPrice: row.delivery_price,\n        boxNumber: row.box_number,\n        trackNumber: row.track_number,\n        shippingMethodId: row.shipping_method_id,\n        saleStatus: row.sale_status,\n        createdAt: row.created_at,\n      }));\n    } catch (error) {\n      console.error('Error getting purchases by SMART:', error);\n      throw new Error('Failed to get purchases');\n    } finally {\n      if (pool) {\n        await pool.end();\n      }\n    }\n  }\n\n  async updateMovement(id: number, updates: Partial<Pick<Movement, 'purchasePrice' | 'note'>>): Promise<Movement> {\n    let pool: Pool | null = null;\n    try {\n      const activeConn = await this.getActiveConnection('inventory');\n      \n      if (!activeConn) {\n        throw new Error('No active inventory connection configured');\n      }\n      \n      const fullConnections = await inventoryDb\n        .select()\n        .from(dbConnections)\n        .where(eq(dbConnections.id, activeConn.id))\n        .limit(1);\n      \n      if (!fullConnections.length) {\n        throw new Error('Inventory connection not found');\n      }\n      \n      const conn = fullConnections[0];\n      pool = this.createExternalPool(conn);\n      \n      const setClauses: string[] = [];\n      const values: any[] = [];\n      let paramIndex = 1;\n      \n      if (updates.purchasePrice !== undefined) {\n        setClauses.push(`purchase_price = $${paramIndex++}`);\n        values.push(updates.purchasePrice);\n      }\n      \n      if (updates.note !== undefined) {\n        setClauses.push(`note = $${paramIndex++}`);\n        values.push(updates.note);\n      }\n      \n      if (setClauses.length === 0) {\n        throw new Error('No fields to update');\n      }\n      \n      values.push(id);\n      \n      const result = await pool.query(\n        `UPDATE inventory.movements \n         SET ${setClauses.join(', ')}\n         WHERE id = $${paramIndex}\n         RETURNING *`,\n        values\n      );\n      \n      if (result.rows.length === 0) {\n        throw new Error('Movement not found');\n      }\n      \n      const row = result.rows[0];\n      return {\n        id: row.id,\n        smart: row.smart,\n        article: row.article,\n        qtyDelta: row.qty_delta,\n        reason: row.reason,\n        note: row.note,\n        purchasePrice: row.purchase_price,\n        salePrice: row.sale_price,\n        deliveryPrice: row.delivery_price,\n        boxNumber: row.box_number,\n        trackNumber: row.track_number,\n        shippingMethodId: row.shipping_method_id,\n        saleStatus: row.sale_status,\n        createdAt: row.created_at,\n      };\n    } catch (error) {\n      console.error('Error updating movement:', error);\n      throw error;\n    } finally {\n      if (pool) {\n        await pool.end();\n      }\n    }\n  }\n\n  async updateMovementSaleStatus(id: number, status: 'awaiting_shipment' | 'shipped'): Promise<Movement> {\n    let pool: Pool | null = null;\n    try {\n      const activeConn = await this.getActiveConnection('inventory');\n      \n      if (!activeConn) {\n        throw new Error('No active inventory connection configured');\n      }\n      \n      const fullConnections = await inventoryDb\n        .select()\n        .from(dbConnections)\n        .where(eq(dbConnections.id, activeConn.id))\n        .limit(1);\n      \n      if (!fullConnections.length) {\n        throw new Error('Inventory connection not found');\n      }\n      \n      const conn = fullConnections[0];\n      pool = this.createExternalPool(conn);\n      \n      const result = await pool.query(\n        `UPDATE inventory.movements \n         SET sale_status = $1 \n         WHERE id = $2 \n         RETURNING *`,\n        [status, id]\n      );\n      \n      if (result.rows.length === 0) {\n        throw new Error('Movement not found');\n      }\n      \n      const row = result.rows[0];\n      return {\n        id: row.id,\n        smart: row.smart,\n        article: row.article,\n        qtyDelta: row.qty_delta,\n        reason: row.reason,\n        note: row.note,\n        purchasePrice: row.purchase_price,\n        salePrice: row.sale_price,\n        deliveryPrice: row.delivery_price,\n        boxNumber: row.box_number,\n        trackNumber: row.track_number,\n        shippingMethodId: row.shipping_method_id,\n        saleStatus: row.sale_status,\n        createdAt: row.created_at,\n      };\n    } catch (error) {\n      console.error('Error updating movement sale status:', error);\n      throw error;\n    } finally {\n      if (pool) {\n        await pool.end();\n      }\n    }\n  }\n\n  async processBulkImport(rows: BulkImportRow[]): Promise<BulkImportResult> {\n    const result: BulkImportResult = {\n      totalRows: rows.length,\n      imported: 0,\n      errors: []\n    };\n\n    for (let i = 0; i < rows.length; i++) {\n      const row = rows[i];\n      try {\n        let smartCode = row.smart;\n        \n        // If no SMART provided, try to find it\n        if (!smartCode) {\n          const normalized = normalizeArticle(row.article);\n          const matches = await this.searchSmart(normalized);\n          \n          if (matches.length === 0) {\n            result.errors.push({\n              row: i + 1,\n              error: `No SMART code found for article: ${row.article}`,\n              data: row\n            });\n            continue;\n          } else if (matches.length > 1) {\n            result.errors.push({\n              row: i + 1,\n              error: `Multiple SMART codes found for article: ${row.article}. Please specify SMART code.`,\n              data: row\n            });\n            continue;\n          }\n          \n          smartCode = matches[0].smart;\n        }\n\n        // Validate reason\n        const validReasons = await this.getReasons();\n        if (!validReasons.find(r => r.code === row.reason)) {\n          result.errors.push({\n            row: i + 1,\n            error: `Invalid reason code: ${row.reason}`,\n            data: row\n          });\n          continue;\n        }\n\n        // Create movement\n        await this.createMovement({\n          smart: smartCode!,\n          article: row.article,\n          qtyDelta: row.qtyDelta,\n          reason: row.reason,\n          note: row.note || null,\n        });\n        \n        result.imported++;\n      } catch (error) {\n        result.errors.push({\n          row: i + 1,\n          error: error instanceof Error ? error.message : 'Unknown error',\n          data: row\n        });\n      }\n    }\n\n    return result;\n  }\n\n  async getDbConnections(): Promise<SafeDbConnection[]> {\n    try {\n      const result = await inventoryDb\n        .select()\n        .from(dbConnections)\n        .orderBy(sql`created_at DESC`);\n      \n      // Remove password from all results\n      return result.map(({ password, ...safe }) => safe);\n    } catch (error) {\n      console.error('Error getting DB connections:', error);\n      throw new Error('Failed to get database connections');\n    }\n  }\n\n  async createDbConnection(connection: InsertDbConnection): Promise<SafeDbConnection> {\n    try {\n      const result = await inventoryDb\n        .insert(dbConnections)\n        .values({\n          ...connection,\n          updatedAt: new Date(),\n        })\n        .returning();\n      \n      // Remove password from response\n      const { password, ...safe } = result[0];\n      return safe;\n    } catch (error) {\n      console.error('Error creating DB connection:', error);\n      throw error;\n    }\n  }\n\n  async deleteDbConnection(id: number): Promise<void> {\n    try {\n      await inventoryDb\n        .delete(dbConnections)\n        .where(eq(dbConnections.id, id));\n    } catch (error) {\n      console.error('Error deleting DB connection:', error);\n      throw new Error('Failed to delete database connection');\n    }\n  }\n\n  async testDbConnection(connection: InsertDbConnection): Promise<DbConnectionTest> {\n    let pool: Pool | null = null;\n    try {\n      // Create pool\n      pool = new Pool({\n        host: connection.host,\n        port: connection.port,\n        database: connection.database,\n        user: connection.username,\n        password: connection.password,\n        ssl: connection.ssl ? { rejectUnauthorized: false } : undefined,\n      });\n      \n      // Try to connect\n      const result = await pool.query('SELECT version()');\n      \n      return {\n        success: true,\n        message: 'Соединение успешно',\n        version: result.rows[0]?.version || 'Unknown',\n      };\n    } catch (error) {\n      console.error('DB connection test error:', error);\n      return {\n        success: false,\n        message: error instanceof Error ? error.message : 'Не удалось подключиться',\n      };\n    } finally {\n      if (pool) {\n        await pool.end();\n      }\n    }\n  }\n\n  async getDbTables(connectionId: number): Promise<DbTablesResult> {\n    let pool: Pool | null = null;\n    try {\n      // Get connection details\n      const connections = await inventoryDb\n        .select()\n        .from(dbConnections)\n        .where(eq(dbConnections.id, connectionId))\n        .limit(1);\n      \n      if (!connections.length) {\n        throw new Error('Connection not found');\n      }\n      \n      const connection = connections[0];\n      \n      // Connect and get tables\n      pool = this.createExternalPool(connection);\n      const result = await pool.query(`\n        SELECT \n          table_schema as schema,\n          table_name as name,\n          table_type as type\n        FROM information_schema.tables \n        WHERE table_schema NOT IN ('pg_catalog', 'information_schema')\n        ORDER BY table_schema, table_name\n      `);\n      \n      return {\n        connectionName: connection.name,\n        tables: result.rows.map((row: any) => ({\n          schema: row.schema,\n          name: row.name,\n          type: row.type,\n        })),\n      };\n    } catch (error) {\n      console.error('Error getting DB tables:', error);\n      throw new Error(error instanceof Error ? error.message : 'Failed to get tables');\n    } finally {\n      if (pool) {\n        await pool.end();\n      }\n    }\n  }\n\n  async configureConnection(payload: ConfigureConnectionPayload): Promise<SafeDbConnection> {\n    try {\n      const { connectionId, role, tableName, fieldMapping } = payload;\n      \n      // Deactivate other connections with the same role\n      if (role) {\n        await inventoryDb\n          .update(dbConnections)\n          .set({ isActive: false })\n          .where(and(\n            eq(dbConnections.role, role),\n            sql`${dbConnections.id} != ${connectionId}`\n          ));\n      }\n      \n      // Update connection configuration\n      const result = await inventoryDb\n        .update(dbConnections)\n        .set({\n          role,\n          tableName,\n          fieldMapping: fieldMapping as any,\n          isActive: role ? true : false,\n          updatedAt: new Date(),\n        })\n        .where(eq(dbConnections.id, connectionId))\n        .returning();\n      \n      if (!result.length) {\n        throw new Error('Connection not found');\n      }\n      \n      const { password, ...safe } = result[0];\n      return safe;\n    } catch (error) {\n      console.error('Error configuring connection:', error);\n      throw new Error(error instanceof Error ? error.message : 'Failed to configure connection');\n    }\n  }\n\n  async getActiveConnection(role: ConnectionRole): Promise<SafeDbConnection | null> {\n    try {\n      if (!role) return null;\n      \n      const result = await inventoryDb\n        .select()\n        .from(dbConnections)\n        .where(and(\n          eq(dbConnections.role, role),\n          eq(dbConnections.isActive, true)\n        ))\n        .limit(1);\n      \n      if (!result.length) return null;\n      \n      const { password, ...safe } = result[0];\n      return safe;\n    } catch (error) {\n      console.error('Error getting active connection:', error);\n      throw new Error('Failed to get active connection');\n    }\n  }\n\n  async getTableColumns(connectionId: number, tableName: string): Promise<Array<{name: string, type: string}>> {\n    let pool: Pool | null = null;\n    try {\n      // Get connection details\n      const connections = await inventoryDb\n        .select()\n        .from(dbConnections)\n        .where(eq(dbConnections.id, connectionId))\n        .limit(1);\n      \n      if (!connections.length) {\n        throw new Error('Connection not found');\n      }\n      \n      const connection = connections[0];\n      \n      // Connect and get columns\n      pool = this.createExternalPool(connection);\n      \n      // Parse schema and table name\n      const [schema, table] = tableName.includes('.') \n        ? tableName.split('.') \n        : ['public', tableName];\n      \n      const result = await pool.query(`\n        SELECT \n          column_name as name,\n          data_type as type\n        FROM information_schema.columns \n        WHERE table_schema = $1 AND table_name = $2\n        ORDER BY ordinal_position\n      `, [schema, table]);\n      \n      return result.rows.map((row: any) => ({\n        name: row.name,\n        type: row.type,\n      }));\n    } catch (error) {\n      console.error('Error getting table columns:', error);\n      throw new Error(error instanceof Error ? error.message : 'Failed to get columns');\n    } finally {\n      if (pool) {\n        await pool.end();\n      }\n    }\n  }\n\n  async createDefaultConnections(): Promise<void> {\n    try {\n      // Check if default connections already exist\n      const existing = await inventoryDb\n        .select()\n        .from(dbConnections)\n        .where(sql`${dbConnections.name} LIKE 'По умолчанию%'`);\n      \n      if (existing.length > 0) {\n        console.log('Default connections already exist, skipping...');\n        return;\n      }\n\n      // External database credentials (parts_admin)\n      const externalHost = '81.30.105.134';\n      const externalPort = 5403;\n      const externalDatabase = 'parts_admin';\n      const externalUsername = 'admin';\n      const externalPassword = 'Password123';\n\n      // Create SMART connection to external database\n      await inventoryDb.insert(dbConnections).values({\n        name: 'По умолчанию (SMART)',\n        host: externalHost,\n        port: externalPort,\n        database: externalDatabase,\n        username: externalUsername,\n        password: externalPassword,\n        role: 'smart',\n        tableName: 'public.smart',\n        fieldMapping: {\n          smart: 'smart',\n          articles: 'артикул',\n          name: 'наименование',\n          brand: 'бренд',\n          description: 'коннект_бренд',\n        } as any,\n        isActive: true,\n        updatedAt: new Date(),\n      });\n\n      // Create Inventory connection to external database\n      await inventoryDb.insert(dbConnections).values({\n        name: 'По умолчанию (Учёт)',\n        host: externalHost,\n        port: externalPort,\n        database: externalDatabase,\n        username: externalUsername,\n        password: externalPassword,\n        role: 'inventory',\n        tableName: 'inventory.movements',\n        fieldMapping: {\n          id: 'id',\n          smart: 'smart',\n          article: 'article',\n          qtyDelta: 'qty_delta',\n          reason: 'reason',\n          note: 'note',\n          createdAt: 'created_at',\n        } as any,\n        isActive: true,\n        updatedAt: new Date(),\n      });\n\n      console.log('Default connections created successfully');\n      \n      // Initialize inventory schema in external database\n      await this.initializeExternalInventoryDb(\n        externalHost,\n        externalPort,\n        externalDatabase,\n        externalUsername,\n        externalPassword\n      );\n    } catch (error) {\n      console.error('Error creating default connections:', error);\n      // Don't throw, just log - this is optional\n    }\n  }\n\n  private async initializeExternalInventoryDb(\n    host: string,\n    port: number,\n    database: string,\n    username: string,\n    password: string\n  ): Promise<void> {\n    let pool: Pool | null = null;\n    try {\n      console.log('Initializing inventory schema in external database...');\n      \n      // Create pool for external database\n      pool = new Pool({\n        host,\n        port,\n        database,\n        user: username,\n        password,\n      });\n      \n      // Create inventory schema\n      await pool.query(`CREATE SCHEMA IF NOT EXISTS inventory`);\n      \n      // Create reasons table\n      await pool.query(`\n        CREATE TABLE IF NOT EXISTS inventory.reasons (\n          code VARCHAR PRIMARY KEY,\n          title TEXT NOT NULL\n        )\n      `);\n      \n      // Insert fixed reasons\n      await pool.query(`\n        INSERT INTO inventory.reasons (code, title) VALUES\n          ('purchase', 'Покупка'),\n          ('sale', 'Продажа'),\n          ('return', 'Возврат'),\n          ('adjust', 'Корректировка'),\n          ('writeoff', 'Списание')\n        ON CONFLICT (code) DO NOTHING\n      `);\n      \n      // Create movements table\n      await pool.query(`\n        CREATE TABLE IF NOT EXISTS inventory.movements (\n          id SERIAL PRIMARY KEY,\n          smart VARCHAR NOT NULL,\n          article TEXT NOT NULL,\n          qty_delta INTEGER NOT NULL,\n          reason VARCHAR NOT NULL,\n          note TEXT,\n          created_at TIMESTAMP DEFAULT NOW() NOT NULL,\n          FOREIGN KEY (reason) REFERENCES inventory.reasons(code)\n        )\n      `);\n      \n      // Create stock VIEW (grouped by SMART code only to aggregate across all articles)\n      await pool.query(`\n        CREATE OR REPLACE VIEW inventory.stock AS\n        SELECT \n          smart,\n          SUM(qty_delta) as total_qty\n        FROM inventory.movements\n        GROUP BY smart\n      `);\n      \n      console.log('External inventory schema initialized successfully');\n    } catch (error) {\n      console.error('Error initializing external inventory schema:', error);\n      // Don't throw - this is optional initialization\n    } finally {\n      // Close pool connection\n      if (pool) {\n        await pool.end();\n      }\n    }\n  }\n}\n\nexport const storage = new DatabaseStorage();\n","size_bytes":48818},"client/src/pages/article-search.tsx":{"content":"import { useState } from \"react\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { DisambiguationModal } from \"@/components/disambiguation-modal\";\nimport type { ArticleSearchResult } from \"@shared/schema\";\n\nexport default function ArticleSearch() {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n  const [searchResults, setSearchResults] = useState<ArticleSearchResult[]>([]);\n  const [selectedResult, setSelectedResult] = useState<ArticleSearchResult | null>(null);\n  const [showDisambiguation, setShowDisambiguation] = useState(false);\n  const [isSearching, setIsSearching] = useState(false);\n  \n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const [, setLocation] = useLocation();\n\n  const searchMutation = useMutation({\n    mutationFn: async (query: string) => {\n      const response = await apiRequest(\"GET\", `/api/articles/search?query=${encodeURIComponent(query)}`);\n      return response.json();\n    },\n    onSuccess: (results: ArticleSearchResult[]) => {\n      setSearchResults(results);\n      setIsSearching(false);\n      \n      if (results.length === 0) {\n        toast({\n          title: \"Совпадений не найдено\",\n          description: `SMART код для артикула не найден: ${searchQuery}`,\n          variant: \"destructive\",\n        });\n      } else if (results.length === 1) {\n        setSelectedResult(results[0]);\n        toast({\n          title: \"Найдено совпадение\",\n          description: `Найден SMART код: ${results[0].smart}`,\n        });\n      } else {\n        setShowDisambiguation(true);\n      }\n    },\n    onError: (error) => {\n      setIsSearching(false);\n      toast({\n        title: \"Ошибка поиска\",\n        description: error instanceof Error ? error.message : \"Не удалось выполнить поиск\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSearch = async (e: React.FormEvent) => {\n    e.preventDefault();\n    if (!searchQuery.trim()) return;\n    \n    setIsSearching(true);\n    setSearchResults([]);\n    setSelectedResult(null);\n    searchMutation.mutate(searchQuery.trim());\n  };\n\n  const handleSelectMatch = (result: ArticleSearchResult) => {\n    setSelectedResult(result);\n    setShowDisambiguation(false);\n    toast({\n      title: \"SMART код выбран\",\n      description: `Выбран: ${result.smart}`,\n    });\n  };\n\n  return (\n    <div className=\"flex-1 overflow-y-auto\">\n      <header className=\"bg-card border-b border-border sticky top-0 z-10\">\n        <div className=\"px-8 py-4\">\n          <h2 className=\"text-2xl font-bold text-foreground\">Поиск артикулов</h2>\n          <p className=\"text-sm text-muted-foreground mt-1\">Поиск SMART кодов по вариантам артикулов</p>\n        </div>\n      </header>\n\n      <div className=\"p-8\">\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n          {/* Search Card */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center justify-between\">\n                <div>\n                  <div className=\"text-lg font-semibold text-foreground\">Поиск артикулов</div>\n                  <CardDescription>Найти SMART код по любому варианту артикула</CardDescription>\n                </div>\n                <i className=\"fas fa-magnifying-glass text-muted-foreground text-xl\"></i>\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <form onSubmit={handleSearch} className=\"space-y-4\">\n                <div>\n                  <label className=\"block text-sm font-medium text-foreground mb-2\">\n                    Код артикула\n                    <span className=\"text-muted-foreground font-normal ml-1\">(любой формат)</span>\n                  </label>\n                  <div className=\"relative\">\n                    <Input\n                      type=\"text\"\n                      placeholder=\"например: ABC-123, АБЦ123, abc.123\"\n                      className=\"font-mono pr-20\"\n                      value={searchQuery}\n                      onChange={(e) => setSearchQuery(e.target.value)}\n                      data-testid=\"input-article-search\"\n                    />\n                    <Button \n                      type=\"submit\" \n                      size=\"sm\"\n                      className=\"absolute right-2 top-1/2 -translate-y-1/2\"\n                      disabled={isSearching || !searchQuery.trim()}\n                      data-testid=\"button-search-article\"\n                    >\n                      {isSearching ? (\n                        <div className=\"w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin\"></div>\n                      ) : (\n                        \"Поиск\"\n                      )}\n                    </Button>\n                  </div>\n                  <p className=\"text-xs text-muted-foreground mt-2\">\n                    <i className=\"fas fa-info-circle mr-1\"></i>\n                    Поддерживаются разные регистры, разделители и кириллица/латиница\n                  </p>\n                </div>\n              </form>\n\n              {/* Search Status */}\n              {isSearching && (\n                <div className=\"border border-border rounded-lg p-4 bg-muted/50 mt-4\">\n                  <div className=\"flex items-center gap-3 mb-3\">\n                    <div className=\"w-5 h-5 border-2 border-primary border-t-transparent rounded-full animate-spin\"></div>\n                    <span className=\"text-sm text-muted-foreground\">Поиск в базе данных...</span>\n                  </div>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n\n          {/* Results Card */}\n          <Card>\n            <CardHeader>\n              <CardTitle>Результаты поиска</CardTitle>\n            </CardHeader>\n            <CardContent>\n              {!selectedResult && searchResults.length === 0 && !isSearching && (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <i className=\"fas fa-search text-4xl mb-4\"></i>\n                  <p>Введите артикул для поиска</p>\n                </div>\n              )}\n\n              {selectedResult && (\n                <div className=\"border border-success/30 rounded-lg p-4 bg-success/5\">\n                  <div className=\"flex items-start justify-between mb-3\">\n                    <div>\n                      <Badge className=\"bg-success text-success-foreground mb-2\">\n                        <i className=\"fas fa-check mr-1\"></i>\n                        Найдено совпадение\n                      </Badge>\n                      <h4 className=\"font-mono font-semibold text-lg text-foreground\">{selectedResult.smart}</h4>\n                    </div>\n                  </div>\n                  <div className=\"space-y-2 text-sm\">\n                    {Array.isArray(selectedResult.articles) && selectedResult.articles.length > 0 && (\n                      <div className=\"flex flex-col gap-1\">\n                        <span className=\"text-muted-foreground\">Артикулы:</span>\n                        <span className=\"font-mono font-medium break-words\">\n                          {selectedResult.articles.join(', ')}\n                        </span>\n                      </div>\n                    )}\n                    {Array.isArray(selectedResult.brand) && selectedResult.brand.length > 0 && (\n                      <div className=\"flex justify-between\">\n                        <span className=\"text-muted-foreground\">Бренд:</span>\n                        <span className=\"font-medium\">{selectedResult.brand.join(', ')}</span>\n                      </div>\n                    )}\n                    {Array.isArray(selectedResult.description) && selectedResult.description.length > 0 && (\n                      <div className=\"flex justify-between\">\n                        <span className=\"text-muted-foreground\">Описание:</span>\n                        <span className=\"font-medium\">{selectedResult.description.join(', ')}</span>\n                      </div>\n                    )}\n                    <div className=\"flex justify-between\">\n                      <span className=\"text-muted-foreground\">Текущий остаток:</span>\n                      <span className=\"font-mono font-semibold text-success\">{selectedResult.currentStock}</span>\n                    </div>\n                  </div>\n                  <div className=\"flex gap-2 mt-4\">\n                    <Button \n                      className=\"flex-1\" \n                      data-testid=\"button-add-movement\"\n                      onClick={() => {\n                        const articleValue = Array.isArray(selectedResult.articles) && selectedResult.articles.length > 0\n                          ? selectedResult.articles.join(', ')\n                          : selectedResult.smart;\n                        const params = new URLSearchParams({\n                          smart: selectedResult.smart,\n                          article: articleValue\n                        });\n                        setLocation(`/movement?${params.toString()}`);\n                      }}\n                    >\n                      <i className=\"fas fa-plus mr-2\"></i>\n                      Добавить движение\n                    </Button>\n                    <Button \n                      variant=\"secondary\" \n                      size=\"icon\" \n                      data-testid=\"button-view-history\"\n                      onClick={() => setLocation('/history')}\n                    >\n                      <i className=\"fas fa-history\"></i>\n                    </Button>\n                  </div>\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n\n      <DisambiguationModal\n        isOpen={showDisambiguation}\n        onClose={() => setShowDisambiguation(false)}\n        onSelect={handleSelectMatch}\n        matches={searchResults}\n        searchQuery={searchQuery}\n      />\n    </div>\n  );\n}\n","size_bytes":10702},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","size_bytes":1077},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","size_bytes":1977},"client/src/pages/db-connections.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { \n  insertDbConnectionSchema, \n  type InsertDbConnection, \n  type SafeDbConnection, \n  type DbConnectionTest, \n  type DbTablesResult,\n  type ConfigureConnectionResponse,\n  type DbColumnsResult,\n  type SmartFieldMapping,\n  type InventoryFieldMapping,\n  type ConnectionRole,\n} from \"@shared/schema\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Database, Trash2, TestTube, Table2, Loader2, Settings, CheckCircle, XCircle, AlertCircle } from \"lucide-react\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\n\nexport default function DbConnections() {\n  const { toast } = useToast();\n  const [testingId, setTestingId] = useState<number | null>(null);\n  const [viewTablesId, setViewTablesId] = useState<number | null>(null);\n  const [configureId, setConfigureId] = useState<number | null>(null);\n  const [selectedRole, setSelectedRole] = useState<ConnectionRole>(null);\n  const [selectedTable, setSelectedTable] = useState<string>(\"\");\n  const [tableColumns, setTableColumns] = useState<string[]>([]);\n  const [fieldMapping, setFieldMapping] = useState<SmartFieldMapping | InventoryFieldMapping | null>(null);\n\n  const { data: connections = [], isLoading } = useQuery<SafeDbConnection[]>({\n    queryKey: [\"/api/db-connections\"],\n  });\n\n  const { data: activeSmartConnection } = useQuery<SafeDbConnection | null>({\n    queryKey: [\"/api/db-connections/active/smart\"],\n  });\n\n  const { data: activeInventoryConnection } = useQuery<SafeDbConnection | null>({\n    queryKey: [\"/api/db-connections/active/inventory\"],\n  });\n\n  const form = useForm<InsertDbConnection>({\n    resolver: zodResolver(insertDbConnectionSchema),\n    defaultValues: {\n      name: \"\",\n      host: \"\",\n      port: 5432,\n      database: \"\",\n      username: \"\",\n      password: \"\",\n      ssl: null,\n    },\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: InsertDbConnection) => {\n      const res = await apiRequest(\"POST\", \"/api/db-connections\", data);\n      return await res.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/db-connections\"] });\n      toast({ description: \"Подключение создано\" });\n      form.reset();\n    },\n    onError: (error: Error) => {\n      toast({ \n        variant: \"destructive\", \n        description: error.message || \"Ошибка создания подключения\" \n      });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: number) => {\n      await apiRequest(\"DELETE\", `/api/db-connections/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/db-connections\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/db-connections/active/smart\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/db-connections/active/inventory\"] });\n      toast({ description: \"Подключение удалено\" });\n    },\n    onError: (error: Error) => {\n      toast({ \n        variant: \"destructive\", \n        description: error.message || \"Ошибка удаления\" \n      });\n    },\n  });\n\n  const testMutation = useMutation({\n    mutationFn: async (data: InsertDbConnection) => {\n      const res = await apiRequest(\"POST\", \"/api/db-connections/test\", data);\n      return await res.json() as DbConnectionTest;\n    },\n    onSuccess: (data) => {\n      if (data.success) {\n        toast({ \n          description: `${data.message}${data.version ? ` (${data.version})` : ''}` \n        });\n      } else {\n        toast({ \n          variant: \"destructive\", \n          description: data.message \n        });\n      }\n    },\n  });\n\n  const tablesMutation = useMutation({\n    mutationFn: async (id: number) => {\n      const res = await apiRequest(\"POST\", `/api/db-connections/${id}/tables`);\n      return await res.json() as DbTablesResult;\n    },\n    onSuccess: (data) => {\n      setViewTablesId(null);\n      toast({ \n        description: `Найдено таблиц: ${data.tables.length}` \n      });\n    },\n  });\n\n  const columnsMutation = useMutation({\n    mutationFn: async ({ id, tableName }: { id: number; tableName: string }) => {\n      const res = await fetch(`/api/db-connections/${id}/columns?tableName=${encodeURIComponent(tableName)}`);\n      if (!res.ok) throw new Error('Failed to fetch columns');\n      return await res.json() as DbColumnsResult;\n    },\n    onSuccess: (data) => {\n      setTableColumns(data.columns);\n      initializeFieldMapping(data.columns);\n    },\n  });\n\n  const configureMutation = useMutation({\n    mutationFn: async (data: { connectionId: number; role: ConnectionRole; tableName: string; fieldMapping: any }) => {\n      const res = await apiRequest(\"POST\", `/api/db-connections/${data.connectionId}/configure`, data);\n      return await res.json() as ConfigureConnectionResponse;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/db-connections\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/db-connections/active/smart\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/db-connections/active/inventory\"] });\n      toast({ description: \"Конфигурация сохранена\" });\n      handleCloseConfigureDialog();\n    },\n    onError: (error: Error) => {\n      toast({ \n        variant: \"destructive\", \n        description: error.message || \"Ошибка настройки подключения\" \n      });\n    },\n  });\n\n  const handleTest = () => {\n    const values = form.getValues();\n    testMutation.mutate(values);\n  };\n\n  const handleViewTables = async (connection: SafeDbConnection) => {\n    setViewTablesId(connection.id);\n    tablesMutation.mutate(connection.id);\n  };\n\n  const handleConfigure = (connection: SafeDbConnection) => {\n    setConfigureId(connection.id);\n    setSelectedRole((connection.role === 'smart' || connection.role === 'inventory') ? connection.role : null);\n    setSelectedTable(connection.tableName || \"\");\n    setFieldMapping(connection.fieldMapping as any || null);\n    setTableColumns([]);\n    \n    // Automatically load tables for this connection\n    tablesMutation.mutate(connection.id);\n  };\n\n  const handleCloseConfigureDialog = () => {\n    setConfigureId(null);\n    setSelectedRole(null);\n    setSelectedTable(\"\");\n    setTableColumns([]);\n    setFieldMapping(null);\n  };\n\n  const handleTableSelect = (tableName: string) => {\n    setSelectedTable(tableName);\n    if (configureId) {\n      columnsMutation.mutate({ id: configureId, tableName });\n    }\n  };\n\n  const initializeFieldMapping = (columns: string[]) => {\n    if (!selectedRole) return;\n\n    if (selectedRole === 'smart') {\n      setFieldMapping({\n        smart: columns.find(c => c.toLowerCase().includes('smart')) || '',\n        articles: columns.find(c => c.toLowerCase().includes('article')) || '',\n        name: columns.find(c => c.toLowerCase() === 'name') || undefined,\n        brand: columns.find(c => c.toLowerCase() === 'brand') || undefined,\n        description: columns.find(c => c.toLowerCase().includes('desc')) || undefined,\n      } as SmartFieldMapping);\n    } else {\n      setFieldMapping({\n        id: columns.find(c => c.toLowerCase() === 'id') || '',\n        smart: columns.find(c => c.toLowerCase().includes('smart')) || '',\n        article: columns.find(c => c.toLowerCase().includes('article')) || '',\n        qtyDelta: columns.find(c => c.toLowerCase().includes('qty') || c.toLowerCase().includes('delta')) || '',\n        reason: columns.find(c => c.toLowerCase().includes('reason')) || '',\n        note: columns.find(c => c.toLowerCase() === 'note') || undefined,\n        createdAt: columns.find(c => c.toLowerCase().includes('created')) || '',\n      } as InventoryFieldMapping);\n    }\n  };\n\n  const handleSaveConfigure = () => {\n    if (!configureId || !selectedRole || !selectedTable || !fieldMapping) {\n      toast({ \n        variant: \"destructive\", \n        description: \"Заполните все обязательные поля\" \n      });\n      return;\n    }\n\n    configureMutation.mutate({\n      connectionId: configureId,\n      role: selectedRole,\n      tableName: selectedTable,\n      fieldMapping,\n    });\n  };\n\n  const updateFieldMapping = (field: string, value: string) => {\n    if (!fieldMapping) return;\n    setFieldMapping({ ...fieldMapping, [field]: value });\n  };\n\n  const configuringConnection = connections.find(c => c.id === configureId);\n\n  return (\n    <div className=\"container mx-auto p-6 space-y-6\">\n      <div className=\"flex items-center gap-3\">\n        <Database className=\"h-8 w-8\" />\n        <div>\n          <h1 className=\"text-3xl font-bold\" data-testid=\"text-page-title\">Подключения БД</h1>\n          <p className=\"text-muted-foreground\" data-testid=\"text-page-description\">\n            Управление подключениями к внешним базам данных PostgreSQL\n          </p>\n        </div>\n      </div>\n\n      {/* Active Connections */}\n      <Card>\n        <CardHeader>\n          <CardTitle data-testid=\"text-active-title\">Активные подключения</CardTitle>\n          <CardDescription data-testid=\"text-active-description\">\n            Текущие активные источники данных для SMART и инвентаря\n          </CardDescription>\n        </CardHeader>\n        <CardContent className=\"space-y-3\">\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n            <div className=\"p-4 border rounded-lg\" data-testid=\"card-active-smart\">\n              <div className=\"flex items-center justify-between mb-2\">\n                <h3 className=\"font-semibold\">SMART Справочник</h3>\n                {activeSmartConnection ? (\n                  <Badge variant=\"default\" data-testid=\"badge-smart-active\">\n                    <CheckCircle className=\"h-3 w-3 mr-1\" />\n                    Активно\n                  </Badge>\n                ) : (\n                  <Badge variant=\"secondary\" data-testid=\"badge-smart-inactive\">\n                    <XCircle className=\"h-3 w-3 mr-1\" />\n                    Не настроено\n                  </Badge>\n                )}\n              </div>\n              {activeSmartConnection ? (\n                <div className=\"text-sm text-muted-foreground\">\n                  <p data-testid=\"text-smart-connection-name\">{activeSmartConnection.name}</p>\n                  <p data-testid=\"text-smart-connection-table\">\n                    Таблица: {activeSmartConnection.tableName}\n                  </p>\n                </div>\n              ) : (\n                <p className=\"text-sm text-muted-foreground\" data-testid=\"text-smart-not-configured\">\n                  Нет активного подключения\n                </p>\n              )}\n            </div>\n\n            <div className=\"p-4 border rounded-lg\" data-testid=\"card-active-inventory\">\n              <div className=\"flex items-center justify-between mb-2\">\n                <h3 className=\"font-semibold\">Инвентарь</h3>\n                {activeInventoryConnection ? (\n                  <Badge variant=\"default\" data-testid=\"badge-inventory-active\">\n                    <CheckCircle className=\"h-3 w-3 mr-1\" />\n                    Активно\n                  </Badge>\n                ) : (\n                  <Badge variant=\"secondary\" data-testid=\"badge-inventory-inactive\">\n                    <XCircle className=\"h-3 w-3 mr-1\" />\n                    Не настроено\n                  </Badge>\n                )}\n              </div>\n              {activeInventoryConnection ? (\n                <div className=\"text-sm text-muted-foreground\">\n                  <p data-testid=\"text-inventory-connection-name\">{activeInventoryConnection.name}</p>\n                  <p data-testid=\"text-inventory-connection-table\">\n                    Таблица: {activeInventoryConnection.tableName}\n                  </p>\n                </div>\n              ) : (\n                <p className=\"text-sm text-muted-foreground\" data-testid=\"text-inventory-not-configured\">\n                  Нет активного подключения\n                </p>\n              )}\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle data-testid=\"text-form-title\">Добавить подключение</CardTitle>\n          <CardDescription data-testid=\"text-form-description\">\n            Настройте параметры подключения к внешней базе данных\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <Form {...form}>\n            <form onSubmit={form.handleSubmit((data) => createMutation.mutate(data))} className=\"space-y-4\">\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <FormField\n                  control={form.control}\n                  name=\"name\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Название</FormLabel>\n                      <FormControl>\n                        <Input placeholder=\"Моя БД\" {...field} data-testid=\"input-name\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"host\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Хост</FormLabel>\n                      <FormControl>\n                        <Input placeholder=\"localhost\" {...field} data-testid=\"input-host\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"port\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Порт</FormLabel>\n                      <FormControl>\n                        <Input \n                          type=\"number\" \n                          {...field} \n                          onChange={(e) => field.onChange(parseInt(e.target.value) || 5432)}\n                          data-testid=\"input-port\"\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"database\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>База данных</FormLabel>\n                      <FormControl>\n                        <Input placeholder=\"my_database\" {...field} data-testid=\"input-database\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"username\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Имя пользователя</FormLabel>\n                      <FormControl>\n                        <Input placeholder=\"postgres\" {...field} data-testid=\"input-username\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"password\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>Пароль</FormLabel>\n                      <FormControl>\n                        <Input type=\"password\" placeholder=\"••••••••\" {...field} data-testid=\"input-password\" />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n\n                <FormField\n                  control={form.control}\n                  name=\"ssl\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>SSL режим</FormLabel>\n                      <Select \n                        onValueChange={field.onChange} \n                        value={field.value || undefined}\n                      >\n                        <FormControl>\n                          <SelectTrigger data-testid=\"select-ssl\">\n                            <SelectValue placeholder=\"Не использовать\" />\n                          </SelectTrigger>\n                        </FormControl>\n                        <SelectContent>\n                          <SelectItem value=\"disable\">Отключен</SelectItem>\n                          <SelectItem value=\"prefer\">Предпочтительно</SelectItem>\n                          <SelectItem value=\"require\">Обязательно</SelectItem>\n                          <SelectItem value=\"verify-ca\">Проверка CA</SelectItem>\n                          <SelectItem value=\"verify-full\">Полная проверка</SelectItem>\n                        </SelectContent>\n                      </Select>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              </div>\n\n              <div className=\"flex gap-2\">\n                <Button \n                  type=\"button\" \n                  variant=\"outline\" \n                  onClick={handleTest}\n                  disabled={testMutation.isPending}\n                  data-testid=\"button-test\"\n                >\n                  {testMutation.isPending ? (\n                    <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                  ) : (\n                    <TestTube className=\"h-4 w-4 mr-2\" />\n                  )}\n                  Тест подключения\n                </Button>\n                <Button \n                  type=\"submit\" \n                  disabled={createMutation.isPending}\n                  data-testid=\"button-create\"\n                >\n                  {createMutation.isPending ? (\n                    <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                  ) : (\n                    <Database className=\"h-4 w-4 mr-2\" />\n                  )}\n                  Сохранить подключение\n                </Button>\n              </div>\n            </form>\n          </Form>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <CardTitle data-testid=\"text-connections-title\">Сохраненные подключения</CardTitle>\n          <CardDescription data-testid=\"text-connections-description\">\n            Список настроенных подключений к базам данных\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"flex justify-center p-8\">\n              <Loader2 className=\"h-8 w-8 animate-spin\" data-testid=\"loader-connections\" />\n            </div>\n          ) : connections.length === 0 ? (\n            <p className=\"text-center text-muted-foreground p-8\" data-testid=\"text-no-connections\">\n              Нет сохраненных подключений\n            </p>\n          ) : (\n            <div className=\"space-y-4\">\n              {connections.map((conn) => (\n                <Card key={conn.id} data-testid={`card-connection-${conn.id}`}>\n                  <CardContent className=\"pt-6\">\n                    <div className=\"flex items-start justify-between\">\n                      <div className=\"space-y-1 flex-1\">\n                        <div className=\"flex items-center gap-2\">\n                          <h3 className=\"font-semibold text-lg\" data-testid={`text-connection-name-${conn.id}`}>\n                            {conn.name}\n                          </h3>\n                          {conn.role && (\n                            <Badge variant={conn.isActive ? \"default\" : \"secondary\"} data-testid={`badge-role-${conn.id}`}>\n                              {conn.role === 'smart' ? 'SMART' : 'Инвентарь'}\n                              {conn.isActive && ' (Активно)'}\n                            </Badge>\n                          )}\n                        </div>\n                        <div className=\"text-sm text-muted-foreground space-y-0.5\">\n                          <p data-testid={`text-connection-host-${conn.id}`}>\n                            <span className=\"font-medium\">Хост:</span> {conn.host}:{conn.port}\n                          </p>\n                          <p data-testid={`text-connection-database-${conn.id}`}>\n                            <span className=\"font-medium\">БД:</span> {conn.database}\n                          </p>\n                          <p data-testid={`text-connection-username-${conn.id}`}>\n                            <span className=\"font-medium\">Пользователь:</span> {conn.username}\n                          </p>\n                          {conn.tableName && (\n                            <p data-testid={`text-connection-table-${conn.id}`}>\n                              <span className=\"font-medium\">Таблица:</span> {conn.tableName}\n                            </p>\n                          )}\n                          {conn.ssl && (\n                            <p data-testid={`text-connection-ssl-${conn.id}`}>\n                              <span className=\"font-medium\">SSL:</span> {conn.ssl}\n                            </p>\n                          )}\n                        </div>\n                      </div>\n                      <div className=\"flex gap-2\">\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => handleConfigure(conn)}\n                          data-testid={`button-configure-${conn.id}`}\n                        >\n                          <Settings className=\"h-4 w-4\" />\n                        </Button>\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => handleViewTables(conn)}\n                          disabled={tablesMutation.isPending && viewTablesId === conn.id}\n                          data-testid={`button-view-tables-${conn.id}`}\n                        >\n                          {tablesMutation.isPending && viewTablesId === conn.id ? (\n                            <Loader2 className=\"h-4 w-4 animate-spin\" />\n                          ) : (\n                            <Table2 className=\"h-4 w-4\" />\n                          )}\n                        </Button>\n                        <Button\n                          variant=\"destructive\"\n                          size=\"sm\"\n                          onClick={() => deleteMutation.mutate(conn.id)}\n                          disabled={deleteMutation.isPending}\n                          data-testid={`button-delete-${conn.id}`}\n                        >\n                          <Trash2 className=\"h-4 w-4\" />\n                        </Button>\n                      </div>\n                    </div>\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Tables Dialog */}\n      <Dialog open={tablesMutation.isSuccess && viewTablesId !== null} onOpenChange={(open) => {\n        if (!open) {\n          setViewTablesId(null);\n          tablesMutation.reset();\n        }\n      }}>\n        <DialogContent className=\"max-w-2xl max-h-[80vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle data-testid=\"text-dialog-title\">\n              Таблицы: {tablesMutation.data?.connectionName}\n            </DialogTitle>\n            <DialogDescription data-testid=\"text-dialog-description\">\n              Список таблиц в базе данных\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-2\">\n            {tablesMutation.data?.tables.map((table, idx) => (\n              <div \n                key={`${table.schema}.${table.name}`} \n                className=\"flex items-center justify-between p-3 border rounded-lg\"\n                data-testid={`table-item-${idx}`}\n              >\n                <div className=\"flex-1\">\n                  <p className=\"font-medium\" data-testid={`text-table-name-${idx}`}>\n                    {table.schema}.{table.name}\n                  </p>\n                  <p className=\"text-sm text-muted-foreground\" data-testid={`text-table-type-${idx}`}>\n                    {table.type}\n                  </p>\n                </div>\n              </div>\n            ))}\n            {tablesMutation.data?.tables.length === 0 && (\n              <p className=\"text-center text-muted-foreground p-8\" data-testid=\"text-no-tables\">\n                Таблицы не найдены\n              </p>\n            )}\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* Configure Dialog */}\n      <Dialog open={configureId !== null} onOpenChange={(open) => {\n        if (!open) handleCloseConfigureDialog();\n      }}>\n        <DialogContent className=\"max-w-3xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle data-testid=\"text-configure-title\">\n              Настройка подключения: {configuringConnection?.name}\n            </DialogTitle>\n            <DialogDescription data-testid=\"text-configure-description\">\n              Назначьте роль, выберите таблицу и настройте маппинг полей\n            </DialogDescription>\n          </DialogHeader>\n          \n          <div className=\"space-y-6\">\n            {/* Step 1: Role Selection */}\n            <div className=\"space-y-3\">\n              <label className=\"text-sm font-medium\">Шаг 1: Выберите роль подключения</label>\n              <Select value={selectedRole || undefined} onValueChange={(value) => setSelectedRole((value === 'smart' || value === 'inventory') ? value : null)}>\n                <SelectTrigger data-testid=\"select-role\">\n                  <SelectValue placeholder=\"Выберите роль\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"smart\">SMART Справочник</SelectItem>\n                  <SelectItem value=\"inventory\">Инвентарь</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            {/* Step 2: Table Selection */}\n            {selectedRole && tablesMutation.data && (\n              <div className=\"space-y-3\">\n                <label className=\"text-sm font-medium\">Шаг 2: Выберите таблицу</label>\n                <Select value={selectedTable} onValueChange={handleTableSelect}>\n                  <SelectTrigger data-testid=\"select-table\">\n                    <SelectValue placeholder=\"Выберите таблицу\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {tablesMutation.data.tables.map((table) => (\n                      <SelectItem \n                        key={`${table.schema}.${table.name}`} \n                        value={`${table.schema}.${table.name}`}\n                      >\n                        {table.schema}.{table.name} ({table.type})\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n                {!tablesMutation.data.tables.length && (\n                  <Alert>\n                    <AlertCircle className=\"h-4 w-4\" />\n                    <AlertDescription>\n                      Сначала загрузите список таблиц нажав кнопку \"Просмотр таблиц\"\n                    </AlertDescription>\n                  </Alert>\n                )}\n              </div>\n            )}\n\n            {/* Step 3: Field Mapping */}\n            {selectedTable && tableColumns.length > 0 && fieldMapping && (\n              <div className=\"space-y-3\">\n                <label className=\"text-sm font-medium\">Шаг 3: Сопоставьте поля</label>\n                <div className=\"border rounded-lg p-4 space-y-3\">\n                  {selectedRole === 'smart' ? (\n                    <>\n                      <div className=\"grid grid-cols-2 gap-2 items-center\">\n                        <label className=\"text-sm\">SMART код (обязательно):</label>\n                        <Select \n                          value={(fieldMapping as SmartFieldMapping).smart} \n                          onValueChange={(v) => updateFieldMapping('smart', v)}\n                        >\n                          <SelectTrigger data-testid=\"select-field-smart\">\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {tableColumns.map(col => (\n                              <SelectItem key={col} value={col}>{col}</SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </div>\n                      <div className=\"grid grid-cols-2 gap-2 items-center\">\n                        <label className=\"text-sm\">Артикулы (обязательно):</label>\n                        <Select \n                          value={(fieldMapping as SmartFieldMapping).articles} \n                          onValueChange={(v) => updateFieldMapping('articles', v)}\n                        >\n                          <SelectTrigger data-testid=\"select-field-articles\">\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {tableColumns.map(col => (\n                              <SelectItem key={col} value={col}>{col}</SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </div>\n                      <div className=\"grid grid-cols-2 gap-2 items-center\">\n                        <label className=\"text-sm\">Название (опционально):</label>\n                        <Select \n                          value={(fieldMapping as SmartFieldMapping).name || ''} \n                          onValueChange={(v) => updateFieldMapping('name', v)}\n                        >\n                          <SelectTrigger data-testid=\"select-field-name\">\n                            <SelectValue placeholder=\"Не выбрано\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"\">Не выбрано</SelectItem>\n                            {tableColumns.map(col => (\n                              <SelectItem key={col} value={col}>{col}</SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </div>\n                      <div className=\"grid grid-cols-2 gap-2 items-center\">\n                        <label className=\"text-sm\">Бренд (опционально):</label>\n                        <Select \n                          value={(fieldMapping as SmartFieldMapping).brand || ''} \n                          onValueChange={(v) => updateFieldMapping('brand', v)}\n                        >\n                          <SelectTrigger data-testid=\"select-field-brand\">\n                            <SelectValue placeholder=\"Не выбрано\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"\">Не выбрано</SelectItem>\n                            {tableColumns.map(col => (\n                              <SelectItem key={col} value={col}>{col}</SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </div>\n                      <div className=\"grid grid-cols-2 gap-2 items-center\">\n                        <label className=\"text-sm\">Описание (опционально):</label>\n                        <Select \n                          value={(fieldMapping as SmartFieldMapping).description || ''} \n                          onValueChange={(v) => updateFieldMapping('description', v)}\n                        >\n                          <SelectTrigger data-testid=\"select-field-description\">\n                            <SelectValue placeholder=\"Не выбрано\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"\">Не выбрано</SelectItem>\n                            {tableColumns.map(col => (\n                              <SelectItem key={col} value={col}>{col}</SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </div>\n                    </>\n                  ) : (\n                    <>\n                      <div className=\"grid grid-cols-2 gap-2 items-center\">\n                        <label className=\"text-sm\">ID (обязательно):</label>\n                        <Select \n                          value={(fieldMapping as InventoryFieldMapping).id} \n                          onValueChange={(v) => updateFieldMapping('id', v)}\n                        >\n                          <SelectTrigger data-testid=\"select-field-id\">\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {tableColumns.map(col => (\n                              <SelectItem key={col} value={col}>{col}</SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </div>\n                      <div className=\"grid grid-cols-2 gap-2 items-center\">\n                        <label className=\"text-sm\">SMART код (обязательно):</label>\n                        <Select \n                          value={(fieldMapping as InventoryFieldMapping).smart} \n                          onValueChange={(v) => updateFieldMapping('smart', v)}\n                        >\n                          <SelectTrigger data-testid=\"select-field-smart\">\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {tableColumns.map(col => (\n                              <SelectItem key={col} value={col}>{col}</SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </div>\n                      <div className=\"grid grid-cols-2 gap-2 items-center\">\n                        <label className=\"text-sm\">Артикул (обязательно):</label>\n                        <Select \n                          value={(fieldMapping as InventoryFieldMapping).article} \n                          onValueChange={(v) => updateFieldMapping('article', v)}\n                        >\n                          <SelectTrigger data-testid=\"select-field-article\">\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {tableColumns.map(col => (\n                              <SelectItem key={col} value={col}>{col}</SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </div>\n                      <div className=\"grid grid-cols-2 gap-2 items-center\">\n                        <label className=\"text-sm\">Изменение кол-ва (обязательно):</label>\n                        <Select \n                          value={(fieldMapping as InventoryFieldMapping).qtyDelta} \n                          onValueChange={(v) => updateFieldMapping('qtyDelta', v)}\n                        >\n                          <SelectTrigger data-testid=\"select-field-qty-delta\">\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {tableColumns.map(col => (\n                              <SelectItem key={col} value={col}>{col}</SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </div>\n                      <div className=\"grid grid-cols-2 gap-2 items-center\">\n                        <label className=\"text-sm\">Причина (обязательно):</label>\n                        <Select \n                          value={(fieldMapping as InventoryFieldMapping).reason} \n                          onValueChange={(v) => updateFieldMapping('reason', v)}\n                        >\n                          <SelectTrigger data-testid=\"select-field-reason\">\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {tableColumns.map(col => (\n                              <SelectItem key={col} value={col}>{col}</SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </div>\n                      <div className=\"grid grid-cols-2 gap-2 items-center\">\n                        <label className=\"text-sm\">Примечание (опционально):</label>\n                        <Select \n                          value={(fieldMapping as InventoryFieldMapping).note || ''} \n                          onValueChange={(v) => updateFieldMapping('note', v)}\n                        >\n                          <SelectTrigger data-testid=\"select-field-note\">\n                            <SelectValue placeholder=\"Не выбрано\" />\n                          </SelectTrigger>\n                          <SelectContent>\n                            <SelectItem value=\"\">Не выбрано</SelectItem>\n                            {tableColumns.map(col => (\n                              <SelectItem key={col} value={col}>{col}</SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </div>\n                      <div className=\"grid grid-cols-2 gap-2 items-center\">\n                        <label className=\"text-sm\">Дата создания (обязательно):</label>\n                        <Select \n                          value={(fieldMapping as InventoryFieldMapping).createdAt} \n                          onValueChange={(v) => updateFieldMapping('createdAt', v)}\n                        >\n                          <SelectTrigger data-testid=\"select-field-created-at\">\n                            <SelectValue />\n                          </SelectTrigger>\n                          <SelectContent>\n                            {tableColumns.map(col => (\n                              <SelectItem key={col} value={col}>{col}</SelectItem>\n                            ))}\n                          </SelectContent>\n                        </Select>\n                      </div>\n                    </>\n                  )}\n                </div>\n              </div>\n            )}\n\n            <div className=\"flex justify-end gap-2 pt-4\">\n              <Button \n                variant=\"outline\" \n                onClick={handleCloseConfigureDialog}\n                data-testid=\"button-cancel-configure\"\n              >\n                Отмена\n              </Button>\n              <Button \n                onClick={handleSaveConfigure}\n                disabled={configureMutation.isPending || !selectedRole || !selectedTable || !fieldMapping}\n                data-testid=\"button-save-configure\"\n              >\n                {configureMutation.isPending ? (\n                  <Loader2 className=\"h-4 w-4 mr-2 animate-spin\" />\n                ) : (\n                  <Settings className=\"h-4 w-4 mr-2\" />\n                )}\n                Сохранить конфигурацию\n              </Button>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","size_bytes":41631},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","size_bytes":689},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","size_bytes":1642},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","size_bytes":2751},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport { registerRoutes } from \"./routes\";\nimport { setupVite, serveStatic, log } from \"./vite\";\n\nconst app = express();\n\ndeclare module 'http' {\n  interface IncomingMessage {\n    rawBody: unknown\n  }\n}\napp.use(express.json({\n  verify: (req, _res, buf) => {\n    req.rawBody = buf;\n  }\n}));\napp.use(express.urlencoded({ extended: false }));\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"…\";\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  const server = await registerRoutes(app);\n\n  app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n    const status = err.status || err.statusCode || 500;\n    const message = err.message || \"Internal Server Error\";\n\n    res.status(status).json({ message });\n    throw err;\n  });\n\n  // importantly only setup vite in development and after\n  // setting up all the other routes so the catch-all route\n  // doesn't interfere with the other routes\n  if (app.get(\"env\") === \"development\") {\n    await setupVite(app, server);\n  } else {\n    serveStatic(app);\n  }\n\n  // ALWAYS serve the app on the port specified in the environment variable PORT\n  // Other ports are firewalled. Default to 5000 if not specified.\n  // this serves both the API and the client.\n  // It is the only port that is not firewalled.\n  const port = parseInt(process.env.PORT || '5000', 10);\n  server.listen({\n    port,\n    host: \"0.0.0.0\",\n    reusePort: true,\n  }, () => {\n    log(`serving on port ${port}`);\n  });\n})();\n","size_bytes":2210},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","size_bytes":1056},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","size_bytes":1753},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","size_bytes":791},"server/routes.ts":{"content":"import type { Express } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport { storage, InsufficientStockError } from \"./storage\";\nimport { initializeInventoryDb, ensureExternalDbSchema } from \"./db\";\nimport { insertMovementSchema } from \"@shared/schema\";\nimport { normalizeArticle } from \"@shared/normalization\";\nimport type { BulkImportRow } from \"@shared/schema\";\nimport multer from \"multer\";\nimport * as XLSX from \"xlsx\";\nimport { inventoryDb } from \"./db\";\nimport { dbConnections } from \"@shared/schema\";\nimport { eq } from \"drizzle-orm\";\n\nconst upload = multer({ storage: multer.memoryStorage() });\n\nexport async function registerRoutes(app: Express): Promise<Server> {\n  // Initialize database\n  await initializeInventoryDb();\n  \n  // Create default connections if they don't exist\n  await storage.createDefaultConnections();\n  \n  // Ensure external inventory database has correct schema\n  try {\n    console.log('Checking for active inventory connection...');\n    const activeConn = await storage.getActiveConnection('inventory');\n    if (activeConn) {\n      console.log('Found active inventory connection:', activeConn.name);\n      // Get full connection details including password\n      const fullConnections = await inventoryDb\n        .select()\n        .from(dbConnections)\n        .where(eq(dbConnections.id, activeConn.id))\n        .limit(1);\n      \n      if (fullConnections.length > 0) {\n        console.log('Updating external database schema...');\n        await ensureExternalDbSchema(fullConnections[0]);\n      } else {\n        console.log('No full connection details found');\n      }\n    } else {\n      console.log('No active inventory connection found');\n    }\n  } catch (error) {\n    console.error('Failed to ensure external DB schema:', error);\n  }\n\n  // Search articles by normalized input\n  app.get(\"/api/articles/search\", async (req, res) => {\n    try {\n      const { query } = req.query;\n      if (!query || typeof query !== 'string') {\n        return res.status(400).json({ error: \"Query parameter is required\" });\n      }\n\n      const normalized = normalizeArticle(query);\n      const matches = await storage.searchSmart(normalized);\n      \n      // Get total stock by SMART code (aggregated across all article variants)\n      // Use batch method to get all stock levels in one DB query\n      const smartCodes = matches.map(m => m.smart);\n      const stockMap = await storage.getTotalStockBySmartBatch(smartCodes);\n      \n      // Normalize brand and description to always be arrays (or undefined)\n      // Database has these as text fields, but frontend expects arrays\n      const toArray = (value: any): string[] | undefined => {\n        if (!value) return undefined;\n        if (Array.isArray(value)) return value;\n        if (typeof value === 'string') return [value];\n        return undefined;\n      };\n      \n      const results = matches.map(match => ({\n        smart: match.smart,\n        articles: Array.isArray(match.articles) ? match.articles : [],\n        brand: toArray(match.brand),\n        description: toArray(match.description),\n        name: match.name,\n        currentStock: stockMap.get(match.smart) || 0,\n      }));\n\n      res.json(results);\n    } catch (error) {\n      console.error(\"Search error:\", error);\n      res.status(500).json({ error: \"Failed to search articles\" });\n    }\n  });\n\n  // Get SMART details by code\n  app.get(\"/api/smart/:code\", async (req, res) => {\n    try {\n      const { code } = req.params;\n      const smart = await storage.getSmartByCode(code);\n      \n      if (!smart) {\n        return res.status(404).json({ error: \"SMART code not found\" });\n      }\n\n      res.json(smart);\n    } catch (error) {\n      console.error(\"Get SMART error:\", error);\n      res.status(500).json({ error: \"Failed to get SMART details\" });\n    }\n  });\n\n  // Create movement\n  app.post(\"/api/movements\", async (req, res) => {\n    try {\n      const validatedData = insertMovementSchema.parse(req.body);\n      \n      // Validate quantity direction based on reason type\n      // Note: 'return' movements are created automatically via sold items page, not this endpoint\n      if (validatedData.reason === 'purchase' && validatedData.qtyDelta <= 0) {\n        return res.status(400).json({ error: \"Для покупки количество должно быть положительным\" });\n      }\n      if (validatedData.reason === 'return' && validatedData.qtyDelta <= 0) {\n        return res.status(400).json({ error: \"Для возврата количество должно быть положительным\" });\n      }\n      if ((validatedData.reason === 'sale' || validatedData.reason === 'writeoff') && validatedData.qtyDelta >= 0) {\n        return res.status(400).json({ error: \"Для продажи/списания количество должно быть отрицательным\" });\n      }\n      \n      const movement = await storage.createMovement(validatedData);\n      res.status(201).json(movement);\n    } catch (error) {\n      console.error(\"Create movement error:\", error);\n      \n      // Handle insufficient stock error\n      if (error instanceof InsufficientStockError) {\n        return res.status(409).json({ \n          error: error.message,\n          details: {\n            article: error.article,\n            smart: error.smart,\n            currentStock: error.currentStock,\n            requestedQty: error.requestedQty\n          }\n        });\n      }\n      \n      // Handle other errors\n      if (error instanceof Error) {\n        res.status(400).json({ error: error.message });\n      } else {\n        res.status(500).json({ error: \"Failed to create movement\" });\n      }\n    }\n  });\n\n  // Get movements with pagination\n  app.get(\"/api/movements\", async (req, res) => {\n    try {\n      const limit = parseInt(req.query.limit as string) || 50;\n      const offset = parseInt(req.query.offset as string) || 0;\n      \n      const movements = await storage.getMovements(limit, offset);\n      res.json(movements);\n    } catch (error) {\n      console.error(\"Get movements error:\", error);\n      res.status(500).json({ error: \"Failed to get movements\" });\n    }\n  });\n\n  // Get movements by SMART and article\n  app.get(\"/api/movements/:smart/:article\", async (req, res) => {\n    try {\n      const { smart, article } = req.params;\n      const movements = await storage.getMovementsBySmartAndArticle(smart, article);\n      res.json(movements);\n    } catch (error) {\n      console.error(\"Get movements by SMART/article error:\", error);\n      res.status(500).json({ error: \"Failed to get movements\" });\n    }\n  });\n\n  // Get stock levels with pagination\n  app.get(\"/api/stock\", async (req, res) => {\n    try {\n      const limit = parseInt(req.query.limit as string) || 50;\n      const offset = parseInt(req.query.offset as string) || 0;\n      \n      const stock = await storage.getStockLevels(limit, offset);\n      res.json(stock);\n    } catch (error) {\n      console.error(\"Get stock error:\", error);\n      res.status(500).json({ error: \"Failed to get stock levels\" });\n    }\n  });\n\n  // Get purchases by SMART code (MUST come before /api/stock/:smart/:article)\n  app.get(\"/api/stock/:smart/purchases\", async (req, res) => {\n    try {\n      const { smart } = req.params;\n      const purchases = await storage.getPurchasesBySmart(smart);\n      res.json(purchases);\n    } catch (error) {\n      console.error(\"Get purchases by SMART error:\", error);\n      res.status(500).json({ error: \"Failed to get purchases\" });\n    }\n  });\n\n  // Get stock by SMART and article\n  app.get(\"/api/stock/:smart/:article\", async (req, res) => {\n    try {\n      const { smart, article } = req.params;\n      const stock = await storage.getStockBySmartAndArticle(smart, article);\n      \n      if (!stock) {\n        return res.status(404).json({ error: \"Stock not found\" });\n      }\n\n      res.json(stock);\n    } catch (error) {\n      console.error(\"Get stock by SMART/article error:\", error);\n      res.status(500).json({ error: \"Failed to get stock\" });\n    }\n  });\n\n  // Update movement (purchase price and note)\n  app.patch(\"/api/movements/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const { purchasePrice, note } = req.body;\n      \n      const updates: Partial<{purchasePrice: string | null; note: string | null}> = {};\n      \n      if (purchasePrice !== undefined) {\n        updates.purchasePrice = purchasePrice;\n      }\n      \n      if (note !== undefined) {\n        updates.note = note;\n      }\n      \n      const updatedMovement = await storage.updateMovement(id, updates);\n      res.json(updatedMovement);\n    } catch (error) {\n      console.error(\"Update movement error:\", error);\n      res.status(500).json({ error: \"Failed to update movement\" });\n    }\n  });\n\n  // Get reasons\n  app.get(\"/api/reasons\", async (req, res) => {\n    try {\n      const reasons = await storage.getReasons();\n      res.json(reasons);\n    } catch (error) {\n      console.error(\"Get reasons error:\", error);\n      res.status(500).json({ error: \"Failed to get reasons\" });\n    }\n  });\n\n  // Get shipping methods\n  app.get(\"/api/shipping-methods\", async (req, res) => {\n    try {\n      const methods = await storage.getShippingMethods();\n      res.json(methods);\n    } catch (error) {\n      console.error(\"Get shipping methods error:\", error);\n      res.status(500).json({ error: \"Failed to get shipping methods\" });\n    }\n  });\n\n  // Create shipping method\n  app.post(\"/api/shipping-methods\", async (req, res) => {\n    try {\n      const { name } = req.body;\n      if (!name || typeof name !== 'string') {\n        return res.status(400).json({ error: \"Name is required\" });\n      }\n      \n      const method = await storage.createShippingMethod({ name });\n      res.status(201).json(method);\n    } catch (error) {\n      console.error(\"Create shipping method error:\", error);\n      res.status(500).json({ error: \"Failed to create shipping method\" });\n    }\n  });\n\n  // Delete shipping method\n  app.delete(\"/api/shipping-methods/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) {\n        return res.status(400).json({ error: \"Invalid ID\" });\n      }\n      \n      await storage.deleteShippingMethod(id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Delete shipping method error:\", error);\n      res.status(500).json({ error: \"Failed to delete shipping method\" });\n    }\n  });\n\n  // Update movement sale status\n  app.patch(\"/api/movements/:id/status\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) {\n        return res.status(400).json({ error: \"Invalid ID\" });\n      }\n      \n      const { status } = req.body;\n      if (status !== 'awaiting_shipment' && status !== 'shipped') {\n        return res.status(400).json({ error: \"Invalid status. Must be 'awaiting_shipment' or 'shipped'\" });\n      }\n      \n      const movement = await storage.updateMovementSaleStatus(id, status);\n      res.json(movement);\n    } catch (error) {\n      console.error(\"Update movement status error:\", error);\n      res.status(500).json({ error: \"Failed to update movement status\" });\n    }\n  });\n\n  // Mark sale as shipped\n  app.patch(\"/api/movements/:id/ship\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) {\n        return res.status(400).json({ error: \"Invalid ID\" });\n      }\n      \n      const movement = await storage.updateMovementSaleStatus(id, 'shipped');\n      res.json(movement);\n    } catch (error) {\n      console.error(\"Mark as shipped error:\", error);\n      res.status(500).json({ error: \"Failed to mark as shipped\" });\n    }\n  });\n\n  // Return sold item to inventory\n  app.post(\"/api/movements/:id/return\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      if (isNaN(id)) {\n        return res.status(400).json({ error: \"Invalid ID\" });\n      }\n      \n      // Get original sale movement\n      const saleMovement = await storage.getMovementById(id);\n      if (!saleMovement) {\n        return res.status(404).json({ error: \"Movement not found\" });\n      }\n      \n      if (saleMovement.reason !== 'sale') {\n        return res.status(400).json({ error: \"Can only return sales\" });\n      }\n      \n      // Create return movement (positive qty to add back to inventory)\n      const returnMovement = await storage.createMovement({\n        smart: saleMovement.smart,\n        article: saleMovement.article,\n        qtyDelta: Math.abs(saleMovement.qtyDelta), // Make positive\n        reason: 'return',\n        note: `Возврат продажи #${id}`,\n        purchasePrice: null,\n        salePrice: null,\n        deliveryPrice: null,\n        boxNumber: null,\n        trackNumber: null,\n        shippingMethodId: null,\n        saleStatus: null,\n      });\n      \n      res.status(201).json(returnMovement);\n    } catch (error) {\n      console.error(\"Return to inventory error:\", error);\n      \n      if (error instanceof InsufficientStockError) {\n        return res.status(409).json({ \n          error: \"Недостаточно товара на складе\",\n          details: {\n            article: error.article,\n            smart: error.smart,\n            currentStock: error.currentStock,\n            requested: error.requestedQty,\n          }\n        });\n      }\n      \n      // Check for duplicate return error\n      if (error instanceof Error && error.message === 'Товар уже возвращен на склад') {\n        return res.status(409).json({ error: error.message });\n      }\n      \n      res.status(500).json({ error: \"Failed to return to inventory\" });\n    }\n  });\n\n  // Bulk import\n  app.post(\"/api/bulk-import\", upload.single('file'), async (req, res) => {\n    try {\n      if (!req.file) {\n        return res.status(400).json({ error: \"No file uploaded\" });\n      }\n\n      let rows: BulkImportRow[] = [];\n\n      // Parse file based on type\n      if (req.file.mimetype.includes('sheet') || req.file.originalname?.endsWith('.xlsx') || req.file.originalname?.endsWith('.xls')) {\n        // Excel file\n        const workbook = XLSX.read(req.file.buffer, { type: 'buffer' });\n        const sheetName = workbook.SheetNames[0];\n        const worksheet = workbook.Sheets[sheetName];\n        const rawRows = XLSX.utils.sheet_to_json(worksheet) as any[];\n        \n        // Convert Excel rows to BulkImportRow format (handle both snake_case and camelCase)\n        rows = rawRows.map(row => ({\n          article: row.article || '',\n          qtyDelta: parseInt(row.qty_delta || row.qtyDelta) || 0,\n          reason: row.reason || '',\n          note: row.note || undefined,\n          smart: row.smart || undefined,\n        })).filter(row => row.article && row.qtyDelta && row.reason);\n      } else if (req.file.mimetype.includes('csv') || req.file.originalname?.endsWith('.csv')) {\n        // CSV file\n        const csvText = req.file.buffer.toString('utf-8');\n        const lines = csvText.split('\\n').filter(line => line.trim());\n        const headers = lines[0].split(',').map(h => h.trim());\n        \n        for (let i = 1; i < lines.length; i++) {\n          const values = lines[i].split(',').map(v => v.trim());\n          const row: any = {};\n          headers.forEach((header, index) => {\n            row[header] = values[index] || '';\n          });\n          \n          const qtyDelta = parseInt(row.qty_delta || row.qtyDelta) || 0;\n          \n          if (row.article && qtyDelta && row.reason) {\n            rows.push({\n              article: row.article,\n              qtyDelta: qtyDelta,\n              reason: row.reason,\n              note: row.note || undefined,\n              smart: row.smart || undefined,\n            });\n          }\n        }\n      } else {\n        return res.status(400).json({ error: \"Unsupported file type\" });\n      }\n\n      // Process bulk import\n      const result = await storage.processBulkImport(rows);\n      res.json(result);\n    } catch (error) {\n      console.error(\"Bulk import error:\", error);\n      res.status(500).json({ error: \"Failed to process bulk import\" });\n    }\n  });\n\n  // Download import template\n  app.get(\"/api/import-template\", (req, res) => {\n    const templateData = [\n      { article: 'ABC-123', qty_delta: 10, reason: 'purchase', note: 'Example purchase', smart: '' },\n      { article: 'DEF-456', qty_delta: -5, reason: 'sale', note: 'Example sale', smart: 'SMART-00123' },\n    ];\n\n    const ws = XLSX.utils.json_to_sheet(templateData);\n    const wb = XLSX.utils.book_new();\n    XLSX.utils.book_append_sheet(wb, ws, 'Import Template');\n    \n    const buffer = XLSX.write(wb, { type: 'buffer', bookType: 'xlsx' });\n    \n    res.setHeader('Content-Disposition', 'attachment; filename=\"inventory-import-template.xlsx\"');\n    res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\n    res.send(buffer);\n  });\n\n  // Dashboard stats\n  app.get(\"/api/dashboard/stats\", async (req, res) => {\n    try {\n      // This would need custom queries to get actual stats\n      // For now, return basic structure\n      const movements = await storage.getMovements(1000, 0);\n      const stockLevels = await storage.getStockLevels(1000, 0);\n      \n      const stats = {\n        totalArticles: stockLevels.length,\n        inStock: stockLevels.filter(s => s.totalQty > 0).length,\n        movementsToday: movements.filter(m => {\n          const today = new Date();\n          const movementDate = new Date(m.createdAt);\n          return movementDate.toDateString() === today.toDateString();\n        }).length,\n        lowStockAlerts: stockLevels.filter(s => s.totalQty > 0 && s.totalQty <= 10).length,\n      };\n      \n      res.json(stats);\n    } catch (error) {\n      console.error(\"Dashboard stats error:\", error);\n      res.status(500).json({ error: \"Failed to get dashboard stats\" });\n    }\n  });\n\n  // Database connections management\n  app.get(\"/api/db-connections\", async (req, res) => {\n    try {\n      const connections = await storage.getDbConnections();\n      // Password is already removed by storage layer\n      res.json(connections);\n    } catch (error) {\n      console.error(\"Get DB connections error:\", error);\n      res.status(500).json({ error: \"Failed to get database connections\" });\n    }\n  });\n\n  app.post(\"/api/db-connections\", async (req, res) => {\n    try {\n      const connection = await storage.createDbConnection(req.body);\n      // Password is already removed by storage layer\n      res.status(201).json(connection);\n    } catch (error) {\n      console.error(\"Create DB connection error:\", error);\n      if (error instanceof Error) {\n        res.status(400).json({ error: error.message });\n      } else {\n        res.status(500).json({ error: \"Failed to create database connection\" });\n      }\n    }\n  });\n\n  app.delete(\"/api/db-connections/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      await storage.deleteDbConnection(id);\n      res.status(204).send();\n    } catch (error) {\n      console.error(\"Delete DB connection error:\", error);\n      res.status(500).json({ error: \"Failed to delete database connection\" });\n    }\n  });\n\n  app.post(\"/api/db-connections/test\", async (req, res) => {\n    try {\n      const result = await storage.testDbConnection(req.body);\n      res.json(result);\n    } catch (error) {\n      console.error(\"Test DB connection error:\", error);\n      if (error instanceof Error) {\n        res.status(400).json({ success: false, message: error.message });\n      } else {\n        res.status(500).json({ success: false, message: \"Failed to test connection\" });\n      }\n    }\n  });\n\n  app.post(\"/api/db-connections/:id/tables\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const result = await storage.getDbTables(id);\n      res.json(result);\n    } catch (error) {\n      console.error(\"Get DB tables error:\", error);\n      if (error instanceof Error) {\n        res.status(400).json({ error: error.message });\n      } else {\n        res.status(500).json({ error: \"Failed to get tables\" });\n      }\n    }\n  });\n\n  app.post(\"/api/db-connections/:id/configure\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const { role, tableName, fieldMapping } = req.body;\n      \n      const result = await storage.configureConnection({\n        connectionId: id,\n        role,\n        tableName,\n        fieldMapping,\n      });\n      \n      res.json(result);\n    } catch (error) {\n      console.error(\"Configure connection error:\", error);\n      if (error instanceof Error) {\n        res.status(400).json({ error: error.message });\n      } else {\n        res.status(500).json({ error: \"Failed to configure connection\" });\n      }\n    }\n  });\n\n  app.get(\"/api/db-connections/:id/columns\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const { tableName } = req.query;\n      \n      if (!tableName || typeof tableName !== 'string') {\n        return res.status(400).json({ error: \"tableName query parameter is required\" });\n      }\n      \n      const columns = await storage.getTableColumns(id, tableName);\n      res.json({ columns });\n    } catch (error) {\n      console.error(\"Get table columns error:\", error);\n      if (error instanceof Error) {\n        res.status(400).json({ error: error.message });\n      } else {\n        res.status(500).json({ error: \"Failed to get columns\" });\n      }\n    }\n  });\n\n  app.get(\"/api/db-connections/active/:role\", async (req, res) => {\n    try {\n      const { role } = req.params;\n      \n      if (role !== 'smart' && role !== 'inventory') {\n        return res.status(400).json({ error: \"Invalid role\" });\n      }\n      \n      const connection = await storage.getActiveConnection(role);\n      res.json(connection);\n    } catch (error) {\n      console.error(\"Get active connection error:\", error);\n      res.status(500).json({ error: \"Failed to get active connection\" });\n    }\n  });\n\n  const httpServer = createServer(app);\n  return httpServer;\n}\n","size_bytes":22054},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","size_bytes":711},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","size_bytes":1527},"client/src/pages/add-movement.tsx":{"content":"import { useState, useEffect, useRef } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { useLocation } from \"wouter\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"@/components/ui/popover\";\nimport { Command, CommandEmpty, CommandGroup, CommandItem, CommandList } from \"@/components/ui/command\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { insertMovementSchema } from \"@shared/schema\";\nimport type { InsertMovement, Reason, ArticleSearchResult } from \"@shared/schema\";\nimport { z } from \"zod\";\nimport { DisambiguationModal } from \"@/components/disambiguation-modal\";\nimport { Check } from \"lucide-react\";\n\nconst formSchema = insertMovementSchema.extend({\n  qtyDelta: z.number().int().min(-999999).max(999999).refine((val) => val !== 0, {\n    message: \"Количество не может быть равно 0\",\n  }),\n}).superRefine((data, ctx) => {\n  // Validate quantity direction based on reason type\n  // Note: 'return' is not shown in form (only via sold items), but validation kept for safety\n  if (data.reason === 'purchase') {\n    if (data.qtyDelta <= 0) {\n      ctx.addIssue({\n        code: z.ZodIssueCode.custom,\n        message: \"Для покупки количество должно быть положительным\",\n        path: [\"qtyDelta\"],\n      });\n    }\n  }\n  if (data.reason === 'sale' || data.reason === 'writeoff') {\n    if (data.qtyDelta >= 0) {\n      ctx.addIssue({\n        code: z.ZodIssueCode.custom,\n        message: \"Для продажи/списания количество должно быть отрицательным\",\n        path: [\"qtyDelta\"],\n      });\n    }\n  }\n});\n\ntype FormData = z.infer<typeof formSchema>;\n\nexport default function AddMovement() {\n  const [qtyInput, setQtyInput] = useState(0);\n  const [searchResults, setSearchResults] = useState<ArticleSearchResult[]>([]);\n  const [showDisambiguation, setShowDisambiguation] = useState(false);\n  const [isSearching, setIsSearching] = useState(false);\n  const [lastSearchedArticle, setLastSearchedArticle] = useState<string>(\"\");\n  const [hasPrefilled, setHasPrefilled] = useState(false);\n  const [autocompleteOpen, setAutocompleteOpen] = useState(false);\n  const [autocompleteResults, setAutocompleteResults] = useState<ArticleSearchResult[]>([]);\n  const debounceTimeout = useRef<NodeJS.Timeout | null>(null);\n  const [location] = useLocation();\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const form = useForm<FormData>({\n    resolver: zodResolver(formSchema),\n    defaultValues: {\n      smart: \"\",\n      article: \"\",\n      qtyDelta: 0,\n      reason: undefined as any,\n      note: \"\",\n      purchasePrice: null,\n      salePrice: null,\n      deliveryPrice: null,\n      boxNumber: null,\n      trackNumber: null,\n      shippingMethodId: null,\n      saleStatus: null,\n    },\n  });\n\n  // Pre-fill form from URL parameters\n  useEffect(() => {\n    // Use window.location.search because wouter's location doesn't include query string\n    const searchParams = new URLSearchParams(window.location.search);\n    const smart = searchParams.get('smart');\n    const article = searchParams.get('article');\n    \n    // Only prefill if both params exist and haven't already prefilled\n    if (smart && article && !hasPrefilled) {\n      form.reset({\n        smart,\n        article,\n        qtyDelta: 0,\n        reason: undefined as any,\n        note: \"\",\n        purchasePrice: null,\n        salePrice: null,\n        deliveryPrice: null,\n        boxNumber: null,\n        trackNumber: null,\n        shippingMethodId: null,\n        saleStatus: null,\n      });\n      setHasPrefilled(true);\n      toast({\n        title: \"Данные загружены\",\n        description: \"Артикул и SMART код автоматически заполнены из результатов поиска\",\n      });\n    }\n  }, [location, hasPrefilled, form, toast]);\n\n  // Cleanup debounce timeout on unmount\n  useEffect(() => {\n    return () => {\n      if (debounceTimeout.current) {\n        clearTimeout(debounceTimeout.current);\n      }\n    };\n  }, []);\n\n  // Autocomplete search with debouncing\n  const performAutocompleteSearch = async (query: string) => {\n    if (!query.trim() || query.trim().length < 2) {\n      setAutocompleteResults([]);\n      setAutocompleteOpen(false);\n      return;\n    }\n\n    try {\n      const response = await apiRequest(\"GET\", `/api/articles/search?query=${encodeURIComponent(query.trim())}`);\n      const results: ArticleSearchResult[] = await response.json();\n      setAutocompleteResults(results);\n      setAutocompleteOpen(results.length > 0);\n    } catch (error) {\n      console.error(\"Autocomplete search error:\", error);\n      setAutocompleteResults([]);\n      setAutocompleteOpen(false);\n    }\n  };\n\n  // Trigger autocomplete search on article input change with debouncing\n  const handleArticleInputChange = (value: string) => {\n    if (debounceTimeout.current) {\n      clearTimeout(debounceTimeout.current);\n    }\n\n    debounceTimeout.current = setTimeout(() => {\n      performAutocompleteSearch(value);\n    }, 300);\n  };\n\n  const { data: reasons } = useQuery({\n    queryKey: [\"/api/reasons\"],\n  });\n\n  const { data: shippingMethods } = useQuery({\n    queryKey: [\"/api/shipping-methods\"],\n  });\n\n  // Filter out 'return' reason - returns should only be done via sold items page\n  const availableReasons = (reasons as Reason[] || []).filter(r => r.code !== 'return');\n\n  // Watch the reason field to show conditional fields\n  const selectedReason = form.watch(\"reason\");\n\n  // Trigger validation when reason changes to validate quantity direction\n  useEffect(() => {\n    if (selectedReason) {\n      form.trigger(\"qtyDelta\");\n    }\n  }, [selectedReason, form]);\n\n  const searchArticleMutation = useMutation({\n    mutationFn: async (query: string) => {\n      const response = await apiRequest(\"GET\", `/api/articles/search?query=${encodeURIComponent(query)}`);\n      return response.json();\n    },\n    onSuccess: (results: ArticleSearchResult[], variables) => {\n      // Ignore results if article has changed since search was initiated\n      const currentArticle = form.getValues('article');\n      if (currentArticle.trim() !== variables.trim()) {\n        setIsSearching(false);\n        return;\n      }\n      \n      setSearchResults(results);\n      setIsSearching(false);\n      \n      if (results.length === 0) {\n        toast({\n          title: \"Совпадений не найдено\",\n          description: `SMART код для артикула не найден`,\n          variant: \"destructive\",\n        });\n        form.setValue('smart', '');\n      } else if (results.length === 1) {\n        form.setValue('smart', results[0].smart);\n        toast({\n          title: \"SMART код найден\",\n          description: `Автоматически подставлен: ${results[0].smart}`,\n        });\n      } else {\n        setShowDisambiguation(true);\n      }\n    },\n    onError: (error) => {\n      setIsSearching(false);\n      toast({\n        title: \"Ошибка поиска\",\n        description: error instanceof Error ? error.message : \"Не удалось выполнить поиск\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const createMovementMutation = useMutation({\n    mutationFn: async (data: FormData) => {\n      const response = await apiRequest(\"POST\", \"/api/movements\", data);\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/movements\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/stock\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/stats\"] });\n      \n      toast({\n        title: \"Движение записано\",\n        description: \"Движение товара успешно зарегистрировано\",\n      });\n      \n      // Reset all form and search state\n      form.reset();\n      setQtyInput(0);\n      setSearchResults([]);\n      setShowDisambiguation(false);\n      setIsSearching(false);\n      setLastSearchedArticle(\"\");\n      setHasPrefilled(false);\n    },\n    onError: (error) => {\n      toast({\n        title: \"Ошибка записи движения\",\n        description: error instanceof Error ? error.message : \"Произошла ошибка\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const onSubmit = (data: FormData) => {\n    // Set saleStatus to \"awaiting_shipment\" for sales\n    const saleStatus = data.reason === \"sale\" ? \"awaiting_shipment\" : null;\n    \n    createMovementMutation.mutate({\n      ...data,\n      qtyDelta: qtyInput,\n      saleStatus,\n    });\n  };\n\n  const incrementQty = () => {\n    const newValue = qtyInput + 1;\n    setQtyInput(newValue);\n    form.setValue('qtyDelta', newValue);\n    form.trigger('qtyDelta');\n  };\n\n  const decrementQty = () => {\n    const newValue = qtyInput - 1;\n    setQtyInput(newValue);\n    form.setValue('qtyDelta', newValue);\n    form.trigger('qtyDelta');\n  };\n\n  const handleArticleSearch = () => {\n    const article = form.getValues('article');\n    if (!article.trim()) {\n      toast({\n        title: \"Введите артикул\",\n        description: \"Для поиска SMART кода необходимо ввести артикул\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    setIsSearching(true);\n    setSearchResults([]);\n    searchArticleMutation.mutate(article.trim());\n  };\n\n  const handleSelectMatch = (result: ArticleSearchResult) => {\n    form.setValue('smart', result.smart);\n    setShowDisambiguation(false);\n    toast({\n      title: \"SMART код выбран\",\n      description: `Выбран: ${result.smart}`,\n    });\n  };\n\n  const handleAutocompleteSelect = (result: ArticleSearchResult) => {\n    // Set article field: use articles if available, otherwise use SMART code\n    const articleValue = Array.isArray(result.articles) && result.articles.length > 0 \n      ? result.articles.join(', ') \n      : result.smart;\n    \n    form.setValue('article', articleValue);\n    form.setValue('smart', result.smart);\n    setAutocompleteOpen(false);\n    setAutocompleteResults([]);\n    toast({\n      title: \"Позиция выбрана\",\n      description: `SMART код: ${result.smart}`,\n    });\n  };\n\n  return (\n    <div className=\"flex-1 overflow-y-auto\">\n      <header className=\"bg-card border-b border-border sticky top-0 z-10\">\n        <div className=\"px-8 py-4\">\n          <h2 className=\"text-2xl font-bold text-foreground\">Добавить движение</h2>\n          <p className=\"text-sm text-muted-foreground mt-1\">Зарегистрируйте изменение остатков</p>\n        </div>\n      </header>\n\n      <div className=\"p-8\">\n        <div className=\"max-w-2xl mx-auto\">\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center justify-between\">\n                <div>\n                  <div className=\"text-lg font-semibold text-foreground\">Ввод движения</div>\n                  <p className=\"text-sm text-muted-foreground mt-1\">Введите данные движения товара</p>\n                </div>\n                <i className=\"fas fa-plus-circle text-muted-foreground text-xl\"></i>\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              <Form {...form}>\n                <form onSubmit={form.handleSubmit(onSubmit)} className=\"space-y-6\">\n                  <FormField\n                    control={form.control}\n                    name=\"article\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>\n                          Артикул <span className=\"text-destructive\">*</span>\n                        </FormLabel>\n                        <FormControl>\n                          <div className=\"flex gap-2\">\n                            <Popover open={autocompleteOpen} onOpenChange={setAutocompleteOpen}>\n                              <PopoverTrigger asChild>\n                                <div className=\"flex-1\">\n                                  <Input \n                                    placeholder=\"Начните вводить артикул...\" \n                                    className=\"font-mono\" \n                                    {...field}\n                                    onChange={(e) => {\n                                      field.onChange(e);\n                                      handleArticleInputChange(e.target.value);\n                                      // Clear all search state when article changes\n                                      form.setValue('smart', '');\n                                      setSearchResults([]);\n                                      setShowDisambiguation(false);\n                                      setIsSearching(false);\n                                    }}\n                                    data-testid=\"input-article\"\n                                    onKeyDown={(e) => {\n                                      if (e.key === 'Enter') {\n                                        e.preventDefault();\n                                        handleArticleSearch();\n                                      } else if (e.key === 'Escape') {\n                                        setAutocompleteOpen(false);\n                                      }\n                                    }}\n                                  />\n                                </div>\n                              </PopoverTrigger>\n                              <PopoverContent \n                                className=\"w-[var(--radix-popover-trigger-width)] p-0\" \n                                align=\"start\"\n                                onOpenAutoFocus={(e) => e.preventDefault()}\n                              >\n                                <Command>\n                                  <CommandList>\n                                    <CommandEmpty>Ничего не найдено</CommandEmpty>\n                                    <CommandGroup heading=\"Найденные позиции\">\n                                      {autocompleteResults.map((result, idx) => (\n                                        <CommandItem\n                                          key={`${result.smart}-${idx}`}\n                                          value={result.smart}\n                                          onSelect={() => handleAutocompleteSelect(result)}\n                                          className=\"cursor-pointer\"\n                                          data-testid={`autocomplete-item-${idx}`}\n                                        >\n                                          <div className=\"flex flex-col gap-1 w-full\">\n                                            <div className=\"flex items-center justify-between gap-2\">\n                                              <span className=\"font-mono text-sm font-bold text-primary\">\n                                                {result.smart}\n                                              </span>\n                                              {Array.isArray(result.brand) && result.brand.length > 0 && (\n                                                <span className=\"text-xs text-muted-foreground\">\n                                                  {result.brand.join(', ')}\n                                                </span>\n                                              )}\n                                            </div>\n                                            {Array.isArray(result.articles) && result.articles.length > 0 && (\n                                              <span className=\"font-mono text-xs text-muted-foreground\">\n                                                {result.articles.join(', ')}\n                                              </span>\n                                            )}\n                                            {result.name && (\n                                              <span className=\"text-xs text-muted-foreground\">\n                                                {result.name}\n                                              </span>\n                                            )}\n                                          </div>\n                                        </CommandItem>\n                                      ))}\n                                    </CommandGroup>\n                                  </CommandList>\n                                </Command>\n                              </PopoverContent>\n                            </Popover>\n                            <Button\n                              type=\"button\"\n                              onClick={handleArticleSearch}\n                              disabled={isSearching}\n                              data-testid=\"button-search-smart\"\n                            >\n                              {isSearching ? (\n                                <div className=\"w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin\"></div>\n                              ) : (\n                                <>\n                                  <i className=\"fas fa-search mr-2\"></i>\n                                  Найти SMART\n                                </>\n                              )}\n                            </Button>\n                          </div>\n                        </FormControl>\n                        <FormMessage />\n                        <p className=\"text-xs text-muted-foreground mt-1\">\n                          <i className=\"fas fa-info-circle mr-1\"></i>\n                          Начните вводить артикул - появятся подсказки\n                        </p>\n                      </FormItem>\n                    )}\n                  />\n\n                  <FormField\n                    control={form.control}\n                    name=\"smart\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>\n                          SMART код <span className=\"text-destructive\">*</span>\n                        </FormLabel>\n                        <FormControl>\n                          <Input \n                            placeholder=\"Будет найден автоматически\" \n                            className=\"font-mono bg-muted cursor-not-allowed\" \n                            {...field}\n                            onKeyDown={(e) => e.preventDefault()}\n                            onPaste={(e) => e.preventDefault()}\n                            data-testid=\"input-smart-code\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                        {field.value && (\n                          <p className=\"text-xs text-success mt-1\">\n                            <i className=\"fas fa-check-circle mr-1\"></i>\n                            SMART код найден\n                          </p>\n                        )}\n                      </FormItem>\n                    )}\n                  />\n\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <FormField\n                      control={form.control}\n                      name=\"qtyDelta\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>\n                            Изменение количества <span className=\"text-destructive\">*</span>\n                          </FormLabel>\n                          <div className=\"flex gap-2\">\n                            <Button \n                              type=\"button\" \n                              variant=\"outline\" \n                              size=\"icon\"\n                              onClick={decrementQty}\n                              data-testid=\"button-decrement-qty\"\n                              className=\"text-orange-600 hover:text-orange-700 hover:bg-orange-50\"\n                            >\n                              <i className=\"fas fa-minus\"></i>\n                            </Button>\n                            <FormControl>\n                              <Input\n                                type=\"number\"\n                                className=\"font-mono text-center\"\n                                value={qtyInput}\n                                onChange={(e) => {\n                                  const val = parseInt(e.target.value) || 0;\n                                  setQtyInput(val);\n                                  field.onChange(val);\n                                  form.trigger('qtyDelta');\n                                }}\n                                data-testid=\"input-qty-delta\"\n                              />\n                            </FormControl>\n                            <Button \n                              type=\"button\" \n                              variant=\"outline\"\n                              size=\"icon\"\n                              onClick={incrementQty}\n                              data-testid=\"button-increment-qty\"\n                              className=\"text-green-600 hover:text-green-700 hover:bg-green-50\"\n                            >\n                              <i className=\"fas fa-plus\"></i>\n                            </Button>\n                          </div>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    <FormField\n                      control={form.control}\n                      name=\"reason\"\n                      render={({ field }) => (\n                        <FormItem>\n                          <FormLabel>\n                            Причина <span className=\"text-destructive\">*</span>\n                          </FormLabel>\n                          <Select onValueChange={field.onChange} value={field.value}>\n                            <FormControl>\n                              <SelectTrigger data-testid=\"select-reason\">\n                                <SelectValue placeholder=\"Выберите причину\" />\n                              </SelectTrigger>\n                            </FormControl>\n                            <SelectContent>\n                              {availableReasons.map((reason) => (\n                                <SelectItem key={reason.code} value={reason.code}>\n                                  {reason.title}\n                                </SelectItem>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                          <FormMessage />\n                        </FormItem>\n                      )}\n                    />\n\n                    {/* Conditional fields for purchase */}\n                    {selectedReason === \"purchase\" && (\n                      <>\n                        <FormField\n                          control={form.control}\n                          name=\"purchasePrice\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>\n                                Цена закупки <span className=\"text-destructive\">*</span>\n                              </FormLabel>\n                              <FormControl>\n                                <Input\n                                  type=\"number\"\n                                  step=\"0.01\"\n                                  placeholder=\"0.00\"\n                                  {...field}\n                                  value={field.value || \"\"}\n                                  onChange={(e) => field.onChange(e.target.value || null)}\n                                  data-testid=\"input-purchase-price\"\n                                />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                        <FormField\n                          control={form.control}\n                          name=\"boxNumber\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>\n                                Номер коробки <span className=\"text-destructive\">*</span>\n                              </FormLabel>\n                              <FormControl>\n                                <Input\n                                  placeholder=\"Например: K-123\"\n                                  {...field}\n                                  value={field.value || \"\"}\n                                  onChange={(e) => field.onChange(e.target.value || null)}\n                                  data-testid=\"input-box-number\"\n                                />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                      </>\n                    )}\n\n                    {/* Conditional fields for sale */}\n                    {selectedReason === \"sale\" && (\n                      <>\n                        <FormField\n                          control={form.control}\n                          name=\"salePrice\"\n                          render={({ field }) => {\n                            const salePrice = parseFloat(field.value || \"0\");\n                            const totalAmount = Math.abs(qtyInput) * salePrice;\n                            \n                            return (\n                              <FormItem>\n                                <FormLabel>\n                                  Цена за единицу товара <span className=\"text-destructive\">*</span>\n                                </FormLabel>\n                                <FormControl>\n                                  <Input\n                                    type=\"number\"\n                                    step=\"0.01\"\n                                    placeholder=\"0.00\"\n                                    {...field}\n                                    value={field.value || \"\"}\n                                    onChange={(e) => field.onChange(e.target.value || null)}\n                                    data-testid=\"input-sale-price\"\n                                  />\n                                </FormControl>\n                                <FormMessage />\n                                {salePrice > 0 && qtyInput !== 0 && (\n                                  <p className=\"text-xs text-muted-foreground mt-1\">\n                                    <i className=\"fas fa-calculator mr-1\"></i>\n                                    Общая сумма: {totalAmount.toFixed(2)} ₽\n                                  </p>\n                                )}\n                              </FormItem>\n                            );\n                          }}\n                        />\n                        <FormField\n                          control={form.control}\n                          name=\"deliveryPrice\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>\n                                Стоимость доставки <span className=\"text-destructive\">*</span>\n                              </FormLabel>\n                              <FormControl>\n                                <Input\n                                  type=\"number\"\n                                  step=\"0.01\"\n                                  placeholder=\"0.00\"\n                                  {...field}\n                                  value={field.value || \"\"}\n                                  onChange={(e) => field.onChange(e.target.value || null)}\n                                  data-testid=\"input-delivery-price\"\n                                />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                        <FormField\n                          control={form.control}\n                          name=\"shippingMethodId\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>\n                                Способ доставки <span className=\"text-destructive\">*</span>\n                              </FormLabel>\n                              <Select \n                                onValueChange={(value) => field.onChange(parseInt(value))} \n                                value={field.value?.toString() || \"\"}\n                              >\n                                <FormControl>\n                                  <SelectTrigger data-testid=\"select-shipping-method\">\n                                    <SelectValue placeholder=\"Выберите способ доставки\" />\n                                  </SelectTrigger>\n                                </FormControl>\n                                <SelectContent>\n                                  {(shippingMethods as any[] || []).map((method: any) => (\n                                    <SelectItem key={method.id} value={method.id.toString()}>\n                                      {method.name}\n                                    </SelectItem>\n                                  ))}\n                                </SelectContent>\n                              </Select>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                        <FormField\n                          control={form.control}\n                          name=\"trackNumber\"\n                          render={({ field }) => (\n                            <FormItem>\n                              <FormLabel>\n                                Трек-номер <span className=\"text-muted-foreground font-normal\">(опционально)</span>\n                              </FormLabel>\n                              <FormControl>\n                                <Input\n                                  placeholder=\"Например: RA123456789RU\"\n                                  {...field}\n                                  value={field.value || \"\"}\n                                  onChange={(e) => field.onChange(e.target.value || null)}\n                                  data-testid=\"input-track-number\"\n                                />\n                              </FormControl>\n                              <FormMessage />\n                            </FormItem>\n                          )}\n                        />\n                      </>\n                    )}\n                  </div>\n\n                  <FormField\n                    control={form.control}\n                    name=\"note\"\n                    render={({ field }) => (\n                      <FormItem>\n                        <FormLabel>\n                          Примечание <span className=\"text-muted-foreground font-normal\">(опционально)</span>\n                        </FormLabel>\n                        <FormControl>\n                          <Textarea\n                            rows={3}\n                            placeholder=\"Дополнительные комментарии...\"\n                            className=\"resize-none\"\n                            {...field}\n                            value={field.value || \"\"}\n                            data-testid=\"textarea-note\"\n                          />\n                        </FormControl>\n                        <FormMessage />\n                      </FormItem>\n                    )}\n                  />\n\n                  <div className=\"flex gap-3 pt-2\">\n                    <Button \n                      type=\"submit\" \n                      className=\"flex-1\"\n                      disabled={createMovementMutation.isPending}\n                      data-testid=\"button-submit-movement\"\n                    >\n                      {createMovementMutation.isPending ? (\n                        <>\n                          <div className=\"w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin mr-2\"></div>\n                          Запись...\n                        </>\n                      ) : (\n                        <>\n                          <i className=\"fas fa-check mr-2\"></i>\n                          Записать движение\n                        </>\n                      )}\n                    </Button>\n                    <Button \n                      type=\"button\" \n                      variant=\"secondary\"\n                      onClick={() => {\n                        form.reset();\n                        setQtyInput(0);\n                        setSearchResults([]);\n                        setShowDisambiguation(false);\n                        setIsSearching(false);\n                        setLastSearchedArticle(\"\");\n                        setHasPrefilled(false);\n                      }}\n                      data-testid=\"button-clear-form\"\n                    >\n                      <i className=\"fas fa-rotate-left mr-2\"></i>\n                      Очистить\n                    </Button>\n                  </div>\n                </form>\n              </Form>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n\n      <DisambiguationModal\n        isOpen={showDisambiguation}\n        onClose={() => setShowDisambiguation(false)}\n        onSelect={handleSelectMatch}\n        matches={searchResults}\n        searchQuery={form.getValues('article')}\n      />\n    </div>\n  );\n}\n","size_bytes":34684},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","size_bytes":1251},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","size_bytes":1723},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"rounded-lg border bg-card text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n))\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\n\nexport { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }\n","size_bytes":1858},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-primary text-primary-foreground hover:bg-primary/90\",\n        destructive:\n          \"bg-destructive text-destructive-foreground hover:bg-destructive/90\",\n        outline:\n          \"border border-input bg-background hover:bg-accent hover:text-accent-foreground\",\n        secondary:\n          \"bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        ghost: \"hover:bg-accent hover:text-accent-foreground\",\n        link: \"text-primary underline-offset-4 hover:underline\",\n      },\n      size: {\n        default: \"h-10 px-4 py-2\",\n        sm: \"h-9 rounded-md px-3\",\n        lg: \"h-11 rounded-md px-8\",\n        icon: \"h-10 w-10\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","size_bytes":1901},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","size_bytes":10481},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \"var(--radius)\",\n        md: \"calc(var(--radius) - 2px)\",\n        sm: \"calc(var(--radius) - 4px)\",\n      },\n      colors: {\n        background: \"var(--background)\",\n        foreground: \"var(--foreground)\",\n        card: {\n          DEFAULT: \"var(--card)\",\n          foreground: \"var(--card-foreground)\",\n        },\n        popover: {\n          DEFAULT: \"var(--popover)\",\n          foreground: \"var(--popover-foreground)\",\n        },\n        primary: {\n          DEFAULT: \"var(--primary)\",\n          foreground: \"var(--primary-foreground)\",\n        },\n        secondary: {\n          DEFAULT: \"var(--secondary)\",\n          foreground: \"var(--secondary-foreground)\",\n        },\n        muted: {\n          DEFAULT: \"var(--muted)\",\n          foreground: \"var(--muted-foreground)\",\n        },\n        accent: {\n          DEFAULT: \"var(--accent)\",\n          foreground: \"var(--accent-foreground)\",\n        },\n        destructive: {\n          DEFAULT: \"var(--destructive)\",\n          foreground: \"var(--destructive-foreground)\",\n        },\n        border: \"var(--border)\",\n        input: \"var(--input)\",\n        ring: \"var(--ring)\",\n        chart: {\n          \"1\": \"var(--chart-1)\",\n          \"2\": \"var(--chart-2)\",\n          \"3\": \"var(--chart-3)\",\n          \"4\": \"var(--chart-4)\",\n          \"5\": \"var(--chart-5)\",\n        },\n        sidebar: {\n          DEFAULT: \"var(--sidebar-background)\",\n          foreground: \"var(--sidebar-foreground)\",\n          primary: \"var(--sidebar-primary)\",\n          \"primary-foreground\": \"var(--sidebar-primary-foreground)\",\n          accent: \"var(--sidebar-accent)\",\n          \"accent-foreground\": \"var(--sidebar-accent-foreground)\",\n          border: \"var(--sidebar-border)\",\n          ring: \"var(--sidebar-ring)\",\n        },\n      },\n      fontFamily: {\n        sans: [\"var(--font-sans)\"],\n        serif: [\"var(--font-serif)\"],\n        mono: [\"var(--font-mono)\"],\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: {\n            height: \"0\",\n          },\n          to: {\n            height: \"var(--radix-accordion-content-height)\",\n          },\n        },\n        \"accordion-up\": {\n          from: {\n            height: \"var(--radix-accordion-content-height)\",\n          },\n          to: {\n            height: \"0\",\n          },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","size_bytes":2766},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","size_bytes":1139},"client/src/pages/bulk-import.tsx":{"content":"import { useState, useCallback } from \"react\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport type { BulkImportResult } from \"@shared/schema\";\n\nexport default function BulkImport() {\n  const [selectedFile, setSelectedFile] = useState<File | null>(null);\n  const [dragActive, setDragActive] = useState(false);\n  const [importResult, setImportResult] = useState<BulkImportResult | null>(null);\n  \n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const importMutation = useMutation({\n    mutationFn: async (file: File) => {\n      const formData = new FormData();\n      formData.append('file', file);\n      \n      const response = await fetch('/api/bulk-import', {\n        method: 'POST',\n        body: formData,\n      });\n      \n      if (!response.ok) {\n        throw new Error(await response.text());\n      }\n      \n      return response.json();\n    },\n    onSuccess: (result: BulkImportResult) => {\n      setImportResult(result);\n      queryClient.invalidateQueries({ queryKey: [\"/api/movements\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/stock\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/dashboard/stats\"] });\n      \n      if (result.imported > 0) {\n        toast({\n          title: \"Импорт завершён\",\n          description: `Успешно импортировано движений: ${result.imported}`,\n        });\n      }\n    },\n    onError: (error) => {\n      toast({\n        title: \"Ошибка импорта\",\n        description: error instanceof Error ? error.message : \"Не удалось обработать файл\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const downloadTemplateMutation = useMutation({\n    mutationFn: async () => {\n      const response = await fetch('/api/import-template');\n      if (!response.ok) throw new Error('Не удалось скачать шаблон');\n      \n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.style.display = 'none';\n      a.href = url;\n      a.download = 'inventory-import-template.xlsx';\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n    },\n    onError: (error) => {\n      toast({\n        title: \"Ошибка загрузки\",\n        description: error instanceof Error ? error.message : \"Не удалось скачать шаблон\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleDrag = useCallback((e: React.DragEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    if (e.type === \"dragenter\" || e.type === \"dragover\") {\n      setDragActive(true);\n    } else if (e.type === \"dragleave\") {\n      setDragActive(false);\n    }\n  }, []);\n\n  const handleDrop = useCallback((e: React.DragEvent) => {\n    e.preventDefault();\n    e.stopPropagation();\n    setDragActive(false);\n    \n    if (e.dataTransfer.files && e.dataTransfer.files[0]) {\n      handleFileSelect(e.dataTransfer.files[0]);\n    }\n  }, []);\n\n  const handleFileSelect = (file: File) => {\n    const validTypes = [\n      'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\n      'application/vnd.ms-excel',\n      'text/csv',\n      'application/csv',\n    ];\n    \n    if (!validTypes.includes(file.type) && !file.name.match(/\\.(xlsx|xls|csv)$/i)) {\n      toast({\n        title: \"Неверный тип файла\",\n        description: \"Пожалуйста, выберите Excel (.xlsx, .xls) или CSV файл\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n    \n    setSelectedFile(file);\n    setImportResult(null);\n  };\n\n  const handleFileInput = (e: React.ChangeEvent<HTMLInputElement>) => {\n    if (e.target.files && e.target.files[0]) {\n      handleFileSelect(e.target.files[0]);\n    }\n  };\n\n  const handleImport = () => {\n    if (!selectedFile) return;\n    importMutation.mutate(selectedFile);\n  };\n\n  return (\n    <div className=\"flex-1 overflow-y-auto\">\n      <header className=\"bg-card border-b border-border sticky top-0 z-10\">\n        <div className=\"px-8 py-4\">\n          <h2 className=\"text-2xl font-bold text-foreground\">Массовая загрузка</h2>\n          <p className=\"text-sm text-muted-foreground mt-1\">Загрузка Excel/CSV файлов для массовых операций</p>\n        </div>\n      </header>\n\n      <div className=\"p-8\">\n        <div className=\"max-w-4xl mx-auto space-y-6\">\n          {/* File Upload Card */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center justify-between\">\n                <div>\n                  <div className=\"text-lg font-semibold text-foreground\">Загрузка файла</div>\n                  <p className=\"text-sm text-muted-foreground mt-1\">Выберите Excel или CSV файл для импорта</p>\n                </div>\n                <i className=\"fas fa-file-import text-muted-foreground text-xl\"></i>\n              </CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              {/* Drop Zone */}\n              <div \n                className={`border-2 border-dashed rounded-lg p-8 text-center transition-colors cursor-pointer ${\n                  dragActive ? 'border-primary bg-primary/5' : 'border-border hover:border-primary/50'\n                }`}\n                onDragEnter={handleDrag}\n                onDragLeave={handleDrag}\n                onDragOver={handleDrag}\n                onDrop={handleDrop}\n                onClick={() => document.getElementById('file-input')?.click()}\n                data-testid=\"drop-zone-file-upload\"\n              >\n                <i className=\"fas fa-cloud-arrow-up text-4xl text-muted-foreground mb-3\"></i>\n                <p className=\"text-sm font-medium text-foreground mb-1\">\n                  {selectedFile ? selectedFile.name : 'Перетащите файл сюда или нажмите для выбора'}\n                </p>\n                <p className=\"text-xs text-muted-foreground mb-4\">\n                  Только Excel (.xlsx, .xls) или CSV файлы\n                </p>\n                <Button variant=\"secondary\" size=\"sm\" data-testid=\"button-browse-files\">\n                  <i className=\"fas fa-folder-open mr-2\"></i>\n                  Выбрать файлы\n                </Button>\n                \n                <input\n                  id=\"file-input\"\n                  type=\"file\"\n                  className=\"hidden\"\n                  accept=\".xlsx,.xls,.csv\"\n                  onChange={handleFileInput}\n                />\n              </div>\n\n              {/* File Info */}\n              {selectedFile && (\n                <div className=\"flex items-center justify-between p-4 bg-muted rounded-lg\">\n                  <div className=\"flex items-center gap-3\">\n                    <i className=\"fas fa-file-excel text-green-600 text-xl\"></i>\n                    <div>\n                      <div className=\"font-medium text-sm\">{selectedFile.name}</div>\n                      <div className=\"text-xs text-muted-foreground\">\n                        {(selectedFile.size / 1024).toFixed(1)} КБ\n                      </div>\n                    </div>\n                  </div>\n                  <Button \n                    onClick={handleImport}\n                    disabled={importMutation.isPending}\n                    data-testid=\"button-start-import\"\n                  >\n                    {importMutation.isPending ? (\n                      <>\n                        <div className=\"w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin mr-2\"></div>\n                        Обработка...\n                      </>\n                    ) : (\n                      <>\n                        <i className=\"fas fa-upload mr-2\"></i>\n                        Начать импорт\n                      </>\n                    )}\n                  </Button>\n                </div>\n              )}\n\n              {/* Import Progress */}\n              {importMutation.isPending && (\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center justify-between text-sm\">\n                    <span>Обработка файла...</span>\n                    <span>Пожалуйста, подождите</span>\n                  </div>\n                  <Progress value={undefined} className=\"h-2\" />\n                </div>\n              )}\n            </CardContent>\n          </Card>\n\n          {/* Format Info & Template Download */}\n          <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6\">\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"text-sm flex items-center gap-2\">\n                  <i className=\"fas fa-info-circle text-primary\"></i>\n                  Ожидаемый формат\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-3 text-xs\">\n                  <div className=\"flex justify-between py-2 border-b\">\n                    <span className=\"font-medium\">Колонка</span>\n                    <span className=\"font-medium\">Обязательность</span>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span>article</span>\n                    <Badge variant=\"destructive\" className=\"text-xs\">Обязательно</Badge>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span>qty_delta</span>\n                    <Badge variant=\"destructive\" className=\"text-xs\">Обязательно</Badge>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span>reason</span>\n                    <Badge variant=\"destructive\" className=\"text-xs\">Обязательно</Badge>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span>note</span>\n                    <Badge variant=\"secondary\" className=\"text-xs\">Опционально</Badge>\n                  </div>\n                  <div className=\"flex justify-between\">\n                    <span>smart</span>\n                    <Badge variant=\"secondary\" className=\"text-xs\">Опционально</Badge>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"text-sm\">Скачать шаблон</CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <p className=\"text-xs text-muted-foreground\">\n                  Скачайте готовый шаблон Excel с примерами данных и заголовками колонок.\n                </p>\n                <Button \n                  variant=\"outline\" \n                  className=\"w-full\"\n                  onClick={() => downloadTemplateMutation.mutate()}\n                  disabled={downloadTemplateMutation.isPending}\n                  data-testid=\"button-download-template\"\n                >\n                  {downloadTemplateMutation.isPending ? (\n                    <>\n                      <div className=\"w-4 h-4 border-2 border-current border-t-transparent rounded-full animate-spin mr-2\"></div>\n                      Загрузка...\n                    </>\n                  ) : (\n                    <>\n                      <i className=\"fas fa-download mr-2\"></i>\n                      Скачать шаблон\n                    </>\n                  )}\n                </Button>\n              </CardContent>\n            </Card>\n          </div>\n\n          {/* Import Results */}\n          {importResult && (\n            <Card>\n              <CardHeader>\n                <CardTitle className=\"text-lg flex items-center gap-3\">\n                  {importResult.errors.length === 0 ? (\n                    <i className=\"fas fa-circle-check text-success text-xl\"></i>\n                  ) : importResult.imported > 0 ? (\n                    <i className=\"fas fa-triangle-exclamation text-warning text-xl\"></i>\n                  ) : (\n                    <i className=\"fas fa-circle-xmark text-destructive text-xl\"></i>\n                  )}\n                  Результаты импорта\n                </CardTitle>\n              </CardHeader>\n              <CardContent className=\"space-y-4\">\n                <div className=\"grid grid-cols-3 gap-4\">\n                  <div className=\"text-center p-4 bg-muted rounded-lg\">\n                    <div className=\"text-2xl font-bold font-mono\">{importResult.totalRows}</div>\n                    <div className=\"text-sm text-muted-foreground\">Всего строк</div>\n                  </div>\n                  <div className=\"text-center p-4 bg-success/10 rounded-lg\">\n                    <div className=\"text-2xl font-bold font-mono text-success\">{importResult.imported}</div>\n                    <div className=\"text-sm text-muted-foreground\">Импортировано</div>\n                  </div>\n                  <div className=\"text-center p-4 bg-destructive/10 rounded-lg\">\n                    <div className=\"text-2xl font-bold font-mono text-destructive\">{importResult.errors.length}</div>\n                    <div className=\"text-sm text-muted-foreground\">Ошибок</div>\n                  </div>\n                </div>\n\n                {importResult.errors.length > 0 && (\n                  <div className=\"space-y-2\">\n                    <h4 className=\"font-semibold text-sm flex items-center gap-2\">\n                      <i className=\"fas fa-exclamation-triangle text-destructive\"></i>\n                      Ошибки импорта\n                    </h4>\n                    <div className=\"space-y-2 max-h-60 overflow-y-auto\">\n                      {importResult.errors.map((error, index) => (\n                        <Alert key={index} variant=\"destructive\">\n                          <AlertDescription>\n                            <strong>Строка {error.row}:</strong> {error.error}\n                            <div className=\"text-xs mt-1 font-mono\">\n                              {JSON.stringify(error.data)}\n                            </div>\n                          </AlertDescription>\n                        </Alert>\n                      ))}\n                    </div>\n                  </div>\n                )}\n\n                {importResult.imported > 0 && (\n                  <Alert>\n                    <i className=\"fas fa-circle-check\"></i>\n                    <AlertDescription>\n                      Успешно импортировано: {importResult.imported} {importResult.imported === 1 ? 'движение' : importResult.imported < 5 ? 'движения' : 'движений'} в систему учёта.\n                    </AlertDescription>\n                  </Alert>\n                )}\n              </CardContent>\n            </Card>\n          )}\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":15649},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","size_bytes":5742},"replit.md":{"content":"# SMART Inventory Management System\n\n## Overview\n\nThis project is an internal inventory tracking system designed to link user-entered article codes with a standardized SMART reference database. It features robust fuzzy matching for article variants, maintains a complete movement history, and calculates current stock levels from transaction deltas. The system also includes financial tracking for purchase and sale operations, warehouse tracking (box numbers), and a two-phase sales workflow with shipping integration. A critical business logic ensures stock validation before sales/write-offs, preventing negative stock levels. The system automatically handles schema migrations and is localized entirely in Russian for internal network users.\n\n### Recent Fixes (November 2025)\n- **Connection Pool Exhaustion Fixed**: Resolved critical \"too many clients already\" error (PostgreSQL code 53300) in article search. Root cause was parallel connection creation for each search result via `Promise.all`. Implemented batch query method `getTotalStockBySmartBatch` that fetches all stock levels in ONE database query using `WHERE smart = ANY($1)` instead of creating hundreds of parallel connections. Search now creates maximum one inventory connection per request regardless of result count.\n- **Autofill Fixed**: URL parameter autofill now correctly uses `window.location.search` instead of wouter's location (which doesn't include query strings). Article and SMART code fields are automatically populated when navigating from search results.\n- **Complete E2E Workflow Validated**: Full purchase → sale → sold items page workflow tested and working correctly with all financial fields, shipping tracking, and status management.\n- **Stock Aggregation Fixed**: inventory.stock VIEW now correctly groups by SMART code only (not SMART+article), eliminating duplicate rows and summing quantities across all article variants.\n- **Zero Quantity Validation**: Added frontend and backend validation to prevent movements with qty_delta = 0. Error message displays below quantity field.\n- **Negative Stock Prevention**: getCurrentStock method now checks total by SMART code (not by article) to prevent overselling across all article variants.\n- **Zero Stock Items Hidden**: Added `HAVING SUM(qty_delta) > 0` to inventory.stock VIEW to automatically filter out items with zero or negative quantities from stock display. Stock table now shows only items currently in inventory.\n- **SMART Code Search Enhanced**: Search functionality now works for both SMART codes AND article codes (OR condition in SQL). Autocomplete displays SMART code first for better visibility.\n- **Runtime Errors Fixed (Two-Phase Solution)**: Eliminated \"cannot read property 'join' of null/undefined\" errors in search results display. **Phase 1 (Frontend)**: Added `Array.isArray()` checks before all `.join()` calls in DisambiguationModal, add-movement autocomplete, and article-search result display. **Phase 2 (Backend)**: Normalized data in `/api/articles/search` endpoint with `toArray()` helper that converts string values to singleton arrays (e.g., `\"YAMAHA\"` → `[\"YAMAHA\"]`), handles null gracefully, and ensures `brand`/`description` fields match frontend `ArticleSearchResult` type expectations. This two-phase approach prevents crashes while preserving data display fidelity for text fields stored in database.\n- **Button Colors Improved**: Quantity adjustment buttons changed from red/green to orange decrement (`text-orange-600`) and green increment (`text-green-600`) with outline variant for better UX.\n- **Duplicate Return Prevention**: Atomic transaction-level duplicate check prevents creating multiple return movements for the same sale. Check uses exact equality `note = 'Возврат продажи #<id>'` within SERIALIZABLE transaction. Server returns 409 Conflict with error message to frontend.\n- **Sale Price Clarification**: Label changed from \"Цена продажи\" to \"Цена за единицу товара\" with automatic total calculation display showing \"Общая сумма: X ₽\" (using |quantity| × price).\n- **Quantity Direction Validation**: Added frontend and backend validation to enforce correct quantity signs: Purchase/Return must be positive (+), Sale/Writeoff must be negative (-). Clear error messages prevent logical errors in inventory operations.\n- **Return Option Removed from Add Movement Form**: Removed \"Возврат\" from the reasons dropdown on Add Movement page. Returns are now created exclusively via \"Вернуть на склад\" button on Sold Items page, enforcing proper business logic that ties each return to its specific sale. Frontend filters `availableReasons` to exclude 'return' code. Backend maintains defensive validation for both purchase and return endpoints.\n- **Quantity Validation Auto-Trigger Fixed**: Fixed validation bugs in Add Movement form. Added `useEffect` to trigger validation when reason changes. Fixed `incrementQty`/`decrementQty` functions that were using stale `qtyInput` values due to closure bug. Now validation triggers immediately when quantity changes via buttons or direct input, preventing false validation errors.\n\n## User Preferences\n\nPreferred communication style: Simple, everyday language.\n\n## System Architecture\n\n### Frontend Architecture\n\n**Technology Stack:**\n- React with TypeScript\n- Vite for build tooling\n- Wouter for client-side routing\n- TanStack Query for server state management\n- shadcn/ui component library (Radix UI + Tailwind CSS)\n- React Hook Form with Zod for form management\n\n**Key Features:**\n- Component-based architecture with reusable UI primitives.\n- Live article autocomplete with debounced search and rich results display.\n- Auto-filling of movement forms from search results via URL parameters.\n- Modal-based disambiguation for multiple SMART code matches.\n- Full UI localization in Russian.\n- Pages include Dashboard, Article Search, Add Movement, Stock Levels, Movement History, Bulk Import, and Database Connections.\n\n### Backend Architecture\n\n**Technology Stack:**\n- Express.js server with TypeScript (Node.js runtime, ESM modules)\n- Drizzle ORM for local database interactions\n- PostgreSQL database (standard `pg` driver)\n- Multer for file uploads\n- XLSX library for spreadsheet parsing\n\n**Key Design Patterns:**\n- Repository pattern with storage abstraction.\n- Dual database connection strategy (read-only for SMART, read-write for inventory).\n- Server-side normalization logic for fuzzy article matching.\n- RESTful API endpoints.\n- Automatic schema migration and seed data on startup.\n- Critical stock validation with `InsufficientStockError` and `SERIALIZABLE` transactions to prevent negative stock.\n- Automatic retry with exponential backoff for serialization conflicts.\n\n**API Structure:**\n- Endpoints for article search, SMART code retrieval, inventory movements (record, history), stock levels, bulk import, reasons, dashboard stats, and database connection management (create, delete, test, get tables).\n\n### Data Storage Solutions\n\n**Database Schema (PostgreSQL):**\n- **External SMART Database:** `public.smart` table (read-only) stores SMART codes, article arrays, product names, brands, and other metadata. Configurable field mapping allows dynamic adaptation.\n- **Inventory Schema:**\n  - `inventory.reasons`: Lookup table for transaction types (purchase, sale, return, writeoff).\n  - `inventory.movements`: Transaction log including `smart` code, original `article`, `qty_delta`, `reason`, `note`, `created_at`, `purchasePrice`, `salePrice`, `deliveryPrice`, `boxNumber`, `trackNumber`, `shippingMethodId`, `saleStatus`.\n  - `inventory.stock` view: Aggregates movements for current stock levels.\n  - `inventory.shipping_methods`: Stores available shipping methods.\n  - `inventory.db_connections`: Stores database connection credentials (securely managed).\n\n**Normalization Strategy:**\n- Three-step normalization for search (uppercase, delimiter removal, Cyrillic-to-Latin) is applied on the fly, preserving original user input in the database.\n- Uses `unnest()` with regex for partial and fuzzy matching on VARCHAR arrays.\n\n## External Dependencies\n\n**Database:**\n- PostgreSQL database via standard `pg` driver with connection pooling.\n- Local inventory database (configured via `DATABASE_URL`).\n- External SMART database (e.g., `parts_admin@81.30.105.134:5403`).\n- Drizzle ORM for local database, raw `pg.Pool` for dynamic external connections.\n\n**Third-Party Libraries:**\n- Radix UI: Accessible component primitives.\n- TanStack Query: Server state synchronization.\n- React Hook Form: Form state management.\n- Zod: Runtime type validation.\n- XLSX: Excel/CSV parsing.\n- date-fns: Date utilities.\n\n**Build Tools:**\n- Vite, esbuild, TypeScript compiler, PostCSS with Tailwind.","size_bytes":8803},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n:root {\n  --background: hsl(210, 40%, 98%);\n  --foreground: hsl(222, 47%, 11%);\n  --card: hsl(0, 0%, 100%);\n  --card-foreground: hsl(222, 47%, 11%);\n  --popover: hsl(0, 0%, 100%);\n  --popover-foreground: hsl(222, 47%, 11%);\n  --primary: hsl(221, 83%, 53%);\n  --primary-foreground: hsl(0, 0%, 100%);\n  --secondary: hsl(215, 20%, 65%);\n  --secondary-foreground: hsl(222, 47%, 11%);\n  --muted: hsl(210, 40%, 96%);\n  --muted-foreground: hsl(215, 16%, 47%);\n  --accent: hsl(210, 40%, 96%);\n  --accent-foreground: hsl(222, 47%, 11%);\n  --destructive: hsl(0, 84%, 60%);\n  --destructive-foreground: hsl(0, 0%, 100%);\n  --border: hsl(214, 32%, 91%);\n  --input: hsl(214, 32%, 91%);\n  --ring: hsl(221, 83%, 53%);\n  --success: hsl(142, 71%, 45%);\n  --success-foreground: hsl(0, 0%, 100%);\n  --warning: hsl(38, 92%, 50%);\n  --warning-foreground: hsl(0, 0%, 100%);\n  --chart-1: hsl(221, 83%, 53%);\n  --chart-2: hsl(142, 71%, 45%);\n  --chart-3: hsl(38, 92%, 50%);\n  --chart-4: hsl(147, 71%, 42%);\n  --chart-5: hsl(341, 75%, 51%);\n  --sidebar: hsl(0, 0%, 100%);\n  --sidebar-foreground: hsl(222, 47%, 11%);\n  --sidebar-primary: hsl(221, 83%, 53%);\n  --sidebar-primary-foreground: hsl(0, 0%, 100%);\n  --sidebar-accent: hsl(210, 40%, 96%);\n  --sidebar-accent-foreground: hsl(222, 47%, 11%);\n  --sidebar-border: hsl(214, 32%, 91%);\n  --sidebar-ring: hsl(221, 83%, 53%);\n  --font-sans: 'Inter', system-ui, sans-serif;\n  --font-serif: Georgia, serif;\n  --font-mono: 'JetBrains Mono', monospace;\n  --radius: 0.5rem;\n  --shadow-2xs: 0px 1px 2px 0px hsl(0, 0%, 0%, 0.05);\n  --shadow-xs: 0px 1px 2px 0px hsl(0, 0%, 0%, 0.05);\n  --shadow-sm: 0px 1px 2px 0px hsl(0, 0%, 0%, 0.05), 0px 1px 3px 0px hsl(0, 0%, 0%, 0.1);\n  --shadow: 0px 1px 2px 0px hsl(0, 0%, 0%, 0.05), 0px 1px 3px 0px hsl(0, 0%, 0%, 0.1);\n  --shadow-md: 0px 2px 4px 0px hsl(0, 0%, 0%, 0.05), 0px 1px 10px 0px hsl(0, 0%, 0%, 0.1);\n  --shadow-lg: 0px 4px 6px 0px hsl(0, 0%, 0%, 0.05), 0px 10px 15px 0px hsl(0, 0%, 0%, 0.1);\n  --shadow-xl: 0px 8px 10px 0px hsl(0, 0%, 0%, 0.05), 0px 20px 25px 0px hsl(0, 0%, 0%, 0.1);\n  --shadow-2xl: 0px 25px 50px 0px hsl(0, 0%, 0%, 0.25);\n  --tracking-normal: 0em;\n  --spacing: 0.25rem;\n}\n\n.dark {\n  --background: hsl(222, 47%, 11%);\n  --foreground: hsl(210, 40%, 98%);\n  --card: hsl(228, 9%, 10%);\n  --card-foreground: hsl(210, 40%, 98%);\n  --popover: hsl(228, 9%, 10%);\n  --popover-foreground: hsl(210, 40%, 98%);\n  --primary: hsl(221, 83%, 53%);\n  --primary-foreground: hsl(0, 0%, 100%);\n  --secondary: hsl(215, 20%, 35%);\n  --secondary-foreground: hsl(210, 40%, 98%);\n  --muted: hsl(228, 9%, 15%);\n  --muted-foreground: hsl(215, 16%, 57%);\n  --accent: hsl(228, 9%, 15%);\n  --accent-foreground: hsl(210, 40%, 98%);\n  --destructive: hsl(0, 84%, 60%);\n  --destructive-foreground: hsl(0, 0%, 100%);\n  --border: hsl(228, 9%, 20%);\n  --input: hsl(228, 9%, 20%);\n  --ring: hsl(221, 83%, 53%);\n  --success: hsl(142, 71%, 45%);\n  --success-foreground: hsl(0, 0%, 100%);\n  --warning: hsl(38, 92%, 50%);\n  --warning-foreground: hsl(0, 0%, 100%);\n  --sidebar: hsl(228, 9%, 10%);\n  --sidebar-foreground: hsl(210, 40%, 98%);\n  --sidebar-primary: hsl(221, 83%, 53%);\n  --sidebar-primary-foreground: hsl(0, 0%, 100%);\n  --sidebar-accent: hsl(228, 9%, 15%);\n  --sidebar-accent-foreground: hsl(210, 40%, 98%);\n  --sidebar-border: hsl(228, 9%, 20%);\n  --sidebar-ring: hsl(221, 83%, 53%);\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply bg-background text-foreground font-sans antialiased;\n  }\n  \n  .sidebar-link {\n    @apply transition-all duration-200;\n  }\n\n  .sidebar-link:hover {\n    @apply bg-accent;\n  }\n\n  .sidebar-link.active {\n    @apply bg-primary text-primary-foreground;\n  }\n\n  .table-row:hover {\n    @apply bg-muted/50;\n  }\n\n  .card-shadow {\n    @apply shadow-sm;\n  }\n\n  .stat-card {\n    @apply transition-transform duration-200 hover:shadow-lg;\n  }\n\n  .stat-card:hover {\n    @apply -translate-y-1;\n  }\n\n  .modal-backdrop {\n    @apply bg-black/50;\n    backdrop-filter: blur(4px);\n  }\n\n  .spinner {\n    @apply border-2 border-border border-t-primary rounded-full w-5 h-5 animate-spin;\n  }\n\n  .toast {\n    @apply animate-in slide-in-from-right;\n  }\n\n  /* Custom scrollbar */\n  ::-webkit-scrollbar {\n    @apply w-2 h-2;\n  }\n\n  ::-webkit-scrollbar-track {\n    @apply bg-muted;\n  }\n\n  ::-webkit-scrollbar-thumb {\n    @apply bg-secondary rounded;\n  }\n\n  ::-webkit-scrollbar-thumb:hover {\n    @apply bg-muted-foreground;\n  }\n}\n","size_bytes":4473},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","size_bytes":4885},"client/src/pages/dashboard.tsx":{"content":"import { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { useState } from \"react\";\nimport { Link } from \"wouter\";\nimport type { StockLevel, Movement } from \"@shared/schema\";\n\nexport default function Dashboard() {\n  const [searchQuery, setSearchQuery] = useState(\"\");\n\n  const { data: stats, isLoading: statsLoading } = useQuery<{\n    totalArticles: number;\n    inStock: number;\n    movementsToday: number;\n    lowStockAlerts: number;\n  }>({\n    queryKey: [\"/api/dashboard/stats\"],\n  });\n\n  const { data: stockLevels, isLoading: stockLoading } = useQuery({\n    queryKey: [\"/api/stock\"],\n  });\n\n  const { data: movements, isLoading: movementsLoading } = useQuery({\n    queryKey: [\"/api/movements\"],\n  });\n\n  const getStockStatus = (qty: number) => {\n    if (qty === 0) return { label: \"Нет в наличии\", variant: \"destructive\" as const, icon: \"fas fa-circle-xmark\" };\n    if (qty <= 10) return { label: \"Мало\", variant: \"secondary\" as const, icon: \"fas fa-triangle-exclamation\" };\n    return { label: \"В наличии\", variant: \"default\" as const, icon: \"fas fa-circle\" };\n  };\n\n  const getReasonVariant = (reason: string) => {\n    switch (reason) {\n      case 'purchase': return 'default';\n      case 'sale': return 'secondary';\n      case 'return': return 'outline';\n      case 'adjust': return 'secondary';\n      case 'writeoff': return 'destructive';\n      default: return 'secondary';\n    }\n  };\n\n  return (\n    <div className=\"flex-1 overflow-y-auto\">\n      {/* Header */}\n      <header className=\"bg-card border-b border-border sticky top-0 z-10\">\n        <div className=\"px-8 py-4 flex items-center justify-between\">\n          <div>\n            <h2 className=\"text-2xl font-bold text-foreground\">Главная</h2>\n            <p className=\"text-sm text-muted-foreground mt-1\">Общий обзор и операции в реальном времени</p>\n          </div>\n          <div className=\"flex items-center gap-4\">\n            <div className=\"relative\">\n              <Input \n                type=\"text\" \n                placeholder=\"Быстрый поиск артикула...\" \n                className=\"w-64 pl-10 font-mono\" \n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                data-testid=\"input-quick-search\"\n              />\n              <i className=\"fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground\"></i>\n            </div>\n            <Link href=\"/movement\">\n              <Button className=\"gap-2\" data-testid=\"button-quick-add\">\n                <i className=\"fas fa-plus\"></i>\n                Быстрое добавление\n              </Button>\n            </Link>\n          </div>\n        </div>\n      </header>\n\n      <div className=\"p-8\">\n        {/* Stats Grid */}\n        <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8\">\n          <Card className=\"hover:shadow-lg transition-shadow\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-start justify-between mb-4\">\n                <div className=\"w-12 h-12 rounded-lg bg-primary/10 flex items-center justify-center\">\n                  <i className=\"fas fa-box text-primary text-xl\"></i>\n                </div>\n                <Badge variant=\"secondary\" className=\"bg-success/10 text-success\">\n                  <i className=\"fas fa-arrow-up mr-1\"></i>\n                  Активно\n                </Badge>\n              </div>\n              {statsLoading ? (\n                <Skeleton className=\"h-8 w-20 mb-1\" />\n              ) : (\n                <h3 className=\"text-2xl font-bold text-foreground mb-1 font-mono\">{stats?.totalArticles || 0}</h3>\n              )}\n              <p className=\"text-sm text-muted-foreground\">Всего артикулов</p>\n            </CardContent>\n          </Card>\n\n          <Card className=\"hover:shadow-lg transition-shadow\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-start justify-between mb-4\">\n                <div className=\"w-12 h-12 rounded-lg bg-success/10 flex items-center justify-center\">\n                  <i className=\"fas fa-arrow-trend-up text-success text-xl\"></i>\n                </div>\n                <Badge variant=\"secondary\" className=\"bg-success/10 text-success\">\n                  <i className=\"fas fa-check mr-1\"></i>\n                  Активно\n                </Badge>\n              </div>\n              {statsLoading ? (\n                <Skeleton className=\"h-8 w-20 mb-1\" />\n              ) : (\n                <h3 className=\"text-2xl font-bold text-foreground mb-1 font-mono\">{stats?.inStock || 0}</h3>\n              )}\n              <p className=\"text-sm text-muted-foreground\">В наличии</p>\n            </CardContent>\n          </Card>\n\n          <Card className=\"hover:shadow-lg transition-shadow\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-start justify-between mb-4\">\n                <div className=\"w-12 h-12 rounded-lg bg-secondary/10 flex items-center justify-center\">\n                  <i className=\"fas fa-clock text-secondary text-xl\"></i>\n                </div>\n                <Badge variant=\"secondary\" className=\"bg-muted text-muted-foreground\">\n                  Сегодня\n                </Badge>\n              </div>\n              {statsLoading ? (\n                <Skeleton className=\"h-8 w-20 mb-1\" />\n              ) : (\n                <h3 className=\"text-2xl font-bold text-foreground mb-1 font-mono\">{stats?.movementsToday || 0}</h3>\n              )}\n              <p className=\"text-sm text-muted-foreground\">Движений сегодня</p>\n            </CardContent>\n          </Card>\n\n          <Card className=\"hover:shadow-lg transition-shadow\">\n            <CardContent className=\"p-6\">\n              <div className=\"flex items-start justify-between mb-4\">\n                <div className=\"w-12 h-12 rounded-lg bg-destructive/10 flex items-center justify-center\">\n                  <i className=\"fas fa-exclamation-triangle text-destructive text-xl\"></i>\n                </div>\n                <Badge variant=\"destructive\" className=\"bg-destructive/10 text-destructive\">\n                  <i className=\"fas fa-arrow-down mr-1\"></i>\n                  Внимание\n                </Badge>\n              </div>\n              {statsLoading ? (\n                <Skeleton className=\"h-8 w-20 mb-1\" />\n              ) : (\n                <h3 className=\"text-2xl font-bold text-foreground mb-1 font-mono\">{stats?.lowStockAlerts || 0}</h3>\n              )}\n              <p className=\"text-sm text-muted-foreground\">Критический остаток</p>\n            </CardContent>\n          </Card>\n        </div>\n\n        <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8\">\n          {/* Stock Levels Preview */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center justify-between\">\n                <div>\n                  <div className=\"text-lg font-semibold text-foreground\">Текущие остатки</div>\n                  <CardDescription>Топ позиций на складе</CardDescription>\n                </div>\n                <Link href=\"/stock\">\n                  <Button variant=\"ghost\" size=\"sm\" data-testid=\"link-view-all-stock\">\n                    Все остатки\n                    <i className=\"fas fa-arrow-right ml-2\"></i>\n                  </Button>\n                </Link>\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              {stockLoading ? (\n                <div className=\"space-y-3\">\n                  {[...Array(5)].map((_, i) => (\n                    <div key={i} className=\"flex items-center justify-between p-3 rounded border\">\n                      <div className=\"space-y-2\">\n                        <Skeleton className=\"h-4 w-24\" />\n                        <Skeleton className=\"h-3 w-32\" />\n                      </div>\n                      <Skeleton className=\"h-6 w-16\" />\n                    </div>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"space-y-3\">\n                  {(stockLevels as StockLevel[] || []).slice(0, 5).map((item) => {\n                    const status = getStockStatus(item.totalQty);\n                    return (\n                      <div key={`${item.smart}-${item.article}`} className=\"flex items-center justify-between p-3 rounded border hover:bg-muted/50 transition-colors\">\n                        <div>\n                          <div className=\"font-mono font-semibold text-sm\">{item.smart}</div>\n                          <div className=\"text-xs text-muted-foreground\">{item.description}</div>\n                        </div>\n                        <div className=\"text-right\">\n                          <div className=\"font-mono font-semibold\">{item.totalQty}</div>\n                          <Badge variant={status.variant} className=\"text-xs\">\n                            <i className={`${status.icon} text-xs mr-1`}></i>\n                            {status.label}\n                          </Badge>\n                        </div>\n                      </div>\n                    );\n                  })}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n\n          {/* Recent Movements */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center justify-between\">\n                <div>\n                  <div className=\"text-lg font-semibold text-foreground\">Последние движения</div>\n                  <CardDescription>Недавние изменения остатков</CardDescription>\n                </div>\n                <Link href=\"/history\">\n                  <Button variant=\"ghost\" size=\"sm\" data-testid=\"link-view-all-movements\">\n                    Вся история\n                    <i className=\"fas fa-arrow-right ml-2\"></i>\n                  </Button>\n                </Link>\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              {movementsLoading ? (\n                <div className=\"space-y-3\">\n                  {[...Array(5)].map((_, i) => (\n                    <div key={i} className=\"flex items-center justify-between p-3 rounded border\">\n                      <div className=\"space-y-2\">\n                        <Skeleton className=\"h-4 w-24\" />\n                        <Skeleton className=\"h-3 w-32\" />\n                      </div>\n                      <Skeleton className=\"h-6 w-16\" />\n                    </div>\n                  ))}\n                </div>\n              ) : (\n                <div className=\"space-y-3\">\n                  {(movements as Movement[] || []).slice(0, 5).map((movement) => (\n                    <div key={movement.id} className=\"flex items-center justify-between p-3 rounded border hover:bg-muted/50 transition-colors\">\n                      <div>\n                        <div className=\"font-mono font-semibold text-sm\">{movement.smart}</div>\n                        <div className=\"text-xs text-muted-foreground\">\n                          {new Date(movement.createdAt).toLocaleString()}\n                        </div>\n                      </div>\n                      <div className=\"text-right space-y-1\">\n                        <div className={`font-mono font-semibold ${movement.qtyDelta >= 0 ? 'text-success' : 'text-destructive'}`}>\n                          {movement.qtyDelta >= 0 ? '+' : ''}{movement.qtyDelta}\n                        </div>\n                        <Badge variant={getReasonVariant(movement.reason)} className=\"text-xs\">\n                          {movement.reason}\n                        </Badge>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":12434},"client/src/pages/stock-levels.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Link } from \"wouter\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport type { StockLevel } from \"@shared/schema\";\n\nexport default function StockLevels() {\n  const [filter, setFilter] = useState(\"\");\n\n  const { data: stockLevels, isLoading } = useQuery({\n    queryKey: [\"/api/stock\"],\n  });\n\n  const filteredStock = (stockLevels as StockLevel[] || []).filter(item => {\n    const filterLower = filter.toLowerCase();\n    const matchesBrand = item.brand ? \n      (Array.isArray(item.brand) ? \n        item.brand.some(b => b.toLowerCase().includes(filterLower)) : \n        item.brand.toLowerCase().includes(filterLower)) : \n      false;\n    const matchesDescription = item.description ? \n      (Array.isArray(item.description) ? \n        item.description.some(d => d.toLowerCase().includes(filterLower)) : \n        item.description.toLowerCase().includes(filterLower)) : \n      false;\n    \n    return item.smart.toLowerCase().includes(filterLower) ||\n      matchesBrand ||\n      matchesDescription;\n  });\n\n  const getStockStatus = (qty: number) => {\n    if (qty === 0) return { label: \"Нет в наличии\", variant: \"destructive\" as const, icon: \"fas fa-circle-xmark\" };\n    if (qty <= 10) return { label: \"Мало\", variant: \"secondary\" as const, icon: \"fas fa-triangle-exclamation\" };\n    return { label: \"В наличии\", variant: \"default\" as const, icon: \"fas fa-circle\" };\n  };\n\n  return (\n    <div className=\"flex-1 overflow-y-auto\">\n      <header className=\"bg-card border-b border-border sticky top-0 z-10\">\n        <div className=\"px-8 py-4\">\n          <h2 className=\"text-2xl font-bold text-foreground\">Остатки</h2>\n          <p className=\"text-sm text-muted-foreground mt-1\">Текущие остатки из представления inventory.stock</p>\n        </div>\n      </header>\n\n      <div className=\"p-8\">\n        <Card>\n          <CardHeader>\n            <div className=\"flex items-center justify-between\">\n              <CardTitle>Текущие остатки</CardTitle>\n              <div className=\"flex items-center gap-3\">\n                <div className=\"relative\">\n                  <Input\n                    placeholder=\"Фильтр артикулов...\"\n                    className=\"w-48 pl-9 text-sm\"\n                    value={filter}\n                    onChange={(e) => setFilter(e.target.value)}\n                    data-testid=\"input-filter-stock\"\n                  />\n                  <i className=\"fas fa-filter absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground text-xs\"></i>\n                </div>\n                <Button variant=\"secondary\" size=\"sm\" data-testid=\"button-export-stock\">\n                  <i className=\"fas fa-download mr-2\"></i>\n                  Экспорт\n                </Button>\n              </div>\n            </div>\n          </CardHeader>\n          <CardContent>\n            <div className=\"rounded-md border\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead className=\"w-[150px]\">\n                      <Button variant=\"ghost\" size=\"sm\" className=\"h-auto p-0 font-medium\" data-testid=\"button-sort-smart\">\n                        SMART код\n                        <i className=\"fas fa-sort text-xs ml-2\"></i>\n                      </Button>\n                    </TableHead>\n                    <TableHead>Бренд</TableHead>\n                    <TableHead>Описание</TableHead>\n                    <TableHead className=\"text-right\">\n                      <Button variant=\"ghost\" size=\"sm\" className=\"h-auto p-0 font-medium ml-auto\" data-testid=\"button-sort-qty\">\n                        Кол-во\n                        <i className=\"fas fa-sort text-xs ml-2\"></i>\n                      </Button>\n                    </TableHead>\n                    <TableHead className=\"text-center\">Статус</TableHead>\n                    <TableHead className=\"text-right\">Действия</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {isLoading ? (\n                    [...Array(10)].map((_, i) => (\n                      <TableRow key={i}>\n                        <TableCell><Skeleton className=\"h-4 w-24\" /></TableCell>\n                        <TableCell><Skeleton className=\"h-4 w-20\" /></TableCell>\n                        <TableCell><Skeleton className=\"h-4 w-40\" /></TableCell>\n                        <TableCell><Skeleton className=\"h-4 w-16 ml-auto\" /></TableCell>\n                        <TableCell><Skeleton className=\"h-6 w-20 mx-auto\" /></TableCell>\n                        <TableCell><Skeleton className=\"h-8 w-16 ml-auto\" /></TableCell>\n                      </TableRow>\n                    ))\n                  ) : filteredStock.length === 0 ? (\n                    <TableRow>\n                      <TableCell colSpan={6} className=\"text-center py-8 text-muted-foreground\">\n                        {filter ? \"Нет совпадений с фильтром\" : \"Нет данных об остатках\"}\n                      </TableCell>\n                    </TableRow>\n                  ) : (\n                    filteredStock.map((item) => {\n                      const status = getStockStatus(item.totalQty);\n                      return (\n                        <TableRow key={item.smart} className=\"hover:bg-muted/50\">\n                          <TableCell className=\"font-mono font-semibold\">{item.smart}</TableCell>\n                          <TableCell>{item.brand || \"—\"}</TableCell>\n                          <TableCell className=\"max-w-xs truncate\">{item.description || \"—\"}</TableCell>\n                          <TableCell className=\"text-right font-mono font-semibold\">{item.totalQty}</TableCell>\n                          <TableCell className=\"text-center\">\n                            <Badge variant={status.variant} className=\"text-xs\">\n                              <i className={`${status.icon} text-xs mr-1`}></i>\n                              {status.label}\n                            </Badge>\n                          </TableCell>\n                          <TableCell className=\"text-right\">\n                            <div className=\"flex items-center justify-end gap-2\">\n                              <Link href={`/stock/${item.smart}`}>\n                                <Button\n                                  variant=\"ghost\"\n                                  size=\"sm\"\n                                  className=\"h-8 w-8 p-0\"\n                                  data-testid={`button-view-${item.smart}`}\n                                >\n                                  <i className=\"fas fa-eye text-xs\"></i>\n                                </Button>\n                              </Link>\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                className=\"h-8 w-8 p-0\"\n                                data-testid={`button-add-movement-${item.smart}`}\n                              >\n                                <i className=\"fas fa-plus text-xs\"></i>\n                              </Button>\n                            </div>\n                          </TableCell>\n                        </TableRow>\n                      );\n                    })\n                  )}\n                </TableBody>\n              </Table>\n            </div>\n            \n            {!isLoading && (\n              <div className=\"flex items-center justify-between px-2 py-4\">\n                <div className=\"text-sm text-muted-foreground\">\n                  Показано <span className=\"font-semibold text-foreground\">{filteredStock.length}</span> позиций\n                  {filter && <span> (отфильтровано из {(stockLevels as StockLevel[] || []).length} всего)</span>}\n                </div>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","size_bytes":8455},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","size_bytes":565},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","size_bytes":7609},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","size_bytes":756},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  \"inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground hover:bg-primary/80\",\n        secondary:\n          \"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80\",\n        outline: \"text-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  )\n}\n\nexport { Badge, badgeVariants }\n","size_bytes":1128},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","size_bytes":4120},"server/db.ts":{"content":"import { Pool } from 'pg';\nimport { drizzle } from 'drizzle-orm/node-postgres';\nimport * as schema from \"@shared/schema\";\n\n// For demo purposes, use the same database for both parts and inventory\n// In production, these would be separate databases\nconst pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n});\n\nexport const partsDb = drizzle(pool, { schema });\nexport const inventoryDb = drizzle(pool, { schema });\n\n// Initialize inventory database schema\nexport async function initializeInventoryDb() {\n  try {\n    // SMART reference table will be accessed from configured database connection\n    // No longer creating or inserting mock data - all data must come from connected DB\n    \n    // Create inventory schema\n    await pool.query(`CREATE SCHEMA IF NOT EXISTS inventory`);\n    \n    // Create reasons table with fixed data\n    await pool.query(`\n      CREATE TABLE IF NOT EXISTS inventory.reasons (\n        code VARCHAR PRIMARY KEY,\n        title TEXT NOT NULL\n      )\n    `);\n    \n    // Insert fixed reasons\n    await pool.query(`\n      INSERT INTO inventory.reasons (code, title) VALUES\n        ('purchase', 'Добавление нового товара'),\n        ('sale', 'Продажа'),\n        ('return', 'Возврат'),\n        ('writeoff', 'Списание')\n      ON CONFLICT (code) DO NOTHING\n    `);\n    \n    // Remove old 'adjust' reason if exists\n    await pool.query(`DELETE FROM inventory.reasons WHERE code = 'adjust'`);\n    \n    // Create shipping_methods table\n    await pool.query(`\n      CREATE TABLE IF NOT EXISTS inventory.shipping_methods (\n        id SERIAL PRIMARY KEY,\n        name TEXT NOT NULL,\n        created_at TIMESTAMP DEFAULT NOW() NOT NULL\n      )\n    `);\n    \n    // Insert default shipping methods\n    await pool.query(`\n      INSERT INTO inventory.shipping_methods (name) VALUES\n        ('Почта России'),\n        ('Яндекс'),\n        ('СДЭК'),\n        ('Авито доставка')\n      ON CONFLICT DO NOTHING\n    `);\n    \n    // Create movements table\n    await pool.query(`\n      CREATE TABLE IF NOT EXISTS inventory.movements (\n        id SERIAL PRIMARY KEY,\n        smart VARCHAR NOT NULL,\n        article TEXT NOT NULL,\n        qty_delta INTEGER NOT NULL,\n        reason VARCHAR NOT NULL,\n        note TEXT,\n        purchase_price NUMERIC(10, 2),\n        sale_price NUMERIC(10, 2),\n        delivery_price NUMERIC(10, 2),\n        box_number VARCHAR(50),\n        track_number TEXT,\n        shipping_method_id INTEGER,\n        sale_status VARCHAR(50),\n        created_at TIMESTAMP DEFAULT NOW() NOT NULL,\n        FOREIGN KEY (reason) REFERENCES inventory.reasons(code),\n        FOREIGN KEY (shipping_method_id) REFERENCES inventory.shipping_methods(id)\n      )\n    `);\n    \n    // Create stock VIEW (grouped by SMART code only to aggregate across all articles)\n    await pool.query(`\n      CREATE OR REPLACE VIEW inventory.stock AS\n      SELECT \n        smart,\n        SUM(qty_delta) as total_qty\n      FROM inventory.movements\n      GROUP BY smart\n      HAVING SUM(qty_delta) > 0\n    `);\n    \n    console.log('Inventory database initialized successfully');\n  } catch (error) {\n    console.error('Failed to initialize inventory database:', error);\n    throw error;\n  }\n}\n\n// Initialize or update schema on external database\nexport async function ensureExternalDbSchema(connectionDetails: any) {\n  const externalPool = new Pool({\n    host: connectionDetails.host,\n    port: connectionDetails.port,\n    database: connectionDetails.database,\n    user: connectionDetails.username,\n    password: connectionDetails.password,\n    ssl: connectionDetails.ssl ? { rejectUnauthorized: false } : undefined,\n  });\n\n  try {\n    // Create inventory schema\n    await externalPool.query(`CREATE SCHEMA IF NOT EXISTS inventory`);\n    \n    // Create reasons table with fixed data\n    await externalPool.query(`\n      CREATE TABLE IF NOT EXISTS inventory.reasons (\n        code VARCHAR PRIMARY KEY,\n        title TEXT NOT NULL\n      )\n    `);\n    \n    // Insert fixed reasons\n    await externalPool.query(`\n      INSERT INTO inventory.reasons (code, title) VALUES\n        ('purchase', 'Добавление нового товара'),\n        ('sale', 'Продажа'),\n        ('return', 'Возврат'),\n        ('writeoff', 'Списание')\n      ON CONFLICT (code) DO NOTHING\n    `);\n    \n    // Update any movements using old 'adjust' reason to 'purchase'\n    await externalPool.query(`\n      UPDATE inventory.movements \n      SET reason = 'purchase' \n      WHERE reason = 'adjust'\n    `);\n    \n    // Remove old 'adjust' reason if exists\n    await externalPool.query(`DELETE FROM inventory.reasons WHERE code = 'adjust'`);\n    \n    // Create shipping_methods table\n    await externalPool.query(`\n      CREATE TABLE IF NOT EXISTS inventory.shipping_methods (\n        id SERIAL PRIMARY KEY,\n        name TEXT NOT NULL,\n        created_at TIMESTAMP DEFAULT NOW() NOT NULL\n      )\n    `);\n    \n    // Insert default shipping methods only if table is empty\n    const result = await externalPool.query(`SELECT COUNT(*) FROM inventory.shipping_methods`);\n    if (parseInt(result.rows[0].count) === 0) {\n      await externalPool.query(`\n        INSERT INTO inventory.shipping_methods (name) VALUES\n          ('Почта России'),\n          ('Яндекс'),\n          ('СДЭК'),\n          ('Авито доставка')\n      `);\n    }\n    \n    // Create movements table\n    await externalPool.query(`\n      CREATE TABLE IF NOT EXISTS inventory.movements (\n        id SERIAL PRIMARY KEY,\n        smart VARCHAR NOT NULL,\n        article TEXT NOT NULL,\n        qty_delta INTEGER NOT NULL,\n        reason VARCHAR NOT NULL,\n        note TEXT,\n        created_at TIMESTAMP DEFAULT NOW() NOT NULL\n      )\n    `);\n    \n    // Add new columns to movements table if they don't exist\n    const columns = [\n      { name: 'purchase_price', type: 'NUMERIC(10, 2)' },\n      { name: 'sale_price', type: 'NUMERIC(10, 2)' },\n      { name: 'delivery_price', type: 'NUMERIC(10, 2)' },\n      { name: 'box_number', type: 'VARCHAR(50)' },\n      { name: 'track_number', type: 'TEXT' },\n      { name: 'shipping_method_id', type: 'INTEGER' },\n      { name: 'sale_status', type: 'VARCHAR(50)' }\n    ];\n    \n    for (const column of columns) {\n      await externalPool.query(`\n        ALTER TABLE inventory.movements \n        ADD COLUMN IF NOT EXISTS ${column.name} ${column.type}\n      `);\n    }\n    \n    // Create stock VIEW (grouped by SMART code only to aggregate across all articles)\n    await externalPool.query(`\n      CREATE OR REPLACE VIEW inventory.stock AS\n      SELECT \n        smart,\n        SUM(qty_delta) as total_qty\n      FROM inventory.movements\n      GROUP BY smart\n      HAVING SUM(qty_delta) > 0\n    `);\n    \n    console.log('External database schema updated successfully');\n  } catch (error) {\n    console.error('Failed to update external database schema:', error);\n    throw error;\n  } finally {\n    await externalPool.end();\n  }\n}\n","size_bytes":7016},"shared/normalization.ts":{"content":"/**\n * Normalizes article codes for fuzzy matching\n * 1. Convert to uppercase\n * 2. Remove delimiters (space, -, _, ., /)\n * 3. Replace Cyrillic characters with Latin equivalents\n */\nexport function normalizeArticle(article: string): string {\n  if (!article) return '';\n  \n  // Step 1: Convert to uppercase\n  let normalized = article.toUpperCase();\n  \n  // Step 2: Remove delimiters\n  normalized = normalized.replace(/[\\s\\-_./]/g, '');\n  \n  // Step 3: Replace Cyrillic with Latin\n  const cyrillicToLatin: { [key: string]: string } = {\n    'А': 'A',\n    'В': 'B',\n    'Е': 'E',\n    'К': 'K',\n    'М': 'M',\n    'Н': 'H',\n    'О': 'O',\n    'Р': 'P',\n    'С': 'C',\n    'Т': 'T',\n    'У': 'Y',\n    'Х': 'X',\n    'Ё': 'E',\n  };\n  \n  normalized = normalized.replace(/[АВЕКМНОРСТУХЁ]/g, (char) => {\n    return cyrillicToLatin[char] || char;\n  });\n  \n  return normalized;\n}\n\n/**\n * Checks if two articles match after normalization\n */\nexport function articlesMatch(article1: string, article2: string): boolean {\n  return normalizeArticle(article1) === normalizeArticle(article2);\n}\n","size_bytes":1099},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","size_bytes":6210},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","size_bytes":5128},"client/src/pages/sold-items.tsx":{"content":"import { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { Movement } from \"@shared/schema\";\n\nexport default function SoldItems() {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const { data: movements = [], isLoading } = useQuery<Movement[]>({\n    queryKey: [\"/api/movements\"],\n  });\n\n  const markAsShippedMutation = useMutation({\n    mutationFn: async (movementId: number) => {\n      const response = await apiRequest(\"PATCH\", `/api/movements/${movementId}/ship`, {});\n      return response.json();\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/movements\"] });\n      toast({\n        title: \"Статус обновлен\",\n        description: \"Товар помечен как отправленный\",\n      });\n    },\n    onError: (error) => {\n      toast({\n        title: \"Ошибка обновления статуса\",\n        description: error instanceof Error ? error.message : \"Произошла ошибка\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const returnToInventoryMutation = useMutation({\n    mutationFn: async (movementId: number) => {\n      console.log(\"Calling return API for movement:\", movementId);\n      const response = await apiRequest(\"POST\", `/api/movements/${movementId}/return`, {});\n      console.log(\"Return API response received\");\n      return response.json();\n    },\n    onSuccess: () => {\n      console.log(\"Return mutation SUCCESS\");\n      queryClient.invalidateQueries({ queryKey: [\"/api/movements\"] });\n      toast({\n        title: \"Товар возвращен\",\n        description: \"Товар возвращен на склад\",\n      });\n    },\n    onError: (error) => {\n      console.log(\"Return mutation ERROR:\", error);\n      const message = error instanceof Error ? error.message : \"Произошла ошибка\";\n      toast({\n        title: \"Ошибка возврата товара\",\n        description: message,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  // Filter movements by status\n  const awaitingShipment = movements.filter(m => \n    m.reason === \"sale\" && m.saleStatus === \"awaiting_shipment\"\n  );\n  const shipped = movements.filter(m => \n    m.reason === \"sale\" && m.saleStatus === \"shipped\"\n  );\n\n  const formatPrice = (price: string | null) => {\n    if (!price) return \"—\";\n    return new Intl.NumberFormat('ru-RU', {\n      style: 'currency',\n      currency: 'RUB',\n    }).format(parseFloat(price));\n  };\n\n  const formatDate = (dateString: Date | string) => {\n    return new Date(dateString).toLocaleString('ru-RU', {\n      year: 'numeric',\n      month: '2-digit',\n      day: '2-digit',\n      hour: '2-digit',\n      minute: '2-digit',\n    });\n  };\n\n  return (\n    <div className=\"flex-1 overflow-y-auto\">\n      <header className=\"bg-card border-b border-border sticky top-0 z-10\">\n        <div className=\"px-8 py-4\">\n          <h2 className=\"text-2xl font-bold text-foreground\">Проданные товары</h2>\n          <p className=\"text-sm text-muted-foreground mt-1\">\n            Управление отправкой и возвратом проданных товаров\n          </p>\n        </div>\n      </header>\n\n      <div className=\"p-8\">\n        <div className=\"grid grid-cols-1 xl:grid-cols-2 gap-6\">\n          {/* Awaiting Shipment */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center justify-between\">\n                <div>\n                  <div className=\"text-lg font-semibold text-foreground\">Ожидает отправки</div>\n                  <CardDescription>\n                    Товары готовы к отправке покупателю\n                  </CardDescription>\n                </div>\n                <Badge variant=\"secondary\" className=\"text-sm\">\n                  {awaitingShipment.length}\n                </Badge>\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              {isLoading ? (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <div className=\"w-8 h-8 border-2 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4\"></div>\n                  <p>Загрузка...</p>\n                </div>\n              ) : awaitingShipment.length === 0 ? (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <i className=\"fas fa-box-open text-4xl mb-4\"></i>\n                  <p>Нет товаров ожидающих отправки</p>\n                </div>\n              ) : (\n                <div className=\"space-y-4\">\n                  {awaitingShipment.map((movement) => (\n                    <div\n                      key={movement.id}\n                      className=\"border border-border rounded-lg p-4 bg-card hover:bg-accent/5 transition-colors\"\n                      data-testid={`item-awaiting-${movement.id}`}\n                    >\n                      <div className=\"flex items-start justify-between mb-3\">\n                        <div className=\"flex-1\">\n                          <div className=\"font-mono font-semibold text-sm text-foreground mb-1\">\n                            {movement.smart}\n                          </div>\n                          <div className=\"text-xs text-muted-foreground break-words\">\n                            {movement.article}\n                          </div>\n                        </div>\n                        <Badge variant=\"outline\" className=\"ml-2\">\n                          <i className=\"fas fa-clock mr-1\"></i>\n                          Ожидает\n                        </Badge>\n                      </div>\n                      \n                      <div className=\"grid grid-cols-2 gap-2 text-sm mb-3\">\n                        <div>\n                          <span className=\"text-muted-foreground\">Количество:</span>\n                          <span className=\"font-mono font-semibold ml-2\">\n                            {Math.abs(movement.qtyDelta)}\n                          </span>\n                        </div>\n                        <div>\n                          <span className=\"text-muted-foreground\">Цена продажи:</span>\n                          <span className=\"font-semibold ml-2\">\n                            {formatPrice(movement.salePrice)}\n                          </span>\n                        </div>\n                        <div>\n                          <span className=\"text-muted-foreground\">Доставка:</span>\n                          <span className=\"font-semibold ml-2\">\n                            {formatPrice(movement.deliveryPrice)}\n                          </span>\n                        </div>\n                        <div>\n                          <span className=\"text-muted-foreground\">Дата:</span>\n                          <span className=\"text-xs ml-2\">\n                            {formatDate(movement.createdAt)}\n                          </span>\n                        </div>\n                      </div>\n\n                      {movement.trackNumber && (\n                        <div className=\"text-xs text-muted-foreground mb-3\">\n                          <i className=\"fas fa-truck mr-1\"></i>\n                          Трек: {movement.trackNumber}\n                        </div>\n                      )}\n\n                      <Button\n                        size=\"sm\"\n                        className=\"w-full\"\n                        onClick={() => markAsShippedMutation.mutate(movement.id)}\n                        disabled={markAsShippedMutation.isPending}\n                        data-testid={`button-ship-${movement.id}`}\n                      >\n                        <i className=\"fas fa-shipping-fast mr-2\"></i>\n                        Отправлено\n                      </Button>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n\n          {/* Shipped */}\n          <Card>\n            <CardHeader>\n              <CardTitle className=\"flex items-center justify-between\">\n                <div>\n                  <div className=\"text-lg font-semibold text-foreground\">Отправлено</div>\n                  <CardDescription>\n                    Товары отправленные покупателю\n                  </CardDescription>\n                </div>\n                <Badge variant=\"secondary\" className=\"text-sm\">\n                  {shipped.length}\n                </Badge>\n              </CardTitle>\n            </CardHeader>\n            <CardContent>\n              {isLoading ? (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <div className=\"w-8 h-8 border-2 border-primary border-t-transparent rounded-full animate-spin mx-auto mb-4\"></div>\n                  <p>Загрузка...</p>\n                </div>\n              ) : shipped.length === 0 ? (\n                <div className=\"text-center py-8 text-muted-foreground\">\n                  <i className=\"fas fa-shipping-fast text-4xl mb-4\"></i>\n                  <p>Нет отправленных товаров</p>\n                </div>\n              ) : (\n                <div className=\"space-y-4\">\n                  {shipped.map((movement) => (\n                    <div\n                      key={movement.id}\n                      className=\"border border-success/30 rounded-lg p-4 bg-success/5\"\n                      data-testid={`item-shipped-${movement.id}`}\n                    >\n                      <div className=\"flex items-start justify-between mb-3\">\n                        <div className=\"flex-1\">\n                          <div className=\"font-mono font-semibold text-sm text-foreground mb-1\">\n                            {movement.smart}\n                          </div>\n                          <div className=\"text-xs text-muted-foreground break-words\">\n                            {movement.article}\n                          </div>\n                        </div>\n                        <Badge className=\"bg-success text-success-foreground ml-2\">\n                          <i className=\"fas fa-check mr-1\"></i>\n                          Отправлено\n                        </Badge>\n                      </div>\n                      \n                      <div className=\"grid grid-cols-2 gap-2 text-sm mb-3\">\n                        <div>\n                          <span className=\"text-muted-foreground\">Количество:</span>\n                          <span className=\"font-mono font-semibold ml-2\">\n                            {Math.abs(movement.qtyDelta)}\n                          </span>\n                        </div>\n                        <div>\n                          <span className=\"text-muted-foreground\">Цена продажи:</span>\n                          <span className=\"font-semibold ml-2\">\n                            {formatPrice(movement.salePrice)}\n                          </span>\n                        </div>\n                        <div>\n                          <span className=\"text-muted-foreground\">Доставка:</span>\n                          <span className=\"font-semibold ml-2\">\n                            {formatPrice(movement.deliveryPrice)}\n                          </span>\n                        </div>\n                        <div>\n                          <span className=\"text-muted-foreground\">Дата отправки:</span>\n                          <span className=\"text-xs ml-2\">\n                            {formatDate(movement.createdAt)}\n                          </span>\n                        </div>\n                      </div>\n\n                      {movement.trackNumber && (\n                        <div className=\"text-xs text-muted-foreground mb-3\">\n                          <i className=\"fas fa-truck mr-1\"></i>\n                          Трек: {movement.trackNumber}\n                        </div>\n                      )}\n\n                      <Button\n                        size=\"sm\"\n                        variant=\"outline\"\n                        className=\"w-full\"\n                        onClick={() => returnToInventoryMutation.mutate(movement.id)}\n                        disabled={returnToInventoryMutation.isPending}\n                        data-testid={`button-return-${movement.id}`}\n                      >\n                        <i className=\"fas fa-undo mr-2\"></i>\n                        Вернуть на склад\n                      </Button>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    </div>\n  );\n}\n","size_bytes":13114},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","size_bytes":1584},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","size_bytes":329},"server/vite.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport async function setupVite(app: Express, server: Server) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server },\n    allowedHosts: true as const,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(import.meta.dirname, \"public\");\n\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","size_bytes":2263},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","size_bytes":8605},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","size_bytes":4420},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","size_bytes":166},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","size_bytes":710},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","size_bytes":1280},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","size_bytes":1467},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","size_bytes":1419},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","size_bytes":4845},"client/src/lib/normalization.ts":{"content":"/**\n * Normalizes article codes for fuzzy matching\n * 1. Convert to uppercase\n * 2. Remove delimiters (space, -, _, ., /)\n * 3. Replace Cyrillic characters with Latin equivalents\n */\nexport function normalizeArticle(article: string): string {\n  if (!article) return '';\n  \n  // Step 1: Convert to uppercase\n  let normalized = article.toUpperCase();\n  \n  // Step 2: Remove delimiters\n  normalized = normalized.replace(/[\\s\\-_./]/g, '');\n  \n  // Step 3: Replace Cyrillic with Latin\n  const cyrillicToLatin: { [key: string]: string } = {\n    'А': 'A',\n    'В': 'B',\n    'Е': 'E',\n    'К': 'K',\n    'М': 'M',\n    'Н': 'H',\n    'О': 'O',\n    'Р': 'P',\n    'С': 'C',\n    'Т': 'T',\n    'У': 'Y',\n    'Х': 'X',\n    'Ё': 'E',\n  };\n  \n  normalized = normalized.replace(/[АВЕКМНОРСТУХЁ]/g, (char) => {\n    return cyrillicToLatin[char] || char;\n  });\n  \n  return normalized;\n}\n\n/**\n * Checks if two articles match after normalization\n */\nexport function articlesMatch(article1: string, article2: string): boolean {\n  return normalizeArticle(article1) === normalizeArticle(article2);\n}\n","size_bytes":1099},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","size_bytes":2695},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","size_bytes":157},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","size_bytes":1883},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","size_bytes":2712},"design_guidelines.md":{"content":"# Design Guidelines: SMART Code Inventory Detail Page\n\n## Design Approach\n\n**Selected System:** Linear + Notion hybrid approach\n- Linear's dark mode aesthetic and minimalist data presentation\n- Notion's inline editing patterns and table interactions\n- Focus on functional clarity over decorative elements\n\n**Core Principles:**\n1. Data hierarchy through typography, not color\n2. Streamlined editing workflows\n3. Scannable information architecture\n4. Keyboard-friendly interactions\n\n## Typography System\n\n**Font Family:** Inter (via Google Fonts CDN)\n- Primary: Inter for all UI text\n- Monospace: JetBrains Mono for SMART codes and numerical data\n\n**Type Scale:**\n- Page Title: text-2xl font-semibold (SMART код детализация)\n- Section Headers: text-lg font-medium\n- Table Headers: text-sm font-medium uppercase tracking-wide\n- Body/Data: text-sm font-normal\n- Secondary Info: text-xs text-gray-400\n- SMART Code Display: text-3xl font-mono font-bold\n\n## Layout Structure\n\n**Spacing System:** Use Tailwind units: 2, 3, 4, 6, 8, 12, 16\n- Page padding: p-8\n- Section spacing: space-y-6\n- Card padding: p-6\n- Table cell padding: px-4 py-3\n- Inline gaps: gap-3\n\n**Page Layout:**\n```\n[Header Bar - Full Width]\n- Breadcrumb navigation (Главная > Инвентарь > [SMART Code])\n- Action buttons aligned right\n\n[Main Content - max-w-7xl mx-auto]\n├─ [SMART Code Info Card]\n│  ├─ Large SMART code display (monospace, prominent)\n│  ├─ Metadata grid: 3-column (Item Name, Category, Status)\n│  └─ Quick stats: 4-column (Total Purchases, Avg Price, etc.)\n│\n└─ [Purchase History Section]\n   ├─ Section header with filter/search\n   └─ Editable data table\n```\n\n## Component Specifications\n\n### SMART Code Header Card\n- Background: bg-gray-900 (slightly lighter than page bg-gray-950)\n- Border: border border-gray-800\n- Rounded: rounded-lg\n- Layout: Vertical stack with horizontal metadata grid\n- SMART Code: Displayed prominently at top with copy button icon\n- Metadata Grid: 3 columns on desktop (grid-cols-3), stack on mobile\n- Quick Stats: 4 mini cards in grid-cols-4, each with label + large number\n\n### Purchase History Table\n**Table Container:**\n- Background: bg-gray-900\n- Border: border border-gray-800\n- Rounded: rounded-lg\n- Overflow: overflow-x-auto for horizontal scroll on mobile\n\n**Table Structure:**\n- Header: bg-gray-800 with sticky positioning\n- Rows: hover:bg-gray-800/50 transition\n- Borders: border-b border-gray-800 between rows\n- Columns: Date | Supplier | Quantity | Purchase Price (Editable) | Comments (Editable) | Total | Actions\n\n**Inline Editing Pattern:**\n- Default State: Text displays normally, subtle edit icon appears on row hover\n- Edit Mode: Click cell to activate inline contentEditable field\n- Active Field: bg-gray-800 border-2 border-blue-500 rounded px-2\n- Save/Cancel: Auto-save on blur + explicit save/cancel buttons in cell\n- Validation: Red border (border-red-500) for invalid inputs\n\n### Interactive Elements\n\n**Buttons:**\n- Primary: bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md\n- Secondary: bg-gray-800 hover:bg-gray-700 border border-gray-700\n- Ghost: hover:bg-gray-800 text-gray-300\n- Icon buttons: p-2 rounded-md hover:bg-gray-800\n\n**Input Fields (for inline editing):**\n- Background: bg-gray-800\n- Border: border border-gray-700 focus:border-blue-500\n- Text: text-white placeholder:text-gray-500\n- Rounded: rounded-md\n- Padding: px-3 py-2\n\n**Badges (for status indicators):**\n- Small rounded pills (rounded-full px-2.5 py-0.5 text-xs)\n- Use opacity variations of gray for different states\n\n## Data Table Design\n\n**Column Widths:**\n- Date: 120px (fixed)\n- Supplier: minmax(150px, 1fr)\n- Quantity: 100px (fixed, right-aligned)\n- Purchase Price: 150px (editable, right-aligned, monospace)\n- Comments: minmax(200px, 2fr) (editable)\n- Total: 120px (fixed, right-aligned, monospace, bold)\n- Actions: 80px (fixed)\n\n**Table Features:**\n- Sortable columns (icon in header)\n- Row selection checkboxes\n- Bulk action toolbar appears when rows selected\n- Pagination footer: Showing 1-20 of 150 entries\n- Rows per page selector\n\n## Visual Hierarchy\n\n**Card Elevation System:**\n- Page background: bg-gray-950\n- Primary cards: bg-gray-900 with border-gray-800\n- Nested elements: bg-gray-800\n- Active/Focus states: bg-gray-800 + blue accent\n\n**Text Hierarchy:**\n- Primary text: text-white\n- Secondary text: text-gray-300\n- Tertiary/metadata: text-gray-400\n- Disabled: text-gray-600\n- Links: text-blue-400 hover:text-blue-300\n\n## Additional Features\n\n**Top Action Bar:**\n- Right-aligned buttons: Export, Add Purchase, Settings\n- Search/Filter dropdown for table (left side)\n- All use secondary button style\n\n**Empty State (if no purchases):**\n- Centered icon + text: \"Нет записей о покупках\"\n- CTA button: \"Добавить первую покупку\"\n\n**Loading States:**\n- Skeleton loaders matching table structure\n- Shimmer effect on gray-800 background\n\n**Accessibility:**\n- All form inputs have visible labels (even if visually hidden)\n- Proper ARIA labels for icon-only buttons\n- Focus indicators: ring-2 ring-blue-500 ring-offset-2 ring-offset-gray-950\n- Keyboard navigation for table (Tab, Enter to edit, Esc to cancel)\n\n## Russian Language Specifics\n\n**Typography Adjustments:**\n- Ensure Inter properly renders Cyrillic characters\n- Slightly increased line-height: leading-relaxed for readability\n- Date format: DD.MM.YYYY (Russian standard)\n- Number format: Space as thousands separator (1 000 000,00)\n\n**UI Labels (Examples):**\n- Дата покупки, Поставщик, Количество, Цена закупа, Комментарии\n- Сохранить, Отменить, Редактировать, Удалить\n- Всего записей, Показано\n\nThis design creates a professional, efficient dark-mode admin interface optimized for data entry and review workflows.","size_bytes":5911},"client/src/pages/stock-details.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation } from \"@tanstack/react-query\";\nimport { useParams, Link } from \"wouter\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Input } from \"@/components/ui/input\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport type { Movement } from \"@shared/schema\";\nimport { format } from \"date-fns\";\n\nexport default function StockDetails() {\n  const { smart } = useParams();\n  const { toast } = useToast();\n  const [editingCell, setEditingCell] = useState<{id: number, field: 'purchasePrice' | 'note'} | null>(null);\n  const [editValue, setEditValue] = useState<string>(\"\");\n\n  const { data: purchasesData, isLoading } = useQuery<Movement[]>({\n    queryKey: [`/api/stock/${smart}/purchases`],\n    enabled: !!smart,\n  });\n\n  // Ensure purchases is always an array\n  const purchases = Array.isArray(purchasesData) ? purchasesData : [];\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, field, value }: { id: number; field: 'purchasePrice' | 'note'; value: string | null }) => {\n      return await apiRequest('PATCH', `/api/movements/${id}`, {\n        [field]: value,\n      });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/stock/${smart}/purchases`] });\n      toast({\n        title: \"Сохранено\",\n        description: \"Изменения успешно сохранены\",\n      });\n      setEditingCell(null);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Ошибка\",\n        description: error.message || \"Не удалось сохранить изменения\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleEditStart = (id: number, field: 'purchasePrice' | 'note', currentValue: string | null) => {\n    setEditingCell({ id, field });\n    setEditValue(currentValue || \"\");\n  };\n\n  const handleEditCancel = () => {\n    setEditingCell(null);\n    setEditValue(\"\");\n  };\n\n  const handleEditSave = () => {\n    if (editingCell) {\n      updateMutation.mutate({\n        id: editingCell.id,\n        field: editingCell.field,\n        value: editValue || null,\n      });\n    }\n  };\n\n  const getTotalPrice = (purchase: Movement) => {\n    if (!purchase.purchasePrice) return null;\n    const price = parseFloat(purchase.purchasePrice);\n    const qty = Math.abs(purchase.qtyDelta);\n    return (price * qty).toFixed(2);\n  };\n\n  if (!smart) {\n    return (\n      <div className=\"flex-1 flex items-center justify-center\">\n        <p className=\"text-muted-foreground\">SMART код не указан</p>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"flex-1 overflow-y-auto bg-gray-950\">\n      <header className=\"bg-card border-b border-border sticky top-0 z-10\">\n        <div className=\"px-8 py-4\">\n          <div className=\"flex items-center gap-2 text-sm text-muted-foreground mb-2\">\n            <Link href=\"/\" className=\"hover:text-foreground transition-colors\">\n              Главная\n            </Link>\n            <span>/</span>\n            <Link href=\"/stock\" className=\"hover:text-foreground transition-colors\">\n              Остатки\n            </Link>\n            <span>/</span>\n            <span className=\"text-foreground\">{smart}</span>\n          </div>\n          <h2 className=\"text-2xl font-bold text-foreground\">Детали по SMART коду</h2>\n          <p className=\"text-sm text-muted-foreground mt-1\">Просмотр и редактирование покупок</p>\n        </div>\n      </header>\n\n      <div className=\"p-8 max-w-7xl mx-auto\">\n        <Card className=\"bg-gray-900 border-gray-800 mb-6\">\n          <CardHeader>\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <p className=\"text-xs text-gray-400 mb-1\">SMART КОД</p>\n                <h3 className=\"text-3xl font-mono font-bold text-white\">{smart}</h3>\n              </div>\n              <Button\n                variant=\"ghost\"\n                size=\"icon\"\n                onClick={() => {\n                  navigator.clipboard.writeText(smart);\n                  toast({\n                    title: \"Скопировано\",\n                    description: \"SMART код скопирован в буфер обмена\",\n                  });\n                }}\n                data-testid=\"button-copy-smart\"\n              >\n                <i className=\"fas fa-copy\"></i>\n              </Button>\n            </div>\n          </CardHeader>\n          {purchases && purchases.length > 0 && (\n            <CardContent>\n              <div className=\"grid grid-cols-4 gap-4\">\n                <div>\n                  <p className=\"text-xs text-gray-400 mb-1\">Всего покупок</p>\n                  <p className=\"text-2xl font-semibold text-white\">{purchases.length}</p>\n                </div>\n                <div>\n                  <p className=\"text-xs text-gray-400 mb-1\">Общее количество</p>\n                  <p className=\"text-2xl font-semibold text-white\">\n                    {purchases.reduce((sum, p) => sum + Math.abs(p.qtyDelta), 0)}\n                  </p>\n                </div>\n                <div>\n                  <p className=\"text-xs text-gray-400 mb-1\">Средняя цена</p>\n                  <p className=\"text-2xl font-semibold text-white\">\n                    {purchases.filter(p => p.purchasePrice).length > 0\n                      ? (purchases\n                          .filter(p => p.purchasePrice)\n                          .reduce((sum, p) => sum + parseFloat(p.purchasePrice!), 0) /\n                          purchases.filter(p => p.purchasePrice).length).toFixed(2)\n                      : \"—\"} ₽\n                  </p>\n                </div>\n                <div>\n                  <p className=\"text-xs text-gray-400 mb-1\">Всего затрат</p>\n                  <p className=\"text-2xl font-semibold text-white\">\n                    {purchases\n                      .filter(p => p.purchasePrice)\n                      .reduce((sum, p) => {\n                        const price = parseFloat(p.purchasePrice!);\n                        const qty = Math.abs(p.qtyDelta);\n                        return sum + (price * qty);\n                      }, 0)\n                      .toFixed(2)} ₽\n                  </p>\n                </div>\n              </div>\n            </CardContent>\n          )}\n        </Card>\n\n        <Card className=\"bg-gray-900 border-gray-800\">\n          <CardHeader>\n            <CardTitle>История покупок</CardTitle>\n          </CardHeader>\n          <CardContent>\n            {isLoading ? (\n              <div className=\"space-y-3\">\n                {[1, 2, 3, 4].map((i) => (\n                  <Skeleton key={i} className=\"h-12 w-full bg-gray-800\" />\n                ))}\n              </div>\n            ) : !purchases || purchases.length === 0 ? (\n              <div className=\"text-center py-12\">\n                <div className=\"inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-800 mb-4\">\n                  <i className=\"fas fa-box-open text-2xl text-gray-500\"></i>\n                </div>\n                <p className=\"text-gray-400 mb-4\">Нет записей о покупках</p>\n                <Link href=\"/movement\">\n                  <Button data-testid=\"button-add-first-purchase\">\n                    <i className=\"fas fa-plus mr-2\"></i>\n                    Добавить первую покупку\n                  </Button>\n                </Link>\n              </div>\n            ) : (\n              <div className=\"overflow-x-auto\">\n                <Table>\n                  <TableHeader className=\"bg-gray-800\">\n                    <TableRow>\n                      <TableHead className=\"w-[120px]\">Дата</TableHead>\n                      <TableHead className=\"w-[180px]\">Артикул</TableHead>\n                      <TableHead className=\"text-right w-[100px]\">Кол-во</TableHead>\n                      <TableHead className=\"text-right w-[150px]\">Цена закупа</TableHead>\n                      <TableHead className=\"min-w-[200px]\">Комментарий</TableHead>\n                      <TableHead className=\"w-[100px]\">Номер коробки</TableHead>\n                      <TableHead className=\"text-right w-[120px]\">Итого</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {purchases.map((purchase) => (\n                      <TableRow \n                        key={purchase.id} \n                        className=\"hover:bg-gray-800/50 transition-colors border-b border-gray-800\"\n                        data-testid={`row-purchase-${purchase.id}`}\n                      >\n                        <TableCell className=\"font-mono text-sm\">\n                          {format(new Date(purchase.createdAt), \"dd.MM.yyyy\")}\n                        </TableCell>\n                        <TableCell className=\"font-mono\">{purchase.article}</TableCell>\n                        <TableCell className=\"text-right font-mono font-semibold\">\n                          {Math.abs(purchase.qtyDelta)}\n                        </TableCell>\n                        <TableCell className=\"text-right\">\n                          {editingCell?.id === purchase.id && editingCell.field === 'purchasePrice' ? (\n                            <div className=\"flex items-center gap-2\">\n                              <Input\n                                type=\"number\"\n                                step=\"0.01\"\n                                value={editValue}\n                                onChange={(e) => setEditValue(e.target.value)}\n                                className=\"bg-gray-800 border-2 border-blue-500 font-mono text-right\"\n                                autoFocus\n                                onKeyDown={(e) => {\n                                  if (e.key === 'Enter') handleEditSave();\n                                  if (e.key === 'Escape') handleEditCancel();\n                                }}\n                                data-testid={`input-edit-price-${purchase.id}`}\n                              />\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                onClick={handleEditSave}\n                                disabled={updateMutation.isPending}\n                                data-testid={`button-save-price-${purchase.id}`}\n                              >\n                                <i className=\"fas fa-check text-green-500\"></i>\n                              </Button>\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                onClick={handleEditCancel}\n                                disabled={updateMutation.isPending}\n                                data-testid={`button-cancel-price-${purchase.id}`}\n                              >\n                                <i className=\"fas fa-times text-red-500\"></i>\n                              </Button>\n                            </div>\n                          ) : (\n                            <button\n                              onClick={() => handleEditStart(purchase.id, 'purchasePrice', purchase.purchasePrice)}\n                              className=\"w-full text-right font-mono hover:bg-gray-800 px-2 py-1 rounded transition-colors group\"\n                              data-testid={`button-edit-price-${purchase.id}`}\n                            >\n                              <span>{purchase.purchasePrice ? `${purchase.purchasePrice} ₽` : \"—\"}</span>\n                              <i className=\"fas fa-edit text-xs ml-2 opacity-0 group-hover:opacity-50 transition-opacity\"></i>\n                            </button>\n                          )}\n                        </TableCell>\n                        <TableCell>\n                          {editingCell?.id === purchase.id && editingCell.field === 'note' ? (\n                            <div className=\"flex items-center gap-2\">\n                              <Input\n                                type=\"text\"\n                                value={editValue}\n                                onChange={(e) => setEditValue(e.target.value)}\n                                className=\"bg-gray-800 border-2 border-blue-500\"\n                                autoFocus\n                                onKeyDown={(e) => {\n                                  if (e.key === 'Enter') handleEditSave();\n                                  if (e.key === 'Escape') handleEditCancel();\n                                }}\n                                data-testid={`input-edit-note-${purchase.id}`}\n                              />\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                onClick={handleEditSave}\n                                disabled={updateMutation.isPending}\n                                data-testid={`button-save-note-${purchase.id}`}\n                              >\n                                <i className=\"fas fa-check text-green-500\"></i>\n                              </Button>\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                onClick={handleEditCancel}\n                                disabled={updateMutation.isPending}\n                                data-testid={`button-cancel-note-${purchase.id}`}\n                              >\n                                <i className=\"fas fa-times text-red-500\"></i>\n                              </Button>\n                            </div>\n                          ) : (\n                            <button\n                              onClick={() => handleEditStart(purchase.id, 'note', purchase.note)}\n                              className=\"w-full text-left hover:bg-gray-800 px-2 py-1 rounded transition-colors group\"\n                              data-testid={`button-edit-note-${purchase.id}`}\n                            >\n                              <span className=\"text-gray-300\">{purchase.note || \"—\"}</span>\n                              <i className=\"fas fa-edit text-xs ml-2 opacity-0 group-hover:opacity-50 transition-opacity\"></i>\n                            </button>\n                          )}\n                        </TableCell>\n                        <TableCell>\n                          <Badge variant=\"outline\" className=\"font-mono\">\n                            {purchase.boxNumber || \"—\"}\n                          </Badge>\n                        </TableCell>\n                        <TableCell className=\"text-right font-mono font-bold\">\n                          {getTotalPrice(purchase) ? `${getTotalPrice(purchase)} ₽` : \"—\"}\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n                \n                <div className=\"mt-4 text-sm text-gray-400\">\n                  Показано {purchases.length} {purchases.length === 1 ? 'запись' : purchases.length < 5 ? 'записи' : 'записей'}\n                </div>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","size_bytes":15853}},"version":2}