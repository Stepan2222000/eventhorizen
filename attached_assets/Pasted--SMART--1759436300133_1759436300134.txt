нутренняя система учёта остатков по обычным артикулам с привязкой к справочнику SMART. Пользователь вводит любой вариант артикула (разный регистр, разделители, кир/лат «похожие» буквы) → система находит SMART и позволяет прибавлять/убавлять количество. Вся история движений сохраняется.
Данные
Справочник (RO): parts_admin :5403 → public.smart
smart (PK), артикул (массив обычных артикулов), доп. поля (наименование, бренд).
Только читаем для сопоставления.
Учёт (RW): ebay_admin :5405 → схема inventory
inventory.reasons(code PK, title) — фиксированный список причин (purchase,sale,return,adjust,writeoff).
inventory.movements(id, smart, article, qty_delta, reason, note, created_at) — история.
inventory.stock (VIEW) — сумма qty_delta по (article, smart) = текущий остаток.
В ebay_admin храним только учёт (справочник не трогаем).
Подключение к БД
Два соединения:
RO → parts_admin (поиск SMART).
RW → ebay_admin (запись движений/чтение остатков).
DSN-формат:
postgresql://<логин>:Password123@<хост>:5403/parts_admin
postgresql://<логин>:Password123@<хост>:5405/ebay_admin
Опционально допустим postgres_fdw (читать parts_admin.public.smart из ebay_admin).
Сопоставление артикула (поиск)
Нормализация только для сравнения, в БД не пишется:
верхний регистр; 2) убрать разделители (пробел, - _ . /); 3) заменить похожие кир→лат: АВЕКМНОРСТУХЁ → ABEKMHOPCTYXE.
Сравнение: нормализованный ввод ↔ нормализованные элементы артикул[] из public.smart.
Результат:
0 совпадений — операция запрещена;
1 совпадение — SMART однозначен;
≥2 — пользователь выбирает SMART.
В учёт сохраняем article ровно как ввёл пользователь (нормализация не сохраняется).
Движения
Разрешены только для существующих в smart артикулов. Записываем в inventory.movements:
smart, article (как введён), qty_delta (±), reason (из справочника), note, created_at.
История не редактируется; исправления — обратным движением (напр. adjust -2).
Остаток = сумма qty_delta по (article, smart) → inventory.stock.
Пользовательский поток
Ввести артикул → поиск с нормализацией.
Если несколько SMART — выбрать.
Указать +/- количество, причину, опц. комментарий → запись движения.
Смотреть текущий остаток и историю по (article, smart).
Массовый импорт
Файл Excel/CSV: колонки article, qty_delta, reason, note, [smart].
Для каждой строки — то же сопоставление; при неоднозначности без smart строка в ошибки; при успехе — запись в movements. Итог: счётчик добавленных и список ошибок.
Ограничения и валидации
Только артикула, найденные в smart.
При множественных совпадениях — обязательный выбор smart.
Причины — из фиксированного списка.
Доступ — без авторизации (внутренняя сеть).
Нормализация — только для поиска; в БД — исходный ввод.
Примечания по БД
В ebay_admin автоматически создаются: схема inventory, таблицы reasons, movements, VIEW stock.
postgres_fdw — разрешён, но не обязателен.
Для ускорения поиска в public.smart допустим индекс по массиву артикул[].
Итог: корректное сопоставление любого написания артикула с реальным SMART, учёт по артикулу с фиксированными причинами, неизменяемая история, остатки как сумма движений, массовый импорт с проверками — всё с хранением учёта в ebay_admin.